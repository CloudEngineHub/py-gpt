/* app.min.js — generated on 2025-09-22 22:18:13 by bin/minify_js.py using rjsmin */

/* data/js/app/async.js */
class AsyncRunner{constructor(cfg,raf){this.cfg=cfg||{};this.raf=raf||null;const A=this.cfg.ASYNC||{};this.SLICE_MS=Utils.g('ASYNC_SLICE_MS',A.SLICE_MS??12);this.SLICE_HIDDEN_MS=Utils.g('ASYNC_SLICE_HIDDEN_MS',A.SLICE_HIDDEN_MS??Math.min(this.SLICE_MS,6));this.MIN_YIELD_MS=Utils.g('ASYNC_MIN_YIELD_MS',A.MIN_YIELD_MS??0);this._opGen=new Map();}
shouldYield(startTs){try{const s=navigator&&navigator.scheduling;if(s&&s.isInputPending&&s.isInputPending({includeContinuous:true}))return true;}catch(_){}
const now=Utils.now();const hidden=(typeof document!=='undefined'&&document.visibilityState==='hidden');const budget=hidden?this.SLICE_HIDDEN_MS:this.SLICE_MS;return(now-startTs)>=budget;}
async yield(){if(this.raf&&typeof this.raf.nextFrame==='function'){await this.raf.nextFrame();return;}
if(typeof requestAnimationFrame==='function'){await new Promise(res=>{try{requestAnimationFrame(()=>res());}
catch(_){setTimeout(res,16);}});return;}
await new Promise(res=>setTimeout(res,16));}
async yieldIdle(timeoutMs=100){if(typeof requestIdleCallback==='function'){await new Promise(res=>{try{requestIdleCallback(()=>res(),{timeout:timeoutMs});}
catch(_){res();}});return;}
await this.yield();}
_beginOp(label){if(!label)return 0;const g=(this._opGen.get(label)||0)+1;this._opGen.set(label,g);return g;}
_isLatest(label,gen){if(!label)return true;return(this._opGen.get(label)===gen);}
cancel(label){if(!label)return;const g=(this._opGen.get(label)||0)+1;this._opGen.set(label,g);}
async forEachChunk(arr,fn,labelOrOpts){if(!arr||!arr.length)return;let label=(typeof labelOrOpts==='string')?labelOrOpts:(labelOrOpts&&labelOrOpts.label)||undefined;const opts=(label&&typeof labelOrOpts==='object')?{...labelOrOpts,label}:(typeof labelOrOpts==='object'?labelOrOpts:{});const batch=Math.max(1,opts.batch|0||1);const release=!!opts.release;const signal=opts.signal;const onProgress=(typeof opts.onProgress==='function')?opts.onProgress:null;const gen=this._beginOp(label);const total=arr.length;let start=Utils.now();let processedInBatch=0;for(let i=0;i<total;i++){if((signal&&signal.aborted)||!this._isLatest(label,gen))break;await fn(arr[i],i);if(release){try{arr[i]=undefined;}catch(_){}}
processedInBatch++;if(onProgress){try{onProgress({index:i+1,total});}catch(_){}}
if(processedInBatch>=batch||this.shouldYield(start)){processedInBatch=0;await this.yield();start=Utils.now();}}}
async mapChunked(arr,mapper,labelOrOpts){if(!arr||!arr.length)return[];const out=new Array(arr.length);let idx=0;await this.forEachChunk(arr,async(v,i)=>{out[i]=await mapper(v,i);idx=i;},labelOrOpts);return out;}
async reduceChunked(arr,reducer,initial,labelOrOpts){let acc=initial;await this.forEachChunk(arr,async(v,i)=>{acc=await reducer(acc,v,i);},labelOrOpts);return acc;}};

/* data/js/app/bridge.js */
class BridgeManager{constructor(cfg,logger){this.cfg=cfg;this.logger=logger||new Logger(cfg);this.bridge=null;this.connected=false;}
log(text){try{if(this.bridge&&this.bridge.log)this.bridge.log(text);}catch(_){}}
connect(onChunk,onNode,onNodeReplace,onNodeInput){if(!this.bridge)return false;if(this.connected)return true;try{if(this.bridge.chunk)this.bridge.chunk.connect((name,chunk,type)=>onChunk(name,chunk,type));if(this.bridge.node)this.bridge.node.connect(onNode);if(this.bridge.nodeReplace)this.bridge.nodeReplace.connect(onNodeReplace);if(this.bridge.nodeInput)this.bridge.nodeInput.connect(onNodeInput);this.connected=true;return true;}catch(e){this.log(e);return false;}}
disconnect(){if(!this.bridge)return false;if(!this.connected)return true;try{if(this.bridge.chunk)this.bridge.chunk.disconnect();if(this.bridge.node)this.bridge.node.disconnect();if(this.bridge.nodeReplace)this.bridge.nodeReplace.disconnect();if(this.bridge.nodeInput)this.bridge.nodeInput.disconnect();}catch(_){}
this.connected=false;return true;}
initQWebChannel(pid,onReady){try{new QWebChannel(qt.webChannelTransport,(channel)=>{this.bridge=channel.objects.bridge;try{this.logger.bindBridge(this.bridge);}catch(_){}
onReady&&onReady(this.bridge);if(this.bridge&&this.bridge.js_ready)this.bridge.js_ready(pid);});}catch(e){}}
copyCode(text){if(this.bridge&&this.bridge.copy_text)this.bridge.copy_text(text);}
previewCode(text){if(this.bridge&&this.bridge.preview_text)this.bridge.preview_text(text);}
runCode(text){if(this.bridge&&this.bridge.run_text)this.bridge.run_text(text);}
updateScrollPosition(pos){if(this.bridge&&this.bridge.update_scroll_position)this.bridge.update_scroll_position(pos);}};

/* data/js/app/common.js */
class Loading{constructor(dom){this.dom=dom;}
show(){if(typeof window.hideTips==='function'){window.hideTips();}
const el=this.dom.get('_loader_');if(!el)return;if(el.classList.contains('hidden'))el.classList.remove('hidden');el.classList.add('visible');}
hide(){const el=this.dom.get('_loader_');if(!el)return;if(el.classList.contains('visible'))el.classList.remove('visible');el.classList.add('hidden');}}
class TipsManager{constructor(dom){this.dom=dom;this.hidden=false;this._timers=[];this._running=false;this._idx=0;}
_getList(){const upper=(typeof window!=='undefined')?window.TIPS:undefined;if(Array.isArray(upper)&&upper.length)return upper;const lower=(typeof window!=='undefined')?window.tips:undefined;if(Array.isArray(lower)&&lower.length)return lower;if(typeof lower==='string'&&lower.trim().length){try{const arr=JSON.parse(lower);if(Array.isArray(arr))return arr;}catch(_){}}
const host=this._host();if(host&&host.dataset&&typeof host.dataset.tips==='string'){try{const arr=JSON.parse(host.dataset.tips);if(Array.isArray(arr))return arr;}catch(_){}}
return[];}
_host(){return this.dom.get('tips')||document.getElementById('tips');}
_clearTimers(){for(const t of this._timers){try{clearTimeout(t);}catch(_){}}
this._timers.length=0;}
stopTimers(){this._clearTimers();this._running=false;}
_applyBaseStyle(el){if(!el)return;const z=(typeof window!=='undefined'&&typeof window.TIPS_ZINDEX!=='undefined')?String(window.TIPS_ZINDEX):'2147483000';el.style.zIndex=z;}
hide(){if(this.hidden)return;this.stopTimers();const el=this._host();if(el){el.classList.remove('visible');el.classList.remove('hidden');el.style.display='none';}
this.hidden=true;}
show(){const list=this._getList();if(!list.length)return;const el=this._host();if(!el)return;this.hidden=false;this._applyBaseStyle(el);el.classList.remove('hidden');el.style.display='block';}
_showOne(idx){const list=this._getList();if(!list.length)return;const el=this._host();if(!el||this.hidden)return;this._applyBaseStyle(el);el.innerHTML=list[idx%list.length];try{if(typeof runtime!=='undefined'&&runtime.raf&&typeof runtime.raf.schedule==='function'){const key={t:'Tips:show',el,i:Math.random()};runtime.raf.schedule(key,()=>{if(this.hidden||!el.isConnected)return;el.classList.add('visible');},'Tips',2);}else{el.classList.add('visible');}}catch(_){el.classList.add('visible');}}
_cycleLoop(){if(this.hidden)return;const el=this._host();if(!el)return;const VISIBLE_MS=(typeof window!=='undefined'&&window.TIPS_VISIBLE_MS)?window.TIPS_VISIBLE_MS:15000;const FADE_MS=(typeof window!=='undefined'&&window.TIPS_FADE_MS)?window.TIPS_FADE_MS:1000;this._showOne(this._idx);this._timers.push(setTimeout(()=>{if(this.hidden)return;el.classList.remove('visible');this._timers.push(setTimeout(()=>{if(this.hidden)return;const list=this._getList();if(!list.length)return;this._idx=(this._idx+1)%list.length;this._cycleLoop();},FADE_MS));},VISIBLE_MS));}
cycle(){const list=this._getList();if(!list.length||this._running)return;this._running=true;this._idx=0;this.show();const INIT_DELAY=(typeof window!=='undefined'&&window.TIPS_INIT_DELAY_MS)?window.TIPS_INIT_DELAY_MS:10000;this._timers.push(setTimeout(()=>{if(this.hidden)return;this._cycleLoop();},Math.max(0,INIT_DELAY)));}
cleanup(){this.stopTimers();const el=this._host();if(el)el.classList.remove('visible');}};

/* data/js/app/config.js */
class Config{constructor(){this.PID=Utils.g('PID',0);this.UI={AUTO_FOLLOW_REENABLE_PX:Utils.g('AUTO_FOLLOW_REENABLE_PX',8),SCROLL_NEAR_MARGIN_PX:Utils.g('SCROLL_NEAR_MARGIN_PX',450),INTERACTION_BUSY_MS:Utils.g('UI_INTERACTION_BUSY_MS',140),ZOOM_BUSY_MS:Utils.g('UI_ZOOM_BUSY_MS',300)};this.FAB={SHOW_DOWN_THRESHOLD_PX:Utils.g('SHOW_DOWN_THRESHOLD_PX',0),TOGGLE_DEBOUNCE_MS:Utils.g('FAB_TOGGLE_DEBOUNCE_MS',100)};this.HL={PER_FRAME:Utils.g('HL_PER_FRAME',2),DISABLE_ALL:Utils.g('DISABLE_SYNTAX_HIGHLIGHT',false)};this.OBSERVER={CODE_ROOT_MARGIN:Utils.g('CODE_ROOT_MARGIN','1000px 0px 1000px 0px'),BOX_ROOT_MARGIN:Utils.g('BOX_ROOT_MARGIN','1500px 0px 1500px 0px'),CODE_THRESHOLD:[0,0.001],BOX_THRESHOLD:0};this.SCAN={PRELOAD_PX:Utils.g('SCAN_PRELOAD_PX',1000)};this.CODE_SCROLL={AUTO_FOLLOW_REENABLE_PX:Utils.g('CODE_AUTO_FOLLOW_REENABLE_PX',8),NEAR_MARGIN_PX:Utils.g('CODE_SCROLL_NEAR_MARGIN_PX',48)};this.STREAM={MAX_PER_FRAME:Utils.g('STREAM_MAX_PER_FRAME',8),EMERGENCY_COALESCE_LEN:Utils.g('STREAM_EMERGENCY_COALESCE_LEN',300),COALESCE_MODE:Utils.g('STREAM_COALESCE_MODE','fixed'),SNAPSHOT_MAX_STEP:Utils.g('STREAM_SNAPSHOT_MAX_STEP',8000),QUEUE_MAX_ITEMS:Utils.g('STREAM_QUEUE_MAX_ITEMS',1200),PRESERVE_CODES_MAX:Utils.g('STREAM_PRESERVE_CODES_MAX',120),PLAIN_ACTIVATE_AFTER_LINES:Utils.g('STREAM_PLAIN_ACTIVATE_AFTER_LINES',80),};this.MATH={IDLE_TIMEOUT_MS:Utils.g('MATH_IDLE_TIMEOUT_MS',800),BATCH_HINT:Utils.g('MATH_BATCH_HINT',24)};this.ICONS={EXPAND:Utils.g('ICON_EXPAND',''),COLLAPSE:Utils.g('ICON_COLLAPSE',''),CODE_MENU:Utils.g('ICON_CODE_MENU',''),CODE_COPY:Utils.g('ICON_CODE_COPY',''),CODE_RUN:Utils.g('ICON_CODE_RUN',''),CODE_PREVIEW:Utils.g('ICON_CODE_PREVIEW','')};this.LOCALE={PREVIEW:Utils.g('LOCALE_PREVIEW','Preview'),RUN:Utils.g('LOCALE_RUN','Run'),COLLAPSE:Utils.g('LOCALE_COLLAPSE','Collapse'),EXPAND:Utils.g('LOCALE_EXPAND','Expand'),COPY:Utils.g('LOCALE_COPY','Copy'),COPIED:Utils.g('LOCALE_COPIED','Copied')};this.CODE_STYLE=Utils.g('CODE_SYNTAX_STYLE','default');this.PROFILE_TEXT={base:Utils.g('PROFILE_TEXT_BASE',4),growth:Utils.g('PROFILE_TEXT_GROWTH',1.28),minInterval:Utils.g('PROFILE_TEXT_MIN_INTERVAL',4),softLatency:Utils.g('PROFILE_TEXT_SOFT_LATENCY',60),adaptiveStep:Utils.g('PROFILE_TEXT_ADAPTIVE_STEP',false)};this.PROFILE_CODE={base:2048,growth:2.6,minInterval:500,softLatency:1200,minLinesForHL:Utils.g('PROFILE_CODE_HL_N_LINE',25),minCharsForHL:Utils.g('PROFILE_CODE_HL_N_CHARS',5000),promoteMinInterval:300,promoteMaxLatency:800,promoteMinLines:Utils.g('PROFILE_CODE_HL_N_LINE',25),adaptiveStep:Utils.g('PROFILE_CODE_ADAPTIVE_STEP',false),stopAfterLines:Utils.g('PROFILE_CODE_STOP_HL_AFTER_LINES',300),streamPlainAfterLines:0,streamPlainAfterChars:0,maxFrozenChars:32000,finalHighlightMaxLines:Utils.g('PROFILE_CODE_FINAL_HL_MAX_LINES',1500),finalHighlightMaxChars:Utils.g('PROFILE_CODE_FINAL_HL_MAX_CHARS',350000)};this.RESET={HEAVY_DEBOUNCE_MS:Utils.g('RESET_HEAVY_DEBOUNCE_MS',24)};this.LOG={MAX_QUEUE:Utils.g('LOG_MAX_QUEUE',400),MAX_BYTES:Utils.g('LOG_MAX_BYTES',256*1024),BATCH_MAX:Utils.g('LOG_BATCH_MAX',64),RATE_LIMIT_PER_SEC:Utils.g('LOG_RATE_LIMIT_PER_SEC',0)};this.ASYNC={SLICE_MS:Utils.g('ASYNC_SLICE_MS',12),MIN_YIELD_MS:Utils.g('ASYNC_MIN_YIELD_MS',0),MD_NODES_PER_SLICE:Utils.g('ASYNC_MD_NODES_PER_SLICE',12)};this.RAF={FLUSH_BUDGET_MS:Utils.g('RAF_FLUSH_BUDGET_MS',7),MAX_TASKS_PER_FLUSH:Utils.g('RAF_MAX_TASKS_PER_FLUSH',120)};this.MD={ALLOW_INDENTED_CODE:Utils.g('MD_ALLOW_INDENTED_CODE',false)};this.CUSTOM_MARKUP_RULES=Utils.g('CUSTOM_MARKUP_RULES',[{name:'cmd',open:'[!cmd]',close:'[/!cmd]',tag:'div',className:'cmd',innerMode:'text'},{name:'think_md',open:'[!think]',close:'[/!think]',tag:'think',className:'',innerMode:'text',nl2br:true,allowBr:true},{name:'think_html',open:'<think>',close:'</think>',tag:'think',className:'',innerMode:'text',stream:true,nl2br:true,allowBr:true},{name:'tool',open:'<tool>',close:'</tool>',tag:'div',className:'cmd',innerMode:'text',stream:true},{name:'exec_md',open:'[!exec]',close:'[/!exec]',innerMode:'text',stream:true,openReplace:'```python\n',closeReplace:'\n```',phase:'source'},{name:'exec_html',open:'<execute>',close:'</execute>',innerMode:'text',stream:true,openReplace:'```python\n',closeReplace:'\n```',phase:'source'}]);}};

/* data/js/app/custom.js */
class CustomMarkup{constructor(cfg,logger){this.cfg=cfg||{CUSTOM_MARKUP_RULES:[]};this.logger=logger||new Logger(cfg);this.__compiled=null;this.__streamRules=null;this.__streamWrapRules=null;this.__hasStreamRules=false;this.__openReAll=null;this.__openReStream=null;}
_d(tag,data){try{const lg=this.logger||(this.cfg&&this.cfg.logger)||(window.runtime&&runtime.logger)||null;if(!lg||typeof lg.debug!=='function')return;lg.debug_obj("CM",tag,data);}catch(_){}}
decodeEntitiesOnce(s){if(!s||!s.indexOf||s.indexOf('&')===-1)return String(s||'');const ta=CustomMarkup._decTA||(CustomMarkup._decTA=document.createElement('textarea'));ta.innerHTML=s;return ta.value;}
_escHtml(s){try{return Utils.escapeHtml(s);}catch(_){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}}
_escapeHtmlAllowBr(text,{convertNewlines=true}={}){const PLACEHOLDER='\u0001__BR__\u0001';let s=String(text||'');s=s.replace(/<br\s*\/?>/gi,PLACEHOLDER);s=this._escHtml(s);if(convertNewlines)s=s.replace(/\r\n|\r|\n/g,'<br>');s=s.replaceAll(PLACEHOLDER,'<br>');return s;}
hasAnyOpenToken(text,rules){if(!text||!rules||!rules.length)return false;if(rules===this.__compiled&&this.__openReAll){return this.__openReAll.test(text);}
if(rules===this.__streamRules&&this.__openReStream){return this.__openReStream.test(text);}
for(let i=0;i<rules.length;i++){const r=rules[i];if(!r||!r.open)continue;if(text.indexOf(r.open)!==-1)return true;}
return false;}
hasAnyStreamOpenToken(text){this.ensureCompiled();if(!this.__hasStreamRules)return false;const t=String(text||'');if(this.__openReStream)return this.__openReStream.test(t);const rules=this.__streamRules||[];return this.hasAnyOpenToken(t,rules);}
_materializeInnerHTML(rule,text,MD){let payload=String(text||'');const wantsBr=!!(rule&&(rule.nl2br||rule.allowBr));if(rule&&rule.decodeEntities&&payload&&payload.indexOf('&')!==-1){try{payload=this.decodeEntitiesOnce(payload);}catch(_){}}
if(wantsBr){try{return this._escapeHtmlAllowBr(payload,{convertNewlines:!!rule.nl2br});}catch(_){return this._escHtml(payload);}}
if(rule&&rule.innerMode==='markdown-inline'&&MD&&typeof MD.renderInline==='function'){try{return MD.renderInline(payload);}catch(_){return this._escHtml(payload);}}
return this._escHtml(payload);}
_fragmentFromHTML(html){const tpl=document.createElement('template');tpl.innerHTML=String(html||'');return tpl.content;}
_replaceElementWithHTML(el,html){if(!el||!el.parentNode)return;const parent=el.parentNode;const frag=this._fragmentFromHTML(html);parent.insertBefore(frag,el);parent.removeChild(el);}
_buildOpenRegex(rules){if(!rules||!rules.length)return null;const tokens=[];let patternLen=0;const LIMIT_TOKENS=200;const LIMIT_PATTERN_LEN=4000;for(const r of rules){if(!r||!r.open)continue;const esc=Utils.reEscape(r.open);tokens.push(esc);patternLen+=esc.length+1;if(tokens.length>LIMIT_TOKENS||patternLen>LIMIT_PATTERN_LEN)return null;}
if(!tokens.length)return null;tokens.sort((a,b)=>b.length-a.length);try{return new RegExp('(?:'+tokens.join('|')+')');}catch(_){return null;}}
compile(rules){const src=Array.isArray(rules)?rules:(window.CUSTOM_MARKUP_RULES||this.cfg.CUSTOM_MARKUP_RULES||[]);const compiled=[];let hasStream=false;for(const r of src){if(!r||typeof r.open!=='string'||typeof r.close!=='string')continue;const tag=(r.tag||'span').toLowerCase();const className=(r.className||r.class||'').trim();const innerMode=(r.innerMode==='markdown-inline'||r.innerMode==='text')?r.innerMode:'text';const stream=!!(r.stream===true);const openReplace=String((r.openReplace!=null?r.openReplace:(r.openReplace||''))||'');const closeReplace=String((r.closeReplace!=null?r.closeReplace:(r.closeReplace||''))||'');const decodeEntities=(typeof r.decodeEntities==='boolean')?r.decodeEntities:((r.name||'').toLowerCase()==='cmd'||className==='cmd');let phaseRaw=(typeof r.phase==='string')?r.phase.toLowerCase():'';if(phaseRaw!=='source'&&phaseRaw!=='html'&&phaseRaw!=='both')phaseRaw='';const looksLikeFence=(openReplace.indexOf('```')!==-1)||(closeReplace.indexOf('```')!==-1);const phase=phaseRaw||(looksLikeFence?'source':'html');const re=new RegExp(Utils.reEscape(r.open)+'([\\s\\S]*?)'+Utils.reEscape(r.close),'g');const reFull=new RegExp('^'+Utils.reEscape(r.open)+'([\\s\\S]*?)'+Utils.reEscape(r.close)+'$');const reFullTrim=new RegExp('^\\s*'+Utils.reEscape(r.open)+'([\\s\\S]*?)'+Utils.reEscape(r.close)+'\\s*$');const nl2br=!!r.nl2br;const allowBr=!!r.allowBr;const item={name:r.name||tag,tag,className,innerMode,open:r.open,close:r.close,decodeEntities,re,reFull,reFullTrim,stream,openReplace,closeReplace,phase,isSourceFence:looksLikeFence,nl2br,allowBr};compiled.push(item);if(stream)hasStream=true;}
if(compiled.length===0){const open='[!cmd]',close='[/!cmd]';const item={name:'cmd',tag:'p',className:'cmd',innerMode:'text',open,close,decodeEntities:true,re:new RegExp(Utils.reEscape(open)+'([\\s\\S]*?)'+Utils.reEscape(close),'g'),reFull:new RegExp('^'+Utils.reEscape(open)+'([\\s\\S]*?)'+Utils.reEscape(close)+'$'),reFullTrim:new RegExp('^\\s*'+Utils.reEscape(open)+'([\\s\\S]*?)'+Utils.reEscape(close)+'\\s*$'),stream:false,openReplace:'',closeReplace:'',phase:'html',isSourceFence:false,nl2br:false,allowBr:false};compiled.push(item);}
this.__compiled=compiled;this.__hasStreamRules=hasStream;this.__streamRules=compiled.filter(r=>!!r.stream);this.__streamWrapRules=this.__streamRules.filter(r=>(r.phase==='html'||r.phase==='both')&&!(r.openReplace||r.closeReplace)&&r.open&&r.close);const htmlPhaseAll=compiled.filter(r=>(r.phase==='html'||r.phase==='both'));const htmlPhaseStream=this.__streamRules.filter(r=>(r.phase==='html'||r.phase==='both'));this.__openReAll=this._buildOpenRegex(htmlPhaseAll);this.__openReStream=this._buildOpenRegex(htmlPhaseStream);this._d('cm.compile',{rules:compiled.length,streamRules:this.__streamRules.length});return compiled;}
transformSource(src,opts){let s=String(src||'');this.ensureCompiled();const rules=this.__compiled;if(!rules||!rules.length)return s;const candidates=[];for(let i=0;i<rules.length;i++){const r=rules[i];if(!r)continue;if((r.phase==='source'||r.phase==='both')&&(r.openReplace||r.closeReplace))candidates.push(r);}
if(!candidates.length)return s;const fences=this._findFenceRanges(s);let result='';if(!fences.length){result=this._applySourceReplacementsInChunk(s,s,0,candidates);}else{let out='',last=0;for(let k=0;k<fences.length;k++){const[a,b]=fences[k];if(a>last){const chunk=s.slice(last,a);out+=this._applySourceReplacementsInChunk(s,chunk,last,candidates);}
out+=s.slice(a,b);last=b;}
if(last<s.length){const tail=s.slice(last);out+=this._applySourceReplacementsInChunk(s,tail,last,candidates);}
result=out;}
if(opts&&opts.streaming===true){const fenceRules=candidates.filter(r=>!!r.isSourceFence);if(fenceRules.length)result=this._injectUnmatchedSourceOpeners(result,fenceRules);}
if(result!==src)this._d('cm.transformSource',{streaming:!!(opts&&opts.streaming),delta:result.length-String(src||'').length});return result;}
getSourceFenceSpecs(){this.ensureCompiled();const rules=this.__compiled||[];const out=[];for(let i=0;i<rules.length;i++){const r=rules[i];if(!r||!r.isSourceFence)continue;if(r.phase!=='source'&&r.phase!=='both')continue;out.push({open:r.open,close:r.close});}
return out;}
ensureCompiled(){if(!this.__compiled){this.compile(window.CUSTOM_MARKUP_RULES||this.cfg.CUSTOM_MARKUP_RULES);}
return this.__compiled;}
setRules(rules){this.compile(rules);window.CUSTOM_MARKUP_RULES=Array.isArray(rules)?rules.slice():(this.cfg.CUSTOM_MARKUP_RULES||[]).slice();this._d('cm.setRules',{count:(window.CUSTOM_MARKUP_RULES||[]).length});}
getRules(){const list=(window.CUSTOM_MARKUP_RULES?window.CUSTOM_MARKUP_RULES.slice():(this.cfg.CUSTOM_MARKUP_RULES||[]).slice());return list;}
hasStreamRules(){this.ensureCompiled();return!!this.__hasStreamRules;}
hasStreamOpenerAtStart(text){if(!text)return false;this.ensureCompiled();if(!this.__hasStreamRules)return false;const rules=this.__streamRules||[];if(!rules.length)return false;const t=String(text).trimStart();for(let i=0;i<rules.length;i++){const r=rules[i];if(!r||!r.open)continue;if(t.startsWith(r.open))return true;}
return false;}
maybeApplyStreamOnDelta(root,deltaText,MD){try{this.ensureCompiled();if(!this.__hasStreamRules)return;const t=String(deltaText||'');if(t&&this.hasAnyStreamOpenToken(t)){this._d('cm.stream.delta',{len:t.length,head:t.slice(0,64)});this.applyStream(root,MD);return;}
if(root&&root.querySelector&&root.querySelector('[data-cm-pending="1"]')){if(t.indexOf('>')!==-1||t.indexOf(']')!==-1){this.applyStreamFinalizeClosers(root,this.__streamRules);this._d('cm.stream.delta.finalize',{});}}}catch(_){return;}}
applyStream(root,MD){this.ensureCompiled();if(!this.__hasStreamRules)return;const rules=this.__streamRules;if(!rules||!rules.length)return;this.applyRules(root,MD,rules);try{this.applyStreamPartialOpeners(root,MD,this.__streamWrapRules);}catch(_){}
try{this.applyStreamFinalizeClosers(root,rules);}catch(_){}}
isInsideForbiddenContext(node){const p=node.parentElement;if(!p)return true;return!!p.closest('pre, code, kbd, samp, var, script, style, textarea, .math-pending, .hljs, .code-wrapper, ul, ol, li, dl, dt, dd');}
isInsideForbiddenElement(el){if(!el)return true;return!!el.closest('pre, code, kbd, samp, var, script, style, textarea, .math-pending, .hljs, .code-wrapper, ul, ol, li, dl, dt, dd');}
findNextMatch(text,from,rules){let best=null;for(const rule of rules){rule.re.lastIndex=from;const m=rule.re.exec(text);if(m){const start=m.index,end=rule.re.lastIndex;if(!best||start<best.start)best={rule,start,end,inner:m[1]||''};}}
return best;}
findFullMatch(text,rules){for(const rule of rules){if(rule.reFull){const m=rule.reFull.exec(text);if(m)return{rule,inner:m[1]||''};}else{rule.re.lastIndex=0;const m=rule.re.exec(text);if(m&&m.index===0&&(rule.re.lastIndex===text.length)){const m2=rule.re.exec(text);if(!m2)return{rule,inner:m[1]||''};}}}
return null;}
setInnerByMode(el,mode,text,MD,decodeEntities=false,rule=null){let payload=String(text||'');const wantsBr=!!(rule&&(rule.nl2br||rule.allowBr));if(decodeEntities&&payload&&payload.indexOf('&')!==-1){try{payload=this.decodeEntitiesOnce(payload);}catch(_){}}
if(wantsBr){el.innerHTML=this._escapeHtmlAllowBr(payload,{convertNewlines:!!(rule&&rule.nl2br)});return;}
if(mode==='markdown-inline'&&MD&&typeof MD.renderInline==='function'){try{el.innerHTML=MD.renderInline(payload);return;}catch(_){}}
el.textContent=payload;}
_tryReplaceFullParagraph(el,rules,MD){if(!el||el.tagName!=='P')return false;if(this.isInsideForbiddenElement(el)){return false;}
const t=el.textContent||'';if(!this.hasAnyOpenToken(t,rules))return false;for(const rule of rules){if(!rule)continue;const m=rule.reFullTrim?rule.reFullTrim.exec(t):null;if(!m)continue;const innerText=m[1]||'';if(rule.phase!=='html'&&rule.phase!=='both')continue;if(rule.openReplace||rule.closeReplace){const innerHTML=this._materializeInnerHTML(rule,innerText,MD);const html=String(rule.openReplace||'')+innerHTML+String(rule.closeReplace||'');this._replaceElementWithHTML(el,html);this._d('cm.replace.full',{name:rule.name});return true;}
const outTag=(rule.tag&&typeof rule.tag==='string')?rule.tag.toLowerCase():'span';const out=document.createElement(outTag==='p'?'p':outTag);if(rule.className)out.className=rule.className;out.setAttribute('data-cm',rule.name);this.setInnerByMode(out,rule.innerMode,innerText,MD,!!rule.decodeEntities,rule);try{el.replaceWith(out);}catch(_){const par=el.parentNode;if(par)par.replaceChild(out,el);}
this._d('cm.wrap.full',{name:rule.name});return true;}
return false;}
applyRules(root,MD,rules){if(!root||!rules||!rules.length)return;const scope=(root.nodeType===1||root.nodeType===11)?root:document;try{const paragraphs=(typeof scope.querySelectorAll==='function')?scope.querySelectorAll('p'):[];if(paragraphs&&paragraphs.length){for(let i=0;i<paragraphs.length;i++){const p=paragraphs[i];if(p&&p.getAttribute&&p.getAttribute('data-cm'))continue;const tc=p&&(p.textContent||'');if(!tc||!this.hasAnyOpenToken(tc,rules))continue;if(this.isInsideForbiddenElement(p))continue;this._tryReplaceFullParagraph(p,rules,MD);}}}catch(e){}
const self=this;const walker=document.createTreeWalker(root,NodeFilter.SHOW_TEXT,{acceptNode:(node)=>{const val=node&&node.nodeValue?node.nodeValue:'';if(!val||!self.hasAnyOpenToken(val,rules))return NodeFilter.FILTER_SKIP;if(self.isInsideForbiddenContext(node))return NodeFilter.FILTER_REJECT;return NodeFilter.FILTER_ACCEPT;}});let node;while((node=walker.nextNode())){const text=node.nodeValue;if(!text||!this.hasAnyOpenToken(text,rules))continue;const parent=node.parentElement;if(parent&&parent.tagName==='P'&&parent.childNodes.length===1){const fm=this.findFullMatch(text,rules);if(fm){if((fm.rule.phase==='html'||fm.rule.phase==='both')&&(fm.rule.openReplace||fm.rule.closeReplace)){const innerHTML=this._materializeInnerHTML(fm.rule,fm.inner,MD);const html=String(fm.rule.openReplace||'')+innerHTML+String(fm.rule.closeReplace||'');this._replaceElementWithHTML(parent,html);this._d('cm.replace.inlineFull',{name:fm.rule.name});continue;}
if(fm.rule.tag==='p'){const out=document.createElement('p');if(fm.rule.className)out.className=fm.rule.className;out.setAttribute('data-cm',fm.rule.name);this.setInnerByMode(out,fm.rule.innerMode,fm.inner,MD,!!fm.rule.decodeEntities,fm.rule);try{parent.replaceWith(out);}catch(_){const par=parent.parentNode;if(par)par.replaceChild(out,parent);}
this._d('cm.wrap.paragraph',{name:fm.rule.name});continue;}}}
let i=0;let didReplace=false;const frag=document.createDocumentFragment();while(i<text.length){const m=this.findNextMatch(text,i,rules);if(!m)break;if(m.start>i){frag.appendChild(document.createTextNode(text.slice(i,m.start)));}
if((m.rule.openReplace||m.rule.closeReplace)&&(m.rule.phase==='html'||m.rule.phase==='both')){const innerHTML=this._materializeInnerHTML(m.rule,m.inner,MD);const html=String(m.rule.openReplace||'')+innerHTML+String(m.rule.closeReplace||'');const part=this._fragmentFromHTML(html);frag.appendChild(part);i=m.end;didReplace=true;this._d('cm.replace.inline',{name:m.rule.name});continue;}
if(m.rule.openReplace||m.rule.closeReplace){frag.appendChild(document.createTextNode(text.slice(m.start,m.end)));i=m.end;didReplace=true;continue;}
const tag=(m.rule.tag==='p')?'span':m.rule.tag;const el=document.createElement(tag);if(m.rule.className)el.className=m.rule.className;el.setAttribute('data-cm',m.rule.name);this.setInnerByMode(el,m.rule.innerMode,m.inner,MD,!!m.rule.decodeEntities,m.rule);frag.appendChild(el);this._d('cm.wrap.inline',{name:m.rule.name});i=m.end;didReplace=true;}
if(!didReplace)continue;if(i<text.length)frag.appendChild(document.createTextNode(text.slice(i)));const parentNode=node.parentNode;if(parentNode){parentNode.replaceChild(frag,node);}}}
apply(root,MD){this.ensureCompiled();this.applyRules(root,MD,this.__compiled);}
applyStreamPartialOpeners(root,MD,rules){if(!root)return;rules=(rules||this.__streamWrapRules||[]).slice();if(!rules.length)return;const scope=(root.nodeType===1||root.nodeType===11)?root:document;const self=this;const walker=document.createTreeWalker(scope,NodeFilter.SHOW_TEXT,{acceptNode(node){const val=node&&node.nodeValue?node.nodeValue:'';if(!val||!self.hasAnyOpenToken(val,rules))return NodeFilter.FILTER_SKIP;if(self.isInsideForbiddenContext(node))return NodeFilter.FILTER_REJECT;return NodeFilter.FILTER_ACCEPT;}});let node;while((node=walker.nextNode())){const text=node.nodeValue||'';if(!text)continue;let best=null;for(let i=0;i<rules.length;i++){const r=rules[i];if(!r||!r.open||!r.close)continue;const idx=text.lastIndexOf(r.open);if(idx===-1)continue;const after=text.indexOf(r.close,idx+r.open.length);if(after!==-1)continue;if(!best||idx>best.start)best={rule:r,start:idx};}
if(!best)continue;const r=best.rule;const start=best.start;const openLen=r.open.length;const prefixText=text.slice(0,start);const fromOffset=start+openLen;try{const range=document.createRange();range.setStart(node,Math.min(fromOffset,node.nodeValue.length));let endNode=root;try{endNode=(root.nodeType===11||root.nodeType===1)?root:node.parentNode;while(endNode&&endNode.lastChild)endNode=endNode.lastChild;}catch(_){}
if(endNode&&endNode.nodeType===3)range.setEnd(endNode,endNode.nodeValue.length);else if(endNode)range.setEndAfter(endNode);else range.setEndAfter(node);const remainder=range.extractContents();const outTag=(r.tag&&typeof r.tag==='string')?r.tag.toLowerCase():'span';const hostTag=(outTag==='p')?'span':outTag;const el=document.createElement(hostTag);if(r.className)el.className=r.className;el.setAttribute('data-cm',r.name);el.setAttribute('data-cm-pending','1');el.appendChild(remainder);range.insertNode(el);range.detach();try{node.nodeValue=prefixText;}catch(_){}
this._d('cm.stream.open.pending',{name:r.name});return;}catch(err){try{const tail=text.slice(start+r.open.length);const frag=document.createDocumentFragment();if(prefixText)frag.appendChild(document.createTextNode(prefixText));const el=document.createElement((r.tag==='p')?'span':r.tag);if(r.className)el.className=r.className;el.setAttribute('data-cm',r.name);el.setAttribute('data-cm-pending','1');this.setInnerByMode(el,r.innerMode,tail,MD,!!r.decodeEntities,r);frag.appendChild(el);node.parentNode.replaceChild(frag,node);this._d('cm.stream.open.pending.fallback',{name:r.name});return;}catch(_){}}}}
applyStreamFinalizeClosers(root,rulesAll){if(!root)return;const scope=(root.nodeType===1||root.nodeType===11)?root:document;const pending=scope.querySelectorAll('[data-cm][data-cm-pending="1"]');if(!pending||!pending.length)return;const rulesByName=new Map();(rulesAll||[]).forEach(r=>{if(r&&r.name)rulesByName.set(r.name,r);});for(let i=0;i<pending.length;i++){const el=pending[i];const name=el.getAttribute('data-cm')||'';const rule=rulesByName.get(name);if(!rule||!rule.close)continue;const self=this;const walker=document.createTreeWalker(el,NodeFilter.SHOW_TEXT,{acceptNode(node){const val=node&&node.nodeValue?node.nodeValue:'';if(!val||val.indexOf(rule.close)===-1)return NodeFilter.FILTER_SKIP;if(self.isInsideForbiddenContext(node))return NodeFilter.FILTER_REJECT;return NodeFilter.FILTER_ACCEPT;}});let nodeWithClose=null;let idxInNode=-1;let tn;while((tn=walker.nextNode())){const idx=tn.nodeValue.indexOf(rule.close);if(idx!==-1){nodeWithClose=tn;idxInNode=idx;break;}}
if(!nodeWithClose)continue;try{const tokenLen=rule.close.length;const afterRange=document.createRange();afterRange.setStart(nodeWithClose,idxInNode+tokenLen);let endNode=el;while(endNode&&endNode.lastChild)endNode=endNode.lastChild;if(endNode&&endNode.nodeType===3)afterRange.setEnd(endNode,endNode.nodeValue.length);else afterRange.setEndAfter(el.lastChild||el);const tail=afterRange.extractContents();afterRange.detach();const tok=document.createRange();tok.setStart(nodeWithClose,idxInNode);tok.setEnd(nodeWithClose,idxInNode+tokenLen);tok.deleteContents();tok.detach();if(el.parentNode&&tail&&tail.childNodes.length){el.parentNode.insertBefore(tail,el.nextSibling);}
el.removeAttribute('data-cm-pending');this._d('cm.stream.close.finalize',{name});}catch(err){}}}
_findFenceRanges(s){const ranges=[];const n=s.length;let i=0;let inFence=false;let fenceMark='';let fenceLen=0;let startLineStart=0;while(i<n){const lineStart=i;let j=lineStart;while(j<n&&s.charCodeAt(j)!==10&&s.charCodeAt(j)!==13)j++;const lineEnd=j;let nl=0;if(j<n){if(s.charCodeAt(j)===13&&j+1<n&&s.charCodeAt(j+1)===10)nl=2;else nl=1;}
let k=lineStart;let indent=0;while(k<lineEnd){const c=s.charCodeAt(k);if(c===32){indent++;if(indent>3)break;k++;}else if(c===9){indent++;if(indent>3)break;k++;}else break;}
if(!inFence){if(indent<=3&&k<lineEnd){const ch=s.charCodeAt(k);if(ch===0x60||ch===0x7E){const mark=String.fromCharCode(ch);let m=k;while(m<lineEnd&&s.charCodeAt(m)===ch)m++;const run=m-k;if(run>=3){inFence=true;fenceMark=mark;fenceLen=run;startLineStart=lineStart;}}}}else{if(indent<=3&&k<lineEnd&&s.charCodeAt(k)===fenceMark.charCodeAt(0)){let m=k;while(m<lineEnd&&s.charCodeAt(m)===fenceMark.charCodeAt(0))m++;const run=m-k;if(run>=fenceLen){let onlyWS=true;for(let t=m;t<lineEnd;t++){const cc=s.charCodeAt(t);if(cc!==32&&cc!==9){onlyWS=false;break;}}
if(onlyWS){const endIdx=lineEnd+nl;ranges.push([startLineStart,endIdx]);inFence=false;fenceMark='';fenceLen=0;startLineStart=0;}}}}
i=lineEnd+nl;}
if(inFence)ranges.push([startLineStart,n]);return ranges;}
_isTopLevelLineInSource(s,absIdx){let ls=absIdx;while(ls>0){const ch=s.charCodeAt(ls-1);if(ch===10||ch===13)break;ls--;}
const prefix=s.slice(ls,absIdx);let i=0,indent=0;while(i<prefix.length){const c=prefix.charCodeAt(i);if(c===32){indent++;if(indent>3)break;i++;}
else if(c===9){indent++;if(indent>3)break;i++;}
else break;}
if(indent>3)return false;const rest=prefix.slice(i);if(/^>\s?/.test(rest))return false;if(/^[-+*]\s/.test(rest))return false;if(/^\d+[.)]\s/.test(rest))return false;if(rest.trim().length>0)return false;return true;}
_applySourceReplacementsInChunk(full,chunk,baseOffset,rules){let t=chunk;for(let i=0;i<rules.length;i++){const r=rules[i];if(!r||!(r.openReplace||r.closeReplace))continue;try{r.re.lastIndex=0;t=t.replace(r.re,(match,inner,offset)=>{const abs=baseOffset+(offset|0);if(!this._isTopLevelLineInSource(full,abs))return match;const open=r.openReplace||'';const close=r.closeReplace||'';return open+(inner||'')+close;});}catch(_){}}
return t;}
_injectUnmatchedSourceOpeners(text,fenceRules){let s=String(text||'');if(!s||!fenceRules||!fenceRules.length)return s;let best=null;for(let i=0;i<fenceRules.length;i++){const r=fenceRules[i];if(!r||!r.open||!r.close||!r.openReplace)continue;const idx=s.lastIndexOf(r.open);if(idx===-1)continue;if(!this._isTopLevelLineInSource(s,idx))continue;const after=s.indexOf(r.close,idx+r.open.length);if(after!==-1)continue;if(!best||idx>best.idx)best={r,idx};}
if(!best)return s;const r=best.r,i=best.idx;const before=s.slice(0,i);const after=s.slice(i+r.open.length);const injected=String(r.openReplace||'');this._d('cm.inject.open',{name:r.name});return before+injected+after;}};

/* data/js/app/data.js */
class DataReceiver{constructor(cfg,templates,nodes,scrollMgr){this.cfg=cfg||{};this.templates=templates;this.nodes=nodes;this.scrollMgr=scrollMgr;}
_tryParseJSON(s){if(typeof s!=='string')return s;const t=s.trim();if(!t)return null;if(t[0]==='<')return null;try{return JSON.parse(t);}catch(_){return null;}}
_normalizeToBlocks(obj){if(!obj)return[];if(Array.isArray(obj))return obj;if(obj.node)return[obj.node];if(obj.nodes)return(Array.isArray(obj.nodes)?obj.nodes:[]);if(typeof obj==='object'&&(obj.input||obj.output||obj.id))return[obj];return[];}
append(payload){if(typeof payload==='string'&&payload.trim().startsWith('<')){this.nodes.appendNode(payload,this.scrollMgr);return;}
const obj=this._tryParseJSON(payload);if(!obj){this.nodes.appendNode(String(payload),this.scrollMgr);return;}
const blocks=this._normalizeToBlocks(obj);if(!blocks.length){this.nodes.appendNode('',this.scrollMgr);return;}
const html=this.templates.renderNodes(blocks);this.nodes.appendNode(html,this.scrollMgr);}
replace(payload){if(typeof payload==='string'&&payload.trim().startsWith('<')){this.nodes.replaceNodes(payload,this.scrollMgr);return;}
const obj=this._tryParseJSON(payload);if(!obj){this.nodes.replaceNodes(String(payload),this.scrollMgr);return;}
const blocks=this._normalizeToBlocks(obj);if(!blocks.length){this.nodes.replaceNodes('',this.scrollMgr);return;}
const html=this.templates.renderNodes(blocks);this.nodes.replaceNodes(html,this.scrollMgr);}};

/* data/js/app/dom.js */
class DOMRefs{constructor(){this.els=Object.create(null);this._domOutputStreamRef=null;this._domStreamMsgRef=null;this._domStreamBoxRef=null;}
init(){const ids=['container','_nodes_','_append_input_','_append_output_before_','_append_output_','_append_live_','_footer_','_loader_','tips','scrollFab','scrollFabIcon'];for(let i=0;i<ids.length;i++){const id=ids[i];const el=document.getElementById(id);if(el)this.els[id]=el;}}
get(id){let el=this.els[id];if(el&&el.isConnected)return el;el=document.getElementById(id);if(el)this.els[id]=el;return el||null;}
resetEphemeral(){this._domStreamMsgRef=null;this._domStreamBoxRef=null;}
cleanup(){this.resetEphemeral();this._domOutputStreamRef=null;this.els=Object.create(null);try{history.scrollRestoration="auto";}catch(_){}}
_deref(ref){if(!ref||typeof ref.deref!=='function')return null;try{const el=ref.deref();return(el&&el.isConnected)?el:null;}catch(_){return null;}}
fastClear(id){const el=this.get(id);if(!el)return null;if(el.firstChild){if(typeof el.replaceChildren==='function')el.replaceChildren();else el.textContent='';}
return el;}
async fastClearAndPaint(id){const el=this.fastClear(id);if(!el)return null;try{if(typeof runtime!=='undefined'&&runtime.raf&&typeof runtime.raf.nextFrame==='function'){await runtime.raf.nextFrame();}else if(typeof requestAnimationFrame==='function'){await new Promise(res=>requestAnimationFrame(()=>res()));}else{await new Promise(res=>setTimeout(res,16));}}catch(_){}
return el;}
fastClearHidden(id){const el=this.get(id);if(!el)return null;const prevDisplay=el.style.display;el.style.display='none';if(typeof el.replaceChildren==='function')el.replaceChildren();else el.textContent='';el.style.display=prevDisplay;return el;}
hardReplaceByClone(id){const el=this.get(id);if(!el||!el.parentNode)return null;const clone=el.cloneNode(false);try{el.replaceWith(clone);}catch(_){el.textContent='';return el;}
this.els[id]=clone;if(id==='_append_output_'){this._domOutputStreamRef=(typeof WeakRef!=='undefined')?new WeakRef(clone):null;}
return clone;}
hardResetStreamContainers(){this.resetEphemeral();this._domOutputStreamRef=null;this.fastClearHidden('_append_output_before_');this.fastClearHidden('_append_output_');}
getStreamContainer(){let el=this._deref(this._domOutputStreamRef);if(el)return el;el=this.get('_append_output_');if(el)this._domOutputStreamRef=(typeof WeakRef!=='undefined')?new WeakRef(el):null;return el;}
_sanitizeHeaderFragment(root){const ALLOWED=new Set(['IMG','SPAN','STRONG','EM']);const ALLOWED_ATTR={IMG:new Set(['src','alt','class','width','height','loading','decoding']),SPAN:new Set(['class']),STRONG:new Set([]),EM:new Set([])};const isAllowedSrc=(src)=>{if(!src||typeof src!=='string')return false;const s=src.trim().toLowerCase();if(s.startsWith('file:'))return true;if(s.startsWith('qrc:'))return true;if(s.startsWith('bridge:'))return true;if(s.startsWith('blob:'))return true;if(s.startsWith('data:image/'))return true;if(s.startsWith('http:'))return true;if(s.startsWith('https:'))return true;if(!/^[a-z0-9.+-]+:/.test(s))return true;return false;};const walker=document.createTreeWalker(root,NodeFilter.SHOW_ELEMENT,null);const toRemove=[];while(walker.nextNode()){const el=walker.currentNode;const tag=el.tagName;if(!ALLOWED.has(tag)){toRemove.push(el);continue;}
const allowAttrs=ALLOWED_ATTR[tag];for(let i=el.attributes.length-1;i>=0;i--){const a=el.attributes[i];if(!allowAttrs.has(a.name))el.removeAttribute(a.name);}
if(tag==='IMG'){const src=el.getAttribute('src')||'';if(!isAllowedSrc(src)){toRemove.push(el);continue;}
if(!el.hasAttribute('loading'))el.setAttribute('loading','lazy');if(!el.hasAttribute('decoding'))el.setAttribute('decoding','async');}}
for(const el of toRemove){const txt=el.textContent||'';const tn=document.createTextNode(txt);try{el.replaceWith(tn);}catch(_){}}}
_setHeaderHTML(container,html){if(!container)return;const s=String(html||'');if(s.indexOf('<')===-1&&s.indexOf('&')===-1){container.textContent=s;return;}
const tpl=document.createElement('template');tpl.innerHTML=s;const frag=tpl.content;try{this._sanitizeHeaderFragment(frag);container.replaceChildren(frag);}catch(_){container.textContent=s.replace(/<[^>]*>/g,'');}}
getStreamMsg(create,name_header){const container=this.getStreamContainer();if(!container)return null;let msg=this._deref(this._domStreamMsgRef);if(msg)return msg;let box=this._deref(this._domStreamBoxRef);if(!box){try{box=container.querySelector('.msg-box');}catch(_){box=null;}}
if(!box&&create){const frag=document.createDocumentFragment();const newBox=document.createElement('div');newBox.classList.add('msg-box','msg-bot');if(name_header){const name=document.createElement('div');name.classList.add('name-header','name-bot');this._setHeaderHTML(name,name_header);newBox.appendChild(name);}
const newMsg=document.createElement('div');newMsg.classList.add('msg');const snap=document.createElement('div');snap.className='md-snapshot-root';newMsg.appendChild(snap);newBox.appendChild(newMsg);frag.appendChild(newBox);container.appendChild(frag);this._domStreamBoxRef=(typeof WeakRef!=='undefined')?new WeakRef(newBox):null;this._domStreamMsgRef=(typeof WeakRef!=='undefined')?new WeakRef(newMsg):null;return newMsg;}
if(box){try{msg=box.querySelector('.msg');}catch(_){msg=null;}
if(!msg){msg=document.createElement('div');msg.classList.add('msg');box.appendChild(msg);}
if(!msg.querySelector('.md-snapshot-root')){const snap=document.createElement('div');snap.className='md-snapshot-root';msg.appendChild(snap);}
this._domStreamBoxRef=(typeof WeakRef!=='undefined')?new WeakRef(box):null;this._domStreamMsgRef=(typeof WeakRef!=='undefined')?new WeakRef(msg):null;}
return msg||null;}
clearStreamBefore(){try{if(typeof window.hideTips==='function')window.hideTips();}catch(_){}
this.fastClearHidden('_append_output_before_');}
clearOutput(){this.hardResetStreamContainers();}
clearNodes(){this.clearStreamBefore();const el=this.fastClearHidden('_nodes_');if(el)el.classList.add('empty_list');this.resetEphemeral();}
clearInput(){this.fastClearHidden('_append_input_');}
clearLive(){const el=this.fastClearHidden('_append_live_');if(!el)return;el.classList.remove('visible');el.classList.add('hidden');this.resetEphemeral();}};

/* data/js/app/events.js */
class EventManager{constructor(cfg,dom,scrollMgr,highlighter,codeScroll,toolOutput,bridge){this.cfg=cfg;this.dom=dom;this.scrollMgr=scrollMgr;this.highlighter=highlighter;this.codeScroll=codeScroll;this.toolOutput=toolOutput;this.bridge=bridge;this.handlers={wheel:null,scroll:null,resize:null,fabClick:null,mouseover:null,mouseout:null,click:null,keydown:null,docClickFocus:null,visibility:null,focus:null,pageshow:null};}
_findWrapper(target){if(!target||typeof target.closest!=='function')return null;return target.closest('.code-wrapper');}
_getCodeEl(wrapper){if(!wrapper)return null;return wrapper.querySelector('pre > code');}
_collectCodeText(codeEl){if(!codeEl)return'';const frozen=codeEl.querySelector('.hl-frozen');const tail=codeEl.querySelector('.hl-tail');if(frozen||tail)return(frozen?.textContent||'')+(tail?.textContent||'');return codeEl.textContent||'';}
_collectUserText(msgBox){if(!msgBox)return'';const msg=msgBox.querySelector('.msg');if(!msg)return'';const root=msg.querySelector('.uc-content')||msg;let out='';const walker=document.createTreeWalker(root,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,{acceptNode:(node)=>{if(node.nodeType===Node.ELEMENT_NODE){const el=node;if(el.matches('.uc-ellipsis,[data-copy-ignore="1"],.msg-copy-btn,.uc-toggle')){return NodeFilter.FILTER_REJECT;}
if(el.tagName==='BR'){out+='\n';return NodeFilter.FILTER_SKIP;}}
if(node.nodeType===Node.TEXT_NODE){return NodeFilter.FILTER_ACCEPT;}
return NodeFilter.FILTER_SKIP;}},false);let n;while((n=walker.nextNode())){out+=n.nodeValue;}
return String(out||'').replace(/\r\n?/g,'\n');}
async _copyTextRobust(text){try{if(this.bridge&&typeof this.bridge.copyCode==='function'){this.bridge.copyCode(text);return true;}}catch(_){}
try{if(navigator&&navigator.clipboard&&navigator.clipboard.writeText){await navigator.clipboard.writeText(text);return true;}}catch(_){}
try{const ta=document.createElement('textarea');ta.value=text;ta.setAttribute('readonly','');ta.style.position='fixed';ta.style.top='-9999px';ta.style.opacity='0';document.body.appendChild(ta);ta.select();const ok=document.execCommand&&document.execCommand('copy');document.body.removeChild(ta);return!!ok;}catch(_){return false;}}
_flashCopied(btn,wrapper){if(!btn)return;const DUR=1200;const img=btn.querySelector('img.copy-img')||btn.querySelector('img.action-img')||btn.querySelector('img');try{if(btn.__copyTimer){clearTimeout(btn.__copyTimer);btn.__copyTimer=0;}}catch(_){}
try{if(btn.__iconTimer){clearTimeout(btn.__iconTimer);btn.__iconTimer=0;}}catch(_){}
if(typeof window!=='undefined'&&window.ICON_DONE&&img){if(!btn.__origIconSrc){try{btn.__origIconSrc=img.getAttribute('src')||'';}catch(_){btn.__origIconSrc='';}}
try{img.setAttribute('src',String(window.ICON_DONE));}catch(_){}
btn.__iconTimer=setTimeout(()=>{try{const orig=btn.__origIconSrc||'';if(orig)img.setAttribute('src',orig);}catch(_){}
btn.__iconTimer=0;},DUR);}
const span=btn.querySelector('span');if(!span){btn.classList.add('copied');btn.__copyTimer=setTimeout(()=>{try{btn.classList.remove('copied');}catch(_){}
btn.__copyTimer=0;},DUR);return;}
const L_COPY=(wrapper&&wrapper.getAttribute('data-locale-copy'))||'Copy';const L_COPIED=(wrapper&&wrapper.getAttribute('data-locale-copied'))||'Copied';span.textContent=L_COPIED;btn.classList.add('copied');btn.__copyTimer=setTimeout(()=>{try{span.textContent=L_COPY;btn.classList.remove('copied');}catch(_){}
btn.__copyTimer=0;},DUR);}
_toggleCollapse(wrapper){if(!wrapper)return;const codeEl=this._getCodeEl(wrapper);if(!codeEl)return;const btn=wrapper.querySelector('.code-header-collapse');const span=btn?btn.querySelector('span'):null;const L_COLLAPSE=wrapper.getAttribute('data-locale-collapse')||'Collapse';const L_EXPAND=wrapper.getAttribute('data-locale-expand')||'Expand';const idx=String(wrapper.getAttribute('data-index')||'');const arr=window.__collapsed_idx||(window.__collapsed_idx=[]);const isHidden=(codeEl.style.display==='none');if(isHidden){codeEl.style.display='block';if(span)span.textContent=L_COLLAPSE;const p=arr.indexOf(idx);if(p!==-1)arr.splice(p,1);if(btn)btn.setAttribute('title',L_COLLAPSE);}else{codeEl.style.display='none';if(span)span.textContent=L_EXPAND;if(!arr.includes(idx))arr.push(idx);if(btn)btn.setAttribute('title',L_EXPAND);}
if(btn){try{if(btn.__popTimer){clearTimeout(btn.__popTimer);btn.__popTimer=0;}}catch(_){}
btn.classList.add('copied');btn.__popTimer=setTimeout(()=>{try{btn.classList.remove('copied');}catch(_){}
btn.__popTimer=0;},1200);}}
install(){try{history.scrollRestoration="manual";}catch(_){}
this.handlers.keydown=(event)=>{if(event.ctrlKey&&event.key==='f'){window.location.href='bridge://open_find:'+runtime.cfg.PID;event.preventDefault();}
if(event.key==='Escape'){window.location.href='bridge://escape';event.preventDefault();}};document.addEventListener('keydown',this.handlers.keydown,{passive:false});const container=this.dom.get('container');const inputArea=this.dom.get('_append_input_');const addClassToMsg=(id,className)=>{const el=document.getElementById('msg-bot-'+id);if(el)el.classList.add(className);};const removeClassFromMsg=(id,className)=>{const el=document.getElementById('msg-bot-'+id);if(el)el.classList.remove(className);};this.handlers.mouseover=(event)=>{if(event.target.classList.contains('action-img')){const id=event.target.getAttribute('data-id');addClassToMsg(id,'msg-highlight');}};this.handlers.mouseout=(event)=>{if(event.target.classList.contains('action-img')){const id=event.target.getAttribute('data-id');const el=document.getElementById('msg-bot-'+id);if(el)el.classList.remove('msg-highlight');}};if(container){container.addEventListener('mouseover',this.handlers.mouseover,{passive:true});container.addEventListener('mouseout',this.handlers.mouseout,{passive:true});}
this.handlers.click=async(ev)=>{const aCode=ev.target&&(ev.target.closest?ev.target.closest('a.code-header-action'):null)||null;const aUserCopy=ev.target&&(ev.target.closest?ev.target.closest('a.msg-copy-btn'):null)||null;if(!aCode&&!aUserCopy)return;ev.preventDefault();ev.stopPropagation();if(aCode){const wrapper=this._findWrapper(aCode);if(!wrapper)return;const isCopy=aCode.classList.contains('code-header-copy');const isCollapse=aCode.classList.contains('code-header-collapse');const isRun=aCode.classList.contains('code-header-run');const isPreview=aCode.classList.contains('code-header-preview');let codeEl=null,text='';if(isCopy||isRun||isPreview){codeEl=this._getCodeEl(wrapper);text=this._collectCodeText(codeEl);}
try{if(isCopy){const ok=await this._copyTextRobust(text);if(ok)this._flashCopied(aCode,wrapper);}else if(isCollapse){this._toggleCollapse(wrapper);}else if(isRun){if(this.bridge&&typeof this.bridge.runCode==='function')this.bridge.runCode(text);}else if(isPreview){if(this.bridge&&typeof this.bridge.previewCode==='function')this.bridge.previewCode(text);}}catch(_){}
return;}
if(aUserCopy){try{const msgBox=aUserCopy.closest('.msg-box.msg-user');const text=this._collectUserText(msgBox);const ok=await this._copyTextRobust(text);const L=(this.cfg&&this.cfg.LOCALE)||{};const L_COPY=L.COPY||'Copy';const L_COPIED=L.COPIED||'Copied';if(ok){this._flashCopied(aUserCopy,null);}}catch(_){}}};if(container)container.addEventListener('click',this.handlers.click,{passive:false});if(inputArea)inputArea.addEventListener('click',this.handlers.click,{passive:false});this.handlers.wheel=(ev)=>{runtime.scrollMgr.userInteracted=true;if(ev.deltaY<0)runtime.scrollMgr.autoFollow=false;else runtime.scrollMgr.maybeEnableAutoFollowByProximity();this.highlighter.scheduleScanVisibleCodes(runtime.stream.activeCode);};document.addEventListener('wheel',this.handlers.wheel,{passive:true});this.handlers.scroll=()=>{const el=Utils.SE;const top=el.scrollTop;if(top+1<runtime.scrollMgr.lastScrollTop)runtime.scrollMgr.autoFollow=false;runtime.scrollMgr.maybeEnableAutoFollowByProximity();runtime.scrollMgr.lastScrollTop=top;const action=runtime.scrollMgr.computeFabAction();if(action!==runtime.scrollMgr.currentFabAction)runtime.scrollMgr.updateScrollFab(false,action,true);this.highlighter.scheduleScanVisibleCodes(runtime.stream.activeCode);};window.addEventListener('scroll',this.handlers.scroll,{passive:true});const fab=this.dom.get('scrollFab');if(fab){this.handlers.fabClick=(ev)=>{ev.preventDefault();ev.stopPropagation();const action=runtime.scrollMgr.computeFabAction();if(action==='up')runtime.scrollMgr.scrollToTopUser();else if(action==='down')runtime.scrollMgr.scrollToBottomUser();runtime.scrollMgr.fabFreezeUntil=Utils.now()+this.cfg.FAB.TOGGLE_DEBOUNCE_MS;runtime.scrollMgr.updateScrollFab(true);};fab.addEventListener('click',this.handlers.fabClick,{passive:false});}
this.handlers.resize=()=>{runtime.scrollMgr.maybeEnableAutoFollowByProximity();runtime.scrollMgr.scheduleScrollFabUpdate();this.highlighter.scheduleScanVisibleCodes(runtime.stream.activeCode);};window.addEventListener('resize',this.handlers.resize,{passive:true});}
cleanup(){const container=this.dom.get('container');const inputArea=this.dom.get('_append_input_');if(this.handlers.wheel)document.removeEventListener('wheel',this.handlers.wheel);if(this.handlers.scroll)window.removeEventListener('scroll',this.handlers.scroll);if(this.handlers.resize)window.removeEventListener('resize',this.handlers.resize);const fab=this.dom.get('scrollFab');if(fab&&this.handlers.fabClick)fab.removeEventListener('click',this.handlers.fabClick);if(container&&this.handlers.mouseover)container.removeEventListener('mouseover',this.handlers.mouseover);if(container&&this.handlers.mouseout)container.removeEventListener('mouseout',this.handlers.mouseout);if(container&&this.handlers.click)container.removeEventListener('click',this.handlers.click);if(inputArea&&this.handlers.click)inputArea.removeEventListener('click',this.handlers.click);if(this.handlers.keydown)document.removeEventListener('keydown',this.handlers.keydown);if(this.handlers.docClickFocus)document.removeEventListener('click',this.handlers.docClickFocus);if(this.handlers.visibility)document.removeEventListener('visibilitychange',this.handlers.visibility);if(this.handlers.focus)window.removeEventListener('focus',this.handlers.focus);if(this.handlers.pageshow)window.removeEventListener('pageshow',this.handlers.pageshow);this.handlers={};}};

/* data/js/app/highlight.js */
class Highlighter{constructor(cfg,codeScroll,raf){this.cfg=cfg;this.codeScroll=codeScroll;this.raf=raf;this.hlScheduled=false;this.hlQueue=[];this.hlQueueSet=new WeakSet();this.scanScheduled=false;this._activeCodeEl=null;this._globalScanState=null;this.ALIAS={txt:'plaintext',text:'plaintext',plaintext:'plaintext',sh:'bash',shell:'bash',zsh:'bash','shell-session':'bash',py:'python',python3:'python',py3:'python',js:'javascript',node:'javascript',nodejs:'javascript',ts:'typescript','ts-node':'typescript',yml:'yaml',kt:'kotlin',rs:'rust',csharp:'csharp','c#':'csharp','c++':'cpp',ps:'powershell',ps1:'powershell',pwsh:'powershell',powershell7:'powershell',docker:'dockerfile'};const hint=(cfg&&cfg.RAF&&cfg.RAF.FLUSH_BUDGET_MS)?cfg.RAF.FLUSH_BUDGET_MS:7;this.SCAN_STEP_BUDGET_MS=Math.max(3,Math.min(12,hint));}
_d(tag,data){try{const lg=this.logger||(this.cfg&&this.cfg.logger)||(window.runtime&&runtime.logger)||null;if(!lg||typeof lg.debug!=='function')return;lg.debug_obj("HL",tag,data);}catch(_){}}
_decodeEntitiesDeep(text,maxPasses=2){if(!text||text.indexOf('&')===-1)return text||'';const ta=Highlighter._decTA||(Highlighter._decTA=document.createElement('textarea'));const decodeOnce=(s)=>{ta.innerHTML=s;return ta.value;};let prev=String(text),cur=decodeOnce(prev),passes=1;while(passes<maxPasses&&cur!==prev){prev=cur;cur=decodeOnce(prev);passes++;}
return cur;}
isDisabled(){return!!this.cfg.HL.DISABLE_ALL;}
initHLJS(){if(this.isDisabled())return;if(typeof hljs!=='undefined'&&hljs){try{hljs.configure({ignoreUnescapedHTML:true});}catch(_){}}}
_nearViewport(el){const preload=this.cfg.SCAN.PRELOAD_PX;const vh=window.innerHeight||Utils.SE.clientHeight||800;const r=el.getBoundingClientRect();return r.bottom>=-preload&&r.top<=(vh+preload);}
queue(codeEl,activeCode){if(this.isDisabled())return;if(!codeEl||!codeEl.isConnected)return;if(activeCode&&activeCode.codeEl)this._activeCodeEl=activeCode.codeEl;if(this._activeCodeEl&&codeEl===this._activeCodeEl)return;if(codeEl.getAttribute('data-highlighted')==='yes')return;if(codeEl.dataset&&(codeEl.dataset.hlStreamSuspended==='1'||codeEl.dataset.finalHlSkip==='1'))return;if(!codeEl.closest('.msg-box.msg-bot'))return;if(!this.hlQueueSet.has(codeEl)){this.hlQueueSet.add(codeEl);this.hlQueue.push(codeEl);}
if(!this.hlScheduled){this.hlScheduled=true;this.raf.schedule('HL:flush',()=>this.flush(),'Highlighter',1);}
try{const wrap=codeEl.closest('.code-wrapper');const len=wrap?parseInt(wrap.getAttribute('data-code-len')||'0',10):NaN;this._d('queue',{len,hasWrap:!!wrap});}catch(_){}}
flush(){if(this.isDisabled()){this.hlScheduled=false;this.hlQueueSet.clear();this.hlQueue.length=0;return;}
this.hlScheduled=false;const activeEl=this._activeCodeEl;let count=0;while(this.hlQueue.length&&count<this.cfg.HL.PER_FRAME){const el=this.hlQueue.shift();if(el&&el.isConnected)this.safeHighlight(el,activeEl);if(el)this.hlQueueSet.delete(el);count++;try{const sched=(navigator&&navigator.scheduling&&navigator.scheduling.isInputPending)?navigator.scheduling:null;if(sched&&sched.isInputPending({includeContinuous:true})){if(this.hlQueue.length){this.hlScheduled=true;this.raf.schedule('HL:flush',()=>this.flush(),'Highlighter',1);}
this._d('flush.yield',{processed:count,remaining:this.hlQueue.length});return;}}catch(_){}}
if(this.hlQueue.length){this.hlScheduled=true;this.raf.schedule('HL:flush',()=>this.flush(),'Highlighter',1);}
this._d('flush.done',{processed:count,remaining:this.hlQueue.length});}
_needsDeepDecode(text){if(!text)return false;const s=String(text);return(s.indexOf('&')!==-1)||(s.indexOf('&#')!==-1);}
_decodeEntitiesCheap(s){return s.replaceAll('&amp;','&').replaceAll('&lt;','<').replaceAll('&gt;','>').replaceAll('&quot;','"').replaceAll('&#39;',"'");}
detachHandlersIfFinal(el){if(this.isFinalizedCode(el))this.detachHandlers(el);}
microHighlightNow(root,opts,activeCode){if(this.isDisabled())return;const scope=root||document;const options=Object.assign({maxCount:1,budgetMs:4},opts||{});const activeEl=activeCode&&activeCode.codeEl?activeCode.codeEl:null;const maxLines=(this.cfg.HL&&this.cfg.HL.MICRO_MAX_LINES)||Math.min(80,this.cfg.PROFILE_CODE.finalHighlightMaxLines||200);const maxChars=(this.cfg.HL&&this.cfg.HL.MICRO_MAX_CHARS)||Math.min(4000,this.cfg.PROFILE_CODE.finalHighlightMaxChars||20000);const nodes=scope.querySelectorAll('.msg-box.msg-bot pre code:not([data-highlighted="yes"])');const start=Utils.now();let done=0;for(let i=0;i<nodes.length&&done<options.maxCount;i++){const el=nodes[i];if(!el||!el.isConnected)continue;if(activeEl&&el===activeEl)continue;if(!this._nearViewport(el))continue;let lines=NaN,chars=NaN;const wrap=el.closest('.code-wrapper');if(wrap){const nlAttr=wrap.getAttribute('data-code-nl');const lenAttr=wrap.getAttribute('data-code-len');if(nlAttr)lines=parseInt(nlAttr,10);if(lenAttr)chars=parseInt(lenAttr,10);}
if((Number.isFinite(lines)&&lines>maxLines)||(Number.isFinite(chars)&&chars>maxChars))continue;try{if(window.hljs){hljs.highlightElement(el);el.setAttribute('data-highlighted','yes');this.codeScroll.attachHandlers(el);}}catch(_){}
done++;if((Utils.now()-start)>=options.budgetMs)break;}
if(done)this._d('micro.now',{done});}
safeHighlight(codeEl,activeEl){if(this.isDisabled())return;if(!window.hljs||!codeEl||!codeEl.isConnected)return;if(!codeEl.closest('.msg-box.msg-bot'))return;if(codeEl.getAttribute('data-highlighted')==='yes')return;if(activeEl&&codeEl===activeEl)return;try{const wrap=codeEl.closest('.code-wrapper');const maxLines=this.cfg.PROFILE_CODE.finalHighlightMaxLines|0;const maxChars=this.cfg.PROFILE_CODE.finalHighlightMaxChars|0;let lines=NaN,chars=NaN;if(wrap){const nlAttr=wrap.getAttribute('data-code-nl');const lenAttr=wrap.getAttribute('data-code-len');if(nlAttr)lines=parseInt(nlAttr,10);if(lenAttr)chars=parseInt(lenAttr,10);}
if((Number.isFinite(lines)&&maxLines>0&&lines>maxLines)||(Number.isFinite(chars)&&maxChars>0&&chars>maxChars)){codeEl.classList.add('hljs');codeEl.setAttribute('data-highlighted','yes');codeEl.dataset.finalHlSkip='1';try{this.codeScroll.attachHandlers(codeEl);}catch(_){}
this.codeScroll.scheduleScroll(codeEl,false,false);this._d('hl.skip.size',{lines,chars,maxLines,maxChars});return;}}catch(_){}
const wasNearBottom=this.codeScroll.isNearBottomEl(codeEl,16);const st=this.codeScroll.state(codeEl);const shouldAutoScrollAfter=(st.autoFollow===true)||wasNearBottom;try{hljs.highlightElement(codeEl);codeEl.setAttribute('data-highlighted','yes');}catch(_){if(!codeEl.classList.contains('hljs'))codeEl.classList.add('hljs');}finally{try{this.codeScroll.attachHandlers(codeEl);}catch(_){}
const needInitForce=(codeEl.dataset&&(codeEl.dataset.csInitBtm==='1'||codeEl.dataset.justFinalized==='1'));const mustScroll=shouldAutoScrollAfter||needInitForce;if(mustScroll)this.codeScroll.scheduleScroll(codeEl,false,!!needInitForce);this.codeScroll.detachHandlers(codeEl);if(codeEl.dataset){if(codeEl.dataset.csInitBtm==='1')codeEl.dataset.csInitBtm='0';if(codeEl.dataset.justFinalized==='1')codeEl.dataset.justFinalized='0';}
this._d('hl.done',{autoScroll:mustScroll});}}
_startGlobalScan(activeCode){if(this.isDisabled())return;this._activeCodeEl=(activeCode&&activeCode.codeEl)?activeCode.codeEl:this._activeCodeEl;const preload=this.cfg.SCAN_PRELOAD_PX||this.cfg.SCAN.PRELOAD_PX;const vh=window.innerHeight||Utils.SE.clientHeight||800;const rectTop=0-preload,rectBottom=vh+preload;const nodes=document.querySelectorAll('.msg-box.msg-bot pre code:not([data-highlighted="yes"])');this._globalScanState={nodes,idx:0,rectTop,rectBottom,activeCodeEl:this._activeCodeEl||null};this._d('scan.start',{candidates:nodes.length});this._scanGlobalStep();}
_scanGlobalStep(){const state=this._globalScanState;if(!state||!state.nodes||state.idx>=state.nodes.length){this._globalScanState=null;this._d('scan.done',{});return;}
const start=Utils.now();while(state.idx<state.nodes.length){const code=state.nodes[state.idx++];if(!code||!code.isConnected)continue;if(state.activeCodeEl&&code===state.activeCodeEl)continue;try{const r=code.getBoundingClientRect();if(r.bottom>=state.rectTop&&r.top<=state.rectBottom)this.queue(code,null);}catch(_){}
if((Utils.now()-start)>=this.SCAN_STEP_BUDGET_MS){this.raf.schedule('HL:scanStep',()=>this._scanGlobalStep(),'Highlighter',2);return;}}
this._globalScanState=null;this._d('scan.step.end',{});}
observeNewCode(root,opts,activeCode){const scope=root||document;let nodes;if(scope.nodeType===1&&scope.closest&&scope.closest('.msg-box.msg-bot'))nodes=scope.querySelectorAll('pre code');else nodes=document.querySelectorAll('.msg-box.msg-bot pre code');if(!nodes||!nodes.length)return;const options=Object.assign({deferLastIfStreaming:false,minLinesForLast:2,minCharsForLast:120},(opts||{}));nodes.forEach((code)=>{if(!code.closest('.msg-box.msg-bot'))return;this.codeScroll.attachHandlers(code);if(this.isDisabled())return;if(activeCode&&code===activeCode.codeEl)return;if(options.deferLastIfStreaming&&activeCode&&code===activeCode.codeEl){const tailLen=(activeCode.tailEl&&activeCode.tailEl.textContent)?activeCode.tailEl.textContent.length:0;const tailLines=(typeof activeCode.tailLines==='number')?activeCode.tailLines:0;if(tailLines<options.minLinesForLast&&tailLen<options.minCharsForLast)return;}
if(this._nearViewport(code))this.queue(code,activeCode);});this._d('observe.codes',{count:nodes.length});}
scheduleScanVisibleCodes(activeCode){if(this.isDisabled())return;try{const anyCandidate=document.querySelector('.msg-box.msg-bot pre code:not([data-highlighted="yes"])');const hasActive=!!(activeCode&&activeCode.codeEl&&activeCode.codeEl.isConnected);if(!anyCandidate&&!hasActive)return;}catch(_){}
this._activeCodeEl=(activeCode&&activeCode.codeEl)?activeCode.codeEl:this._activeCodeEl;if(this._globalScanState){this.raf.schedule('HL:scanStep',()=>this._scanGlobalStep(),'Highlighter',2);return;}
if(this.scanScheduled)return;this.scanScheduled=true;this.raf.schedule('HL:scan',()=>{this.scanScheduled=false;this._startGlobalScan(activeCode||null);},'Highlighter',2);this._d('scan.scheduled',{});}
scanVisibleCodes(activeCode){this._startGlobalScan(activeCode||null);}
scanVisibleCodesInRoot(root,activeCode){if(this.isDisabled())return;const preload=this.cfg.SCAN_PRELOAD_PX||this.cfg.SCAN.PRELOAD_PX;const vh=window.innerHeight||Utils.SE.clientHeight||800;const rectTop=0-preload,rectBottom=vh+preload;const scope=root||document;const nodes=scope.querySelectorAll('.msg-box.msg-bot pre code:not([data-highlighted="yes"])');nodes.forEach((code)=>{if(!code.isConnected)return;if(activeCode&&code===activeCode.codeEl)return;const r=code.getBoundingClientRect();if(r.bottom>=rectTop&&r.top<=rectBottom)this.queue(code,activeCode);});this._d('scan.root',{count:nodes.length});}
installBoxObserver(){}
observeMsgBoxes(root,onBoxIntersect){const scope=root||document;let boxes;if(scope.nodeType===1)boxes=scope.querySelectorAll('.msg-box.msg-bot');else boxes=document.querySelectorAll('.msg-box.msg-bot');boxes.forEach((box)=>{onBoxIntersect&&onBoxIntersect(box);});this._d('observe.boxes',{count:boxes.length});}
cleanup(){try{this.raf.cancelGroup('Highlighter');}catch(_){}
this.hlScheduled=false;this.scanScheduled=false;this._globalScanState=null;this._activeCodeEl=null;this.hlQueueSet.clear();this.hlQueue.length=0;this._d('cleanup',{});}};

/* data/js/app/logger.js */
class Logger{constructor(cfg){this.cfg=cfg||{LOG:{}};this.queue=[];this.queueBytes=0;this.armed=false;this.maxTries=480;this.tries=0;this.bridge=null;this._idleId=0;this._lastFlushQueueBytes=0;this.raf=null;this._rafScheduled=false;this._rafKey={t:'Logger:tick'};const L=this.cfg.LOG||{};this.MAX_QUEUE=Utils.g('LOG_MAX_QUEUE',L.MAX_QUEUE??400);this.MAX_BYTES=Utils.g('LOG_MAX_BYTES',L.MAX_BYTES??256*1024);this.BATCH_MAX=Utils.g('LOG_BATCH_MAX',L.BATCH_MAX??64);this.RATE_LIMIT_PER_SEC=Utils.g('LOG_RATE_LIMIT_PER_SEC',L.RATE_LIMIT_PER_SEC??0);this._rlWindowMs=1000;this._rlCount=0;this._rlWindowStart=Utils.now();}
bindBridge(bridge){this.bridge=bridge||null;this.flush();}
bindRaf(raf){this.raf=raf||null;}
isEnabled(ns){if(!ns)return!!(window.STREAM_DEBUG||window.MD_LANG_DEBUG);const key1=ns+'_DEBUG';const key2=ns.toUpperCase()+'_DEBUG';return!!(window[key1]||window[key2]||window.STREAM_DEBUG||window.MD_LANG_DEBUG);}
pv(s,n=120){if(!s)return'';s=String(s);if(s.length<=n)return s.replace(/\n/g,'\\n');const k=Math.floor(n/2);return(s.slice(0,k)+' … '+s.slice(-k)).replace(/\n/g,'\\n');}
j(o){try{return JSON.stringify(o);}catch(_){try{return String(o);}catch(__){return'[unserializable]';}}}
_emit(msg){try{if(this.bridge){if(typeof this.bridge.log_batch==='function'){this.bridge.log_batch([String(msg)]);return true;}
if(typeof this.bridge.logBatch==='function'){this.bridge.logBatch([String(msg)]);return true;}
if(typeof this.bridge.log==='function'){this.bridge.log(String(msg));return true;}}
if(window.runtime&&runtime.bridge&&typeof runtime.bridge.log==='function'){runtime.bridge.log(String(msg));return true;}}catch(_){}
return false;}
_emitBatch(arr){try{if(!arr||!arr.length)return 0;if(this.bridge&&typeof this.bridge.log_batch==='function'){this.bridge.log_batch(arr.map(String));return arr.length;}
if(this.bridge&&typeof this.bridge.logBatch==='function'){this.bridge.logBatch(arr.map(String));return arr.length;}
if(this.bridge&&typeof this.bridge.log==='function'){for(let i=0;i<arr.length;i++)this.bridge.log(String(arr[i]));return arr.length;}}catch(_){}
return 0;}
_maybeDropForCaps(len){if(this.queue.length<=this.MAX_QUEUE&&this.queueBytes<=this.MAX_BYTES)return;const targetLen=Math.floor(this.MAX_QUEUE*0.8);const targetBytes=Math.floor(this.MAX_BYTES*0.8);while((this.queue.length>targetLen||this.queueBytes>targetBytes)&&this.queue.length){const removed=this.queue.shift();this.queueBytes-=(removed?removed.length*2:0);}
const notice='[LOGGER] queue trimmed due to caps';this.queue.unshift(notice);this.queueBytes+=notice.length*2;}
_passRateLimit(){if(!this.RATE_LIMIT_PER_SEC||this.RATE_LIMIT_PER_SEC<=0)return true;const now=Utils.now();if(now-this._rlWindowStart>this._rlWindowMs){this._rlWindowStart=now;this._rlCount=0;}
if(this._rlCount>=this.RATE_LIMIT_PER_SEC)return false;return true;}
log(text){const msg=String(text);if(this.bridge&&(typeof this.bridge.log==='function'||typeof this.bridge.log_batch==='function'||typeof this.bridge.logBatch==='function')){if(this._passRateLimit()){const ok=this._emit(msg);if(ok)return true;}}
this.queue.push(msg);this.queueBytes+=msg.length*2;this._maybeDropForCaps(msg.length);this._arm();return false;}
debug(ns,line,ctx){if(!this.isEnabled(ns))return false;let msg=`[${ns}] ${line || ''}`;if(typeof ctx!=='undefined')msg+=' '+this.j(ctx);return this.log(msg);}
debug_obj(ns,tag,data){try{const lg=this.logger||(this.cfg&&this.cfg.logger)||(window.runtime&&runtime.logger)||null;if(!this.isEnabled(ns))return false;const safeJson=(v)=>{try{const seen=new WeakSet();const s=JSON.stringify(v,(k,val)=>{if(typeof val==='object'&&val!==null){if(val.nodeType){const nm=(val.nodeName||val.tagName||'DOM').toString();return`[DOM ${nm}]`;}
if(seen.has(val))return'[Circular]';seen.add(val);}
if(typeof val==='string'&&val.length>800)return val.slice(0,800)+'…';return val;});return s;}catch(_){try{return String(v);}catch{return'';}}};let line=String(tag||'');if(typeof data!=='undefined'){const payload=safeJson(data);if(payload&&payload!=='""')line+=' '+payload;}
this.debug(ns,line);}catch(_){}}
flush(maxPerTick=this.BATCH_MAX){if(!this.bridge&&!(window.runtime&&runtime.bridge&&typeof runtime.bridge.log==='function'))return 0;const n=Math.min(maxPerTick,this.queue.length);if(!n)return 0;const batch=this.queue.splice(0,n);let bytes=0;for(let i=0;i<batch.length;i++)bytes+=batch[i].length*2;this.queueBytes=Math.max(0,this.queueBytes-bytes);const sent=this._emitBatch(batch);if(sent<batch.length){const remain=batch.slice(sent);let remBytes=0;for(let i=0;i<remain.length;i++)remBytes+=remain[i].length*2;for(let i=remain.length-1;i>=0;i--)this.queue.unshift(remain[i]);this.queueBytes+=remBytes;}
return sent;}
_scheduleTick(tick){const preferIdle=!this.bridge;const scheduleIdle=()=>{try{if(this._idleId)Utils.cancelIdle(this._idleId);}catch(_){}
this._idleId=Utils.idle(()=>{this._idleId=0;tick();},800);};if(preferIdle){scheduleIdle();return;}
if(this._rafScheduled)return;this._rafScheduled=true;const run=()=>{this._rafScheduled=false;tick();};try{if(this.raf&&typeof this.raf.schedule==='function'){this.raf.schedule(this._rafKey,run,'Logger',3);}else if(typeof runtime!=='undefined'&&runtime.raf&&typeof runtime.raf.schedule==='function'){runtime.raf.schedule(this._rafKey,run,'Logger',3);}else{Promise.resolve().then(run);}}catch(_){Promise.resolve().then(run);}}
_arm(){if(this.armed)return;this.armed=true;this.tries=0;const tick=()=>{if(!this.armed)return;this.flush();this.tries++;if(this.queue.length===0||this.tries>this.maxTries){this.armed=false;try{if(this._idleId)Utils.cancelIdle(this._idleId);}catch(_){}
this._idleId=0;return;}
this._scheduleTick(tick);};this._scheduleTick(tick);}};

/* data/js/app/markdown.js */
class MarkdownRenderer{constructor(cfg,customMarkup,logger,asyncer,raf){this.cfg=cfg;this.customMarkup=customMarkup;this.MD=null;this.logger=logger||new Logger(cfg);this.asyncer=asyncer||new AsyncRunner(cfg,raf);this.raf=raf||null;this.MD_STREAM=null;this.hooks={observeNewCode:()=>{},observeMsgBoxes:()=>{},scheduleMathRender:()=>{},codeScrollInit:()=>{}};this._codeByEnv=new WeakMap();this._codeSeq=0;this._inited=false;}
_d(tag,data){try{const lg=this.logger||(this.cfg&&this.cfg.logger)||(window.runtime&&runtime.logger)||null;if(!lg||typeof lg.debug!=='function')return;lg.debug_obj("MD",tag,data);}catch(_){}}
_regCode(env,content){if(!env)env=(this._tmpEnv||(this._tmpEnv={}));let m=this._codeByEnv.get(env);if(!m){m=new Map();this._codeByEnv.set(env,m);}
const id=`c${++this._codeSeq}`;m.set(id,content);this._d('code.reg',{id,len:(content||'').length});return id;}
_resolveCodesIn(root,env){const m=this._codeByEnv.get(env);if(!m||!root)return;let count=0;root.querySelectorAll('code[data-code-id]').forEach(el=>{const id=el.getAttribute('data-code-id');const s=m.get(id);if(s!=null){if(!el.firstChild)el.textContent=s;el.removeAttribute('data-code-id');m.delete(id);count++;}});if(count)this._d('code.resolve',{count});}
_releaseEnvCodes(env){this._codeByEnv.delete(env);}
init(){if(this._inited)return;if(!window.markdownit){this._d('init.skip',{reason:'no-markdownit'});return;}
this._inited=true;this.MD=window.markdownit({html:false,linkify:true,breaks:true,highlight:()=>''});this.MD_STREAM=window.markdownit({html:false,linkify:false,breaks:true,highlight:()=>''});const installLinkValidator=(md)=>{const orig=(md&&typeof md.validateLink==='function')?md.validateLink.bind(md):null;md.validateLink=(url)=>{try{const s=String(url||'').trim().toLowerCase();if(s.startsWith('file:'))return true;if(s.startsWith('qrc:'))return true;if(s.startsWith('bridge:'))return true;if(s.startsWith('blob:'))return true;if(s.startsWith('data:image/'))return true;}catch(_){}
return orig?orig(url):true;};};installLinkValidator(this.MD);installLinkValidator(this.MD_STREAM);if(!this.cfg.MD||this.cfg.MD.ALLOW_INDENTED_CODE!==true){try{this.MD.block.ruler.disable('code');}catch(_){}
try{this.MD_STREAM.block.ruler.disable('code');}catch(_){}}
const escapeHtml=Utils.escapeHtml;const mathDollarPlaceholderPlugin=(md)=>{function notEscaped(src,pos){let back=0;while(pos-back-1>=0&&src.charCodeAt(pos-back-1)===0x5C)back++;return(back%2)===0;}
function math_block_dollar(state,startLine,endLine,silent){const pos=state.bMarks[startLine]+state.tShift[startLine];const max=state.eMarks[startLine];if(pos+1>=max)return false;if(state.src.charCodeAt(pos)!==0x24||state.src.charCodeAt(pos+1)!==0x24)return false;let nextLine=startLine+1,found=false;for(;nextLine<endLine;nextLine++){let p=state.bMarks[nextLine]+state.tShift[nextLine];const pe=state.eMarks[nextLine];if(p+1<pe&&state.src.charCodeAt(p)===0x24&&state.src.charCodeAt(p+1)===0x24){found=true;break;}}
if(!found)return false;if(silent)return true;const contentStart=state.bMarks[startLine]+state.tShift[startLine]+2;const contentEndLine=nextLine-1;let content='';if(contentEndLine>=startLine+1){const startIdx=state.bMarks[startLine+1];const endIdx=state.eMarks[contentEndLine];content=state.src.slice(startIdx,endIdx);}
const token=state.push('math_block_dollar','',0);token.block=true;token.content=content;state.line=nextLine+1;return true;}
function math_inline_dollar(state,silent){const pos=state.pos,src=state.src,max=state.posMax;if(pos>=max)return false;if(src.charCodeAt(pos)!==0x24)return false;if(pos+1<max&&src.charCodeAt(pos+1)===0x24)return false;const after=pos+1<max?src.charCodeAt(pos+1):0;if(after===0x20||after===0x0A||after===0x0D)return false;let i=pos+1;while(i<max){const ch=src.charCodeAt(i);if(ch===0x24&&notEscaped(src,i)){const before=i-1>=0?src.charCodeAt(i-1):0;if(before===0x20||before===0x0A||before===0x0D){i++;continue;}
break;}
i++;}
if(i>=max||src.charCodeAt(i)!==0x24)return false;if(!silent){const token=state.push('math_inline_dollar','',0);token.block=false;token.content=src.slice(pos+1,i);}
state.pos=i+1;return true;}
md.block.ruler.before('fence','math_block_dollar',math_block_dollar,{alt:['paragraph','reference','blockquote','list']});md.inline.ruler.before('escape','math_inline_dollar',math_inline_dollar);md.renderer.rules.math_inline_dollar=(tokens,idx)=>{const tex=tokens[idx].content||'';return`<span class="math-pending" data-display="0"><span class="math-fallback">$${escapeHtml(tex)}$</span><script type="math/tex">${escapeHtml(tex)}</script></span>`;};md.renderer.rules.math_block_dollar=(tokens,idx)=>{const tex=tokens[idx].content||'';return`<div class="math-pending" data-display="1"><div class="math-fallback">$$${escapeHtml(tex)}$$</div><script type="math/tex; mode=display">${escapeHtml(tex)}</script></div>`;};};const mathBracketsPlaceholderPlugin=(md)=>{function math_brackets(state,silent){const src=state.src,pos=state.pos,max=state.posMax;if(pos+1>=max||src.charCodeAt(pos)!==0x5C)return false;const next=src.charCodeAt(pos+1);if(next!==0x28&&next!==0x5B)return false;const isInline=(next===0x28);const close=isInline?'\\)':'\\]';const start=pos+2;const end=src.indexOf(close,start);if(end<0)return false;const content=src.slice(start,end);if(!silent){const t=state.push(isInline?'math_inline_bracket':'math_block_bracket','',0);t.content=content;t.block=!isInline;}
state.pos=end+2;return true;}
md.inline.ruler.before('escape','math_brackets',math_brackets);md.renderer.rules.math_inline_bracket=(tokens,idx)=>{const tex=tokens[idx].content||'';return`<span class="math-pending" data-display="0"><span class="math-fallback">\\(${escapeHtml(tex)}\\)</span><script type="math/tex">${escapeHtml(tex)}</script></span>`;};md.renderer.rules.math_block_bracket=(tokens,idx)=>{const tex=tokens[idx].content||'';return`<div class="math-pending" data-display="1"><div class="math-fallback">\\${'['}${escapeHtml(tex)}\\${']'}</div><script type="math/tex; mode=display">${escapeHtml(tex)}</script></div>`;};};this.MD.use(mathDollarPlaceholderPlugin);this.MD.use(mathBracketsPlaceholderPlugin);this.MD_STREAM.use(mathDollarPlaceholderPlugin);this.MD_STREAM.use(mathBracketsPlaceholderPlugin);const cfg=this.cfg;const logger=this.logger;(function codeWrapperPlugin(md,logger,renderer){let CODE_IDX=1;const ALIAS={txt:'plaintext',text:'plaintext',plaintext:'plaintext',sh:'bash',shell:'bash',zsh:'bash','shell-session':'bash',py:'python',python3:'python',py3:'python',js:'javascript',node:'javascript',nodejs:'javascript',ts:'typescript','ts-node':'typescript',yml:'yaml',kt:'kotlin',rs:'rust',csharp:'csharp','c#':'csharp','c++':'cpp',ps:'powershell',ps1:'powershell',pwsh:'powershell',powershell7:'powershell',docker:'dockerfile'};function normLang(s){if(!s)return'';const v=String(s).trim().toLowerCase();return ALIAS[v]||v;}
function isSupportedByHLJS(lang){try{return!!(window.hljs&&hljs.getLanguage&&hljs.getLanguage(lang));}catch(_){return false;}}
function classForHighlight(lang){if(!lang)return'plaintext';return isSupportedByHLJS(lang)?lang:'plaintext';}
function stripBOM(s){return(s&&s.charCodeAt(0)===0xFEFF)?s.slice(1):s;}
function normForFP(s){if(!s)return'';let t=String(s);if(t.charCodeAt(0)===0xFEFF)t=t.slice(1);t=t.replace(/\r\n?/g,'\n');if(t.endsWith('\n'))t=t.slice(0,-1);return t;}
function hash32FNV(str){let h=0x811c9dc5>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=(h+((h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24)))>>>0;}
return('00000000'+h.toString(16)).slice(-8);}
function makeStableFP(langToken,rawContent){const norm=normForFP(rawContent||'');return`${langToken || 'plaintext'}|${norm.length}|${hash32FNV(norm)}`;}
function detectFromFirstLine(raw,rid){if(!raw)return{lang:'',content:raw,isOutput:false};const lines=raw.split(/\r?\n/);if(!lines.length)return{lang:'',content:raw,isOutput:false};let i=0;while(i<lines.length&&!lines[i].trim())i++;if(i>=lines.length)return{lang:'',content:raw,isOutput:false};let first=stripBOM(lines[i]).trim();first=first.replace(/^\s*lang(?:uage)?\s*[:=]\s*/i,'').trim();let token=first.split(/\s+/)[0].replace(/:$/,'');if(!/^[A-Za-z][\w#+\-\.]{0,30}$/.test(token))return{lang:'',content:raw,isOutput:false};let cand=normLang(token);if(cand==='output'){const content=lines.slice(i+1).join('\n');return{lang:'python',headerLabel:'output',content,isOutput:true};}
const rest=lines.slice(i+1).join('\n');if(!rest.trim())return{lang:'',content:raw,isOutput:false};return{lang:cand,headerLabel:cand,content:rest,isOutput:false};}
function resolveLanguageAndContent(info,raw,rid){const infoLangRaw=(info||'').trim().split(/\s+/)[0]||'';let cand=normLang(infoLangRaw);const shortOrUnsupported=!cand||cand.length<3||!isSupportedByHLJS(cand);if(cand==='output'){return{lang:'python',headerLabel:'output',content:raw,isOutput:true};}
if(!shortOrUnsupported){return{lang:cand,headerLabel:cand,content:raw,isOutput:false};}
const det=detectFromFirstLine(raw,rid);if(det&&(det.lang||det.isOutput))return det;return{lang:'',headerLabel:'code',content:raw,isOutput:false};}
md.renderer.rules.fence=(tokens,idx,options,env)=>renderFence(tokens[idx],env);md.renderer.rules.code_block=(tokens,idx,options,env)=>renderFence({info:'',content:tokens[idx].content||''},env);function renderFence(token,env){const rendererRef=renderer||(window.runtime&&window.runtime.renderer)||null;const raw=token.content||'';const rid=String(CODE_IDX+'');const res=resolveLanguageAndContent(token.info||'',raw,rid);const isOutput=!!res.isOutput;const rawToken=(res.lang||'').trim();const langClass=isOutput?'python':classForHighlight(rawToken);let headerLabel=isOutput?'output':(res.headerLabel||(rawToken||'code'));if(!isOutput){if(rawToken&&!isSupportedByHLJS(rawToken)&&rawToken.length<3)headerLabel='code';}
const content=res.content||'';const len=content.length;const head=content.slice(0,64);const tail=content.slice(-64);const headEsc=Utils.escapeHtml(head);const tailEsc=Utils.escapeHtml(tail);const nl=Utils.countNewlines(content);const fpStable=makeStableFP(langClass,content);const idxLocal=CODE_IDX++;let actions='';if(langClass==='html'){actions+=`<a href="empty:${idxLocal}" class="code-header-action code-header-preview"><img src="${cfg.ICONS.CODE_PREVIEW}" class="action-img" data-id="${idxLocal}"><span>${Utils.escapeHtml(cfg.LOCALE.PREVIEW)}</span></a>`;}else if(langClass==='python'&&headerLabel!=='output'){actions+=`<a href="empty:${idxLocal}" class="code-header-action code-header-run"><img src="${cfg.ICONS.CODE_RUN}" class="action-img" data-id="${idxLocal}"><span>${Utils.escapeHtml(cfg.LOCALE.RUN)}</span></a>`;}
actions+=`<a href="empty:${idxLocal}" class="code-header-action code-header-collapse" title="${Utils.escapeHtml(cfg.LOCALE.COLLAPSE)}"><img src="${cfg.ICONS.CODE_MENU}" class="action-img" data-id="${idxLocal}"></a>`;actions+=`<a href="empty:${idxLocal}" class="code-header-action code-header-copy" title="${Utils.escapeHtml(cfg.LOCALE.COPY)}"><img src="${cfg.ICONS.CODE_COPY}" class="action-img" data-id="${idxLocal}"></a>`;const canUseRegistry=!!(rendererRef&&typeof rendererRef._regCode==='function'&&env);if(canUseRegistry){const codeId=rendererRef._regCode(env,content);rendererRef._d&&rendererRef._d('fence.stream',{idxLocal,lang:langClass,headerLabel,len});return(`<div class="code-wrapper highlight" data-index="${idxLocal}"`+` data-code-lang="${Utils.escapeHtml(res.lang || '')}"`+` data-code-len="${String(len)}" data-code-head="${headEsc}" data-code-tail="${tailEsc}" data-code-nl="${String(nl)}"`+` data-fp="${Utils.escapeHtml(fpStable)}"`+` data-locale-collapse="${Utils.escapeHtml(cfg.LOCALE.COLLAPSE)}" data-locale-expand="${Utils.escapeHtml(cfg.LOCALE.EXPAND)}"`+` data-locale-copy="${Utils.escapeHtml(cfg.LOCALE.COPY)}" data-locale-copied="${Utils.escapeHtml(cfg.LOCALE.COPIED)}" data-style="${Utils.escapeHtml(cfg.CODE_STYLE)}">`+`<p class="code-header-wrapper"><span><span class="code-header-lang">${Utils.escapeHtml(headerLabel)}   </span>${actions}</span></p>`+`<pre><code class="language-${Utils.escapeHtml(langClass)} hljs" data-code-id="${String(codeId)}"></code></pre>`+`</div>`);}
rendererRef&&rendererRef._d&&rendererRef._d('fence.stream.fallback',{idxLocal,lang:langClass,len});return(`<div class="code-wrapper highlight" data-index="${idxLocal}"`+` data-code-lang="${Utils.escapeHtml(res.lang || '')}"`+` data-code-len="${String(len)}" data-code-head="${headEsc}" data-code-tail="${tailEsc}" data-code-nl="${String(nl)}"`+` data-fp="${Utils.escapeHtml(fpStable)}"`+` data-locale-collapse="${Utils.escapeHtml(cfg.LOCALE.COLLAPSE)}" data-locale-expand="${Utils.escapeHtml(cfg.LOCALE.EXPAND)}"`+` data-locale-copy="${Utils.escapeHtml(cfg.LOCALE.COPY)}" data-locale-copied="${Utils.escapeHtml(cfg.LOCALE.COPIED)}" data-style="${Utils.escapeHtml(cfg.CODE_STYLE)}">`+`<p class="code-header-wrapper"><span><span class="code-header-lang">${Utils.escapeHtml(headerLabel)}   </span>${actions}</span></p>`+`<pre><code class="language-${Utils.escapeHtml(langClass)} hljs">${Utils.escapeHtml(content)}</code></pre>`+`</div>`);}})(this.MD_STREAM,this.logger,this);(function codeWrapperPlugin(md,logger,renderer){let CODE_IDX=1;const ALIAS={txt:'plaintext',text:'plaintext',plaintext:'plaintext',sh:'bash',shell:'bash',zsh:'bash','shell-session':'bash',py:'python',python3:'python',py3:'python',js:'javascript',node:'javascript',nodejs:'javascript',ts:'typescript','ts-node':'typescript',yml:'yaml',kt:'kotlin',rs:'rust',csharp:'csharp','c#':'csharp','c++':'cpp',ps:'powershell',ps1:'powershell',pwsh:'powershell',powershell7:'powershell',docker:'dockerfile'};function normLang(s){if(!s)return'';const v=String(s).trim().toLowerCase();return ALIAS[v]||v;}
function isSupportedByHLJS(lang){try{return!!(window.hljs&&hljs.getLanguage&&hljs.getLanguage(lang));}catch(_){return false;}}
function classForHighlight(lang){if(!lang)return'plaintext';return isSupportedByHLJS(lang)?lang:'plaintext';}
function stripBOM(s){return(s&&s.charCodeAt(0)===0xFEFF)?s.slice(1):s;}
function normForFP(s){if(!s)return'';let t=String(s);if(t.charCodeAt(0)===0xFEFF)t=t.slice(1);t=t.replace(/\r\n?/g,'\n');if(t.endsWith('\n'))t=t.slice(0,-1);return t;}
function hash32FNV(str){let h=0x811c9dc5>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=(h+((h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24)))>>>0;}
return('00000000'+h.toString(16)).slice(-8);}
function makeStableFP(langToken,rawContent){const norm=normForFP(rawContent||'');return`${langToken || 'plaintext'}|${norm.length}|${hash32FNV(norm)}`;}
function detectFromFirstLine(raw,rid){if(!raw)return{lang:'',content:raw,isOutput:false};const lines=raw.split(/\r?\n/);if(!lines.length)return{lang:'',content:raw,isOutput:false};let i=0;while(i<lines.length&&!lines[i].trim())i++;if(i>=lines.length)return{lang:'',content:raw,isOutput:false};let first=stripBOM(lines[i]).trim();first=first.replace(/^\s*lang(?:uage)?\s*[:=]\s*/i,'').trim();let token=first.split(/\s+/)[0].replace(/:$/,'');if(!/^[A-Za-z][\w#+\-\.]{0,30}$/.test(token))return{lang:'',content:raw,isOutput:false};let cand=normLang(token);if(cand==='output'){const content=lines.slice(i+1).join('\n');return{lang:'python',headerLabel:'output',content,isOutput:true};}
const rest=lines.slice(i+1).join('\n');if(!rest.trim())return{lang:'',content:raw,isOutput:false};return{lang:cand,headerLabel:cand,content:rest,isOutput:false};}
function resolveLanguageAndContent(info,raw,rid){const infoLangRaw=(info||'').trim().split(/\s+/)[0]||'';let cand=normLang(infoLangRaw);const shortOrUnsupported=!cand||cand.length<3||!isSupportedByHLJS(cand);if(cand==='output'){return{lang:'python',headerLabel:'output',content:raw,isOutput:true};}
if(!shortOrUnsupported){return{lang:cand,headerLabel:cand,content:raw,isOutput:false};}
const det=detectFromFirstLine(raw,rid);if(det&&(det.lang||det.isOutput))return det;return{lang:'',headerLabel:'code',content:raw,isOutput:false};}
md.renderer.rules.fence=(tokens,idx,options,env,slf)=>renderFence(tokens[idx],env);md.renderer.rules.code_block=(tokens,idx,options,env,slf)=>renderFence({info:'',content:tokens[idx].content||''},env);function renderFence(token,env){const rendererRef=renderer||(window.runtime&&window.runtime.renderer)||null;const raw=token.content||'';const rid=String(CODE_IDX+'');const res=resolveLanguageAndContent(token.info||'',raw,rid);const isOutput=!!res.isOutput;const rawToken=(res.lang||'').trim();const langClass=isOutput?'python':classForHighlight(rawToken);let headerLabel=isOutput?'output':(res.headerLabel||(rawToken||'code'));if(!isOutput){if(rawToken&&!isSupportedByHLJS(rawToken)&&rawToken.length<3)headerLabel='code';}
const content=res.content||'';const len=content.length;const head=content.slice(0,64);const tail=content.slice(-64);const headEsc=Utils.escapeHtml(head);const tailEsc=Utils.escapeHtml(tail);const nl=Utils.countNewlines(content);const fpStable=makeStableFP(langClass,content);const idxLocal=CODE_IDX++;let actions='';if(langClass==='html'){actions+=`<a href="empty:${idxLocal}" class="code-header-action code-header-preview"><img src="${cfg.ICONS.CODE_PREVIEW}" class="action-img" data-id="${idxLocal}"><span>${Utils.escapeHtml(cfg.LOCALE.PREVIEW)}</span></a>`;}else if(langClass==='python'&&headerLabel!=='output'){actions+=`<a href="empty:${idxLocal}" class="code-header-action code-header-run"><img src="${cfg.ICONS.CODE_RUN}" class="action-img" data-id="${idxLocal}"><span>${Utils.escapeHtml(cfg.LOCALE.RUN)}</span></a>`;}
actions+=`<a href="empty:${idxLocal}" class="code-header-action code-header-collapse" title="${Utils.escapeHtml(cfg.LOCALE.COLLAPSE)}"><img src="${cfg.ICONS.CODE_MENU}" class="action-img" data-id="${idxLocal}"></a>`;actions+=`<a href="empty:${idxLocal}" class="code-header-action code-header-copy" title="${Utils.escapeHtml(cfg.LOCALE.COPY)}"><img src="${cfg.ICONS.CODE_COPY}" class="action-img" data-id="${idxLocal}"></a>`;const canUseRegistry=!!(rendererRef&&typeof rendererRef._regCode==='function'&&env);if(canUseRegistry){const codeId=rendererRef._regCode(env,content);rendererRef._d&&rendererRef._d('fence.full',{idxLocal,lang:langClass,headerLabel,len});return(`<div class="code-wrapper highlight" data-index="${idxLocal}"`+` data-code-lang="${Utils.escapeHtml(res.lang || '')}"`+` data-code-len="${String(len)}" data-code-head="${headEsc}" data-code-tail="${tailEsc}" data-code-nl="${String(nl)}" data-fp="${Utils.escapeHtml(fpStable)}"`+` data-locale-collapse="${Utils.escapeHtml(cfg.LOCALE.COLLAPSE)}" data-locale-expand="${Utils.escapeHtml(cfg.LOCALE.EXPAND)}"`+` data-locale-copy="${Utils.escapeHtml(cfg.LOCALE.COPY)}" data-locale-copied="${Utils.escapeHtml(cfg.LOCALE.COPIED)}" data-style="${Utils.escapeHtml(cfg.CODE_STYLE)}">`+`<p class="code-header-wrapper"><span><span class="code-header-lang">${Utils.escapeHtml(headerLabel)}   </span>${actions}</span></p>`+`<pre><code class="language-${Utils.escapeHtml(langClass)} hljs" data-code-id="${String(codeId)}"></code></pre>`+`</div>`);}
rendererRef&&rendererRef._d&&rendererRef._d('fence.full.fallback',{idxLocal,lang:langClass,len});const inner=Utils.escapeHtml(content);return(`<div class="code-wrapper highlight" data-index="${idxLocal}"`+` data-code-lang="${Utils.escapeHtml(res.lang || '')}"`+` data-code-len="${String(len)}" data-code-head="${headEsc}" data-code-tail="${tailEsc}" data-code-nl="${String(nl)}" data-fp="${Utils.escapeHtml(fpStable)}"`+` data-locale-collapse="${Utils.escapeHtml(cfg.LOCALE.COLLAPSE)}" data-locale-expand="${Utils.escapeHtml(cfg.LOCALE.EXPAND)}"`+` data-locale-copy="${Utils.escapeHtml(cfg.LOCALE.COPY)}" data-locale-copied="${Utils.escapeHtml(cfg.LOCALE.COPIED)}" data-style="${Utils.escapeHtml(cfg.CODE_STYLE)}">`+`<p class="code-header-wrapper"><span><span class="code-header-lang">${Utils.escapeHtml(headerLabel)}   </span>${actions}</span></p>`+`<pre><code class="language-${Utils.escapeHtml(langClass)} hljs">${inner}</code></pre>`+`</div>`);}})(this.MD,this.logger,this);this._d('init.done',{});}
preprocessMD(s){const out=(s||'').replace(/\]\(sandbox:/g,'](file://');if(out!==s)this._d('md.preprocess',{replaced:true});return out;}
b64ToUtf8(b64){const bin=atob(b64);const bytes=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)bytes[i]=bin.charCodeAt(i);return Utils.utf8Decode(bytes);}
applyCustomMarkupForBots(root){const MD=this.MD;try{const scope=root||document;const targets=[];if(scope&&scope.nodeType===1&&scope.classList&&scope.classList.contains('msg-box')&&scope.classList.contains('msg-bot')){targets.push(scope);}
if(scope&&typeof scope.querySelectorAll==='function'){const list=scope.querySelectorAll('.msg-box.msg-bot');for(let i=0;i<list.length;i++)targets.push(list[i]);}
if(scope&&scope.nodeType===1&&typeof scope.closest==='function'){const closestMsg=scope.closest('.msg-box.msg-bot');if(closestMsg)targets.push(closestMsg);}
const seen=new Set();for(const el of targets){if(!el||!el.isConnected||seen.has(el))continue;seen.add(el);this.customMarkup.apply(el,MD);}
this._d('cm.applyBots',{count:seen.size});}catch(_){}}
_md(streamingHint){return streamingHint?(this.MD_STREAM||this.MD):(this.MD||this.MD_STREAM);}
async renderPendingMarkdown(root){const MD=this.MD;if(!MD)return;const scope=root||document;const nodes=Array.from(scope.querySelectorAll('[data-md64], [md-block-markdown]'));if(nodes.length===0){try{const hasBots=!!(scope&&scope.querySelector&&scope.querySelector('.msg-box.msg-bot'));const hasWrappers=!!(scope&&scope.querySelector&&scope.querySelector('.code-wrapper'));const hasCodes=!!(scope&&scope.querySelector&&scope.querySelector('.msg-box.msg-bot pre code'));const hasUnhighlighted=!!(scope&&scope.querySelector&&scope.querySelector('.msg-box.msg-bot pre code:not([data-highlighted="yes"])'));const hasMath=!!(scope&&scope.querySelector&&scope.querySelector('script[type^="math/tex"]'));if(hasBots)this.applyCustomMarkupForBots(scope);if(hasWrappers)this.restoreCollapsedCode(scope);this.hooks.codeScrollInit(scope);if(hasCodes){this.hooks.observeMsgBoxes(scope);this.hooks.observeNewCode(scope,{deferLastIfStreaming:true,minLinesForLast:this.cfg.PROFILE_CODE.minLinesForHL,minCharsForLast:this.cfg.PROFILE_CODE.minCharsForHL});if(hasUnhighlighted&&typeof runtime!=='undefined'&&runtime.highlighter){runtime.highlighter.scanVisibleCodesInRoot(scope,runtime.stream.activeCode||null);}}
if(hasMath)this.hooks.scheduleMathRender(scope);}catch(_){}
return;}
this._d('md.pending.start',{nodes:nodes.length});const touchedBoxes=new Set();const perSlice=(this.cfg.ASYNC&&this.cfg.ASYNC.MD_NODES_PER_SLICE)||12;let sliceCount=0;let startedAt=Utils.now();for(let j=0;j<nodes.length;j++){const el=nodes[j];if(!el||!el.isConnected)continue;let md='';const isNative=el.hasAttribute('md-block-markdown');const msgBox=(el.closest&&el.closest('.msg-box.msg-bot, .msg-box.msg-user'))||null;const isUserMsg=!!(msgBox&&msgBox.classList.contains('msg-user'));const isBotMsg=!!(msgBox&&msgBox.classList.contains('msg-bot'));if(isNative){try{md=isUserMsg?(el.textContent||''):this.preprocessMD(el.textContent||'');}catch(_){md='';}
try{el.removeAttribute('md-block-markdown');}catch(_){}}else{const b64=el.getAttribute('data-md64');if(!b64)continue;try{md=this.b64ToUtf8(b64);}catch(_){md='';}
el.removeAttribute('data-md64');if(!isUserMsg){try{md=this.preprocessMD(md);}catch(_){}}}
if(isUserMsg){const span=document.createElement('span');span.textContent=md;el.replaceWith(span);}else if(isBotMsg){let html='';const env={__box:msgBox};try{let src=md;if(this.customMarkup&&typeof this.customMarkup.transformSource==='function'){src=this.customMarkup.transformSource(src,{streaming:false});}
html=this.MD.render(src,env);}catch(_){html=Utils.escapeHtml(md);}
const tpl=document.createElement('template');tpl.innerHTML=html;const frag=tpl.content;try{this._resolveCodesIn(frag,env);this._releaseEnvCodes(env);}catch(_){}
el.replaceWith(frag);touchedBoxes.add(msgBox);}else{const span=document.createElement('span');span.textContent=md;el.replaceWith(span);}
sliceCount++;if(sliceCount>=perSlice||this.asyncer.shouldYield(startedAt)){await this.asyncer.yield();startedAt=Utils.now();sliceCount=0;}}
try{touchedBoxes.forEach(box=>{try{this.customMarkup.apply(box,this.MD);}catch(_){}});}catch(_){}
this.restoreCollapsedCode(scope);this.hooks.observeNewCode(scope,{deferLastIfStreaming:true,minLinesForLast:this.cfg.PROFILE_CODE.minLinesForHL,minCharsForLast:this.cfg.PROFILE_CODE.minCharsForHL});this.hooks.observeMsgBoxes(scope);this.hooks.scheduleMathRender(scope);this.hooks.codeScrollInit(scope);if(typeof runtime!=='undefined'&&runtime.highlighter){runtime.highlighter.scanVisibleCodesInRoot(scope,runtime.stream.activeCode||null);}
this._d('md.pending.end',{boxes:touchedBoxes.size});}
renderStreamingSnapshot(src){const md=this._md(true);if(!md)return'';try{let s=String(src||'');if(this.customMarkup&&typeof this.customMarkup.transformSource==='function'){s=this.customMarkup.transformSource(s,{streaming:true});}
return md.render(s,{});}catch(_){return Utils.escapeHtml(src);}}
renderStreamingSnapshotFragment(src){const md=this._md(true);if(!md){const tpl0=document.createElement('template');tpl0.innerHTML='';return tpl0.content;}
let html='';const env={};try{let s=String(src||'');if(this.customMarkup&&typeof this.customMarkup.transformSource==='function'){s=this.customMarkup.transformSource(s,{streaming:true});}
html=md.render(s,env);}catch(_){html=Utils.escapeHtml(src||'');}
const tpl=document.createElement('template');tpl.innerHTML=html;const frag=tpl.content;try{this._resolveCodesIn(frag,env);this._releaseEnvCodes(env);}catch(_){}
this._d('md.render.stream.frag',{srcLen:(src||'').length,htmlLen:html.length});return frag;}
renderInlineStreaming(src){const md=this._md(true);if(!md||typeof md.renderInline!=='function')return Utils.escapeHtml(src||'');try{const s=String(src||'');return md.renderInline(s);}catch(_){return Utils.escapeHtml(src||'');}}
renderFinalSnapshot(src){const md=this._md(false);if(!md)return'';try{let s=String(src||'');if(this.customMarkup&&typeof this.customMarkup.transformSource==='function'){s=this.customMarkup.transformSource(s,{streaming:false});}
return md.render(s);}catch(_){return Utils.escapeHtml(src);}}
renderFinalSnapshotFragment(src){const md=this._md(false);if(!md){const tpl0=document.createElement('template');tpl0.innerHTML='';return tpl0.content;}
let html='';const env={};try{let s=String(src||'');if(this.customMarkup&&typeof this.customMarkup.transformSource==='function'){s=this.customMarkup.transformSource(s,{streaming:false});}
html=md.render(s,env);}catch(_){html=Utils.escapeHtml(src);}
const tpl=document.createElement('template');tpl.innerHTML=html;const frag=tpl.content;try{this._resolveCodesIn(frag,env);this._releaseEnvCodes(env);}catch(_){}
this._d('md.render.final.frag',{srcLen:(src||'').length,htmlLen:html.length});return frag;}
restoreCollapsedCode(root){const scope=root||document;const wrappers=scope.querySelectorAll('.code-wrapper');wrappers.forEach((wrapper)=>{const index=wrapper.getAttribute('data-index');const localeCollapse=wrapper.getAttribute('data-locale-collapse');const localeExpand=wrapper.getAttribute('data-locale-expand');const source=wrapper.querySelector('code');const isCollapsed=(window.__collapsed_idx||[]).includes(index);if(!source)return;const btn=wrapper.querySelector('.code-header-collapse');if(isCollapsed){source.style.display='none';if(btn){const span=btn.querySelector('span');if(span)span.textContent=localeExpand;btn.setAttribute('title',localeExpand||'Expand');}}else{source.style.display='block';if(btn){const span=btn.querySelector('span');if(span)span.textContent=localeCollapse;btn.setAttribute('title',localeCollapse||'Collapse');}}});}};

/* data/js/app/math.js */
class MathRenderer{constructor(cfg,raf,asyncer){this.cfg=cfg;this.raf=raf;this.asyncer=asyncer;this.scheduled=false;this.rafKey={t:'Math:render'};this._pendingRoots=new Set();this._pendingDoc=false;}
async renderAsync(root){if(typeof katex==='undefined')return;const scope=root||document;const scripts=Array.from(scope.querySelectorAll('script[type^="math/tex"]'));const useToString=(typeof katex.renderToString==='function');const batchFn=async(script)=>{if(!script||!script.isConnected)return;if(!script.closest('.msg-box.msg-bot'))return;const t=script.getAttribute('type')||'';const displayMode=t.indexOf('mode=display')>-1;const mathContent=script.textContent||'';const parent=script.parentNode;if(!parent)return;try{if(useToString){let html='';try{html=katex.renderToString(mathContent,{displayMode,throwOnError:false});}catch(_){const fb=displayMode?`\\[${mathContent}\\]`:`\\(${mathContent}\\)`;html=(displayMode?`<div>${Utils.escapeHtml(fb)}</div>`:`<span>${Utils.escapeHtml(fb)}</span>`);}
const host=document.createElement(displayMode?'div':'span');host.innerHTML=html;const el=host.firstElementChild||host;if(parent.classList&&parent.classList.contains('math-pending'))parent.replaceWith(el);else parent.replaceChild(el,script);}else{const el=document.createElement(displayMode?'div':'span');try{katex.render(mathContent,el,{displayMode,throwOnError:false});}catch(_){el.textContent=(displayMode?`\\[${mathContent}\\]`:`\\(${mathContent}\\)`);}
if(parent.classList&&parent.classList.contains('math-pending'))parent.replaceWith(el);else parent.replaceChild(el,script);}}catch(_){}};await this.asyncer.forEachChunk(scripts,batchFn,'MathRenderer');}
schedule(root,_delayIgnored=0,forceNow=false){if(typeof katex==='undefined')return;const targetRoot=root||document;let hasMath=true;if(!forceNow){try{hasMath=!!(targetRoot&&targetRoot.querySelector&&targetRoot.querySelector('script[type^="math/tex"]'));}catch(_){hasMath=false;}
if(!hasMath)return;}
if(targetRoot===document||targetRoot===document.documentElement||targetRoot===document.body){this._pendingDoc=true;this._pendingRoots.clear();}else if(!this._pendingDoc){this._pendingRoots.add(targetRoot);}
if(this.scheduled&&this.raf&&typeof this.raf.isScheduled==='function'&&this.raf.isScheduled(this.rafKey))return;this.scheduled=true;const priority=forceNow?0:2;this.raf.schedule(this.rafKey,()=>{this.scheduled=false;const useDoc=this._pendingDoc;const roots=[];if(useDoc){roots.push(document);}else{this._pendingRoots.forEach((r)=>{try{if(r&&(r.isConnected===undefined||r.isConnected))roots.push(r);}catch(_){roots.push(r);}});}
this._pendingDoc=false;this._pendingRoots.clear();(async()=>{for(let i=0;i<roots.length;i++){try{await this.renderAsync(roots[i]);}catch(_){}}})();},'Math',priority);}
cleanup(){try{this.raf.cancelGroup('Math');}catch(_){}
this.scheduled=false;try{this._pendingRoots.clear();}catch(_){}
this._pendingDoc=false;}};

/* data/js/app/nodes.js */
class NodesManager{constructor(dom,renderer,highlighter,math){this.dom=dom;this.renderer=renderer;this.highlighter=highlighter;this.math=math;this._userCollapse=new UserCollapseManager(this.renderer.cfg);}
_isUserOnlyContent(html){try{const tmp=document.createElement('div');tmp.innerHTML=html;const hasBot=!!tmp.querySelector('.msg-box.msg-bot');const hasUser=!!tmp.querySelector('.msg-box.msg-user');const hasMD64=!!tmp.querySelector('[data-md64]');const hasMDNative=!!tmp.querySelector('[md-block-markdown]');const hasCode=!!tmp.querySelector('pre code');const hasMath=!!tmp.querySelector('script[type^="math/tex"]');return hasUser&&!hasBot&&!hasMD64&&!hasMDNative&&!hasCode&&!hasMath;}catch(_){return false;}}
_materializeUserMdAsPlainText(scopeEl){try{const nodes=scopeEl.querySelectorAll('.msg-box.msg-user [data-md64], .msg-box.msg-user [md-block-markdown]');nodes.forEach(el=>{let txt='';if(el.hasAttribute('data-md64')){const b64=el.getAttribute('data-md64')||'';el.removeAttribute('data-md64');try{txt=this.renderer.b64ToUtf8(b64);}catch(_){txt='';}}else{try{txt=el.textContent||'';}catch(_){txt='';}
try{el.removeAttribute('md-block-markdown');}catch(_){}}
const span=document.createElement('span');span.textContent=txt;el.replaceWith(span);});}catch(_){}}
_ensureUserCopyIcons(root){try{const scope=root||document;const cfg=(this.renderer&&this.renderer.cfg)||{};const I=cfg.ICONS||{};const L=cfg.LOCALE||{};const copyIcon=I.CODE_COPY||'';const copyTitle=L.COPY||'Copy';const list=scope.querySelectorAll('.msg-box.msg-user .msg');for(let i=0;i<list.length;i++){const msg=list[i];if(!msg||!msg.isConnected)continue;const existing=msg.querySelector('.msg-copy-btn');if(existing){try{const p=existing.parentElement;if(p&&p.classList&&p.classList.contains('uc-content')){msg.insertAdjacentElement('afterbegin',existing);}}catch(_){}
continue;}
const a=document.createElement('a');a.href='empty:0';a.className='msg-copy-btn';a.setAttribute('role','button');a.setAttribute('title',copyTitle);a.setAttribute('aria-label',copyTitle);a.setAttribute('data-tip',copyTitle);try{const box=msg.closest('.msg-box.msg-user');if(box&&box.id&&box.id.startsWith('msg-user-')){const id=box.id.slice('msg-user-'.length);a.setAttribute('data-id',id);}}catch(_){}
const img=document.createElement('img');img.className='copy-img';img.src=copyIcon;img.alt=copyTitle;a.appendChild(img);try{msg.insertAdjacentElement('afterbegin',a);}catch(_){try{msg.appendChild(a);}catch(__){}}}}catch(_){}}
appendToInput(content){const el=this.dom.get('_append_input_');if(!el)return;let html=String(content||'');const trimmed=html.trim();const isWrapped=(trimmed.startsWith('<div')&&/class=["']msg-box msg-user["']/.test(trimmed));if(!isWrapped){const safe=(typeof Utils!=='undefined'&&Utils.escapeHtml)?Utils.escapeHtml(html):String(html).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));const body=safe.replace(/\r?\n/g,'<br>');html=`<div class="msg-box msg-user"><div class="msg"><p style="margin:0">${body}</p></div></div>`;}
el.insertAdjacentHTML('beforeend',html);try{this._userCollapse.apply(el);}catch(_){}
try{this._ensureUserCopyIcons(el);}catch(_){}}
appendNode(content,scrollMgr){scrollMgr.userInteracted=false;scrollMgr.prevScroll=0;this.dom.clearStreamBefore();const el=this.dom.get('_nodes_');if(!el)return;el.classList.remove('empty_list');const userOnly=this._isUserOnlyContent(content);if(userOnly){el.insertAdjacentHTML('beforeend',content);this._materializeUserMdAsPlainText(el);try{this._userCollapse.apply(el);}catch(_){}
try{this._ensureUserCopyIcons(el);}catch(_){}
scrollMgr.scrollToBottom(false);scrollMgr.scheduleScrollFabUpdate();return;}
el.insertAdjacentHTML('beforeend',content);try{const maybePromise=this.renderer.renderPendingMarkdown(el);const post=()=>{try{this.highlighter.scheduleScanVisibleCodes(null);}catch(_){}
try{if(getMathMode()==='finalize-only')this.math.schedule(el,0,true);}catch(_){}
try{this._userCollapse.apply(el);}catch(_){}
try{this._ensureUserCopyIcons(el);}catch(_){}
scrollMgr.scrollToBottom(false);scrollMgr.scheduleScrollFabUpdate();};if(maybePromise&&typeof maybePromise.then==='function'){maybePromise.then(post);}else{post();}}catch(_){scrollMgr.scrollToBottom(false);scrollMgr.scheduleScrollFabUpdate();}}
replaceNodes(content,scrollMgr){scrollMgr.userInteracted=false;scrollMgr.prevScroll=0;this.dom.clearStreamBefore();const el=this.dom.hardReplaceByClone('_nodes_');if(!el)return;el.classList.remove('empty_list');const userOnly=this._isUserOnlyContent(content);if(userOnly){el.insertAdjacentHTML('beforeend',content);this._materializeUserMdAsPlainText(el);try{this._userCollapse.apply(el);}catch(_){}
try{this._ensureUserCopyIcons(el);}catch(_){}
scrollMgr.scrollToBottom(false,true);scrollMgr.scheduleScrollFabUpdate();return;}
el.insertAdjacentHTML('beforeend',content);try{const maybePromise=this.renderer.renderPendingMarkdown(el);const post=()=>{try{this.highlighter.scheduleScanVisibleCodes(null);}catch(_){}
try{if(getMathMode()==='finalize-only')this.math.schedule(el,0,true);}catch(_){}
try{this._userCollapse.apply(el);}catch(_){}
try{this._ensureUserCopyIcons(el);}catch(_){}
scrollMgr.scrollToBottom(false,true);scrollMgr.scheduleScrollFabUpdate();};if(maybePromise&&typeof maybePromise.then==='function'){maybePromise.then(post);}else{post();}}catch(_){scrollMgr.scrollToBottom(false,true);scrollMgr.scheduleScrollFabUpdate();}}
appendExtra(id,content,scrollMgr){const el=document.getElementById('msg-bot-'+id);if(!el)return;const extra=el.querySelector('.msg-extra');if(!extra)return;extra.insertAdjacentHTML('beforeend',content);try{const maybePromise=this.renderer.renderPendingMarkdown(extra);const post=()=>{const activeCode=(typeof runtime!=='undefined'&&runtime.stream)?runtime.stream.activeCode:null;try{this.highlighter.observeNewCode(extra,{deferLastIfStreaming:true,minLinesForLast:this.renderer.cfg.PROFILE_CODE.minLinesForHL,minCharsForLast:this.renderer.cfg.PROFILE_CODE.minCharsForHL},activeCode);this.highlighter.observeMsgBoxes(extra,(box)=>this._onBox(box));}catch(_){}
try{const mm=getMathMode();if(mm==='finalize-only')this.math.schedule(extra,0,true);else this.math.schedule(extra);}catch(_){}};if(maybePromise&&typeof maybePromise.then==='function'){maybePromise.then(post);}else{post();}}catch(_){}
scrollMgr.scheduleScroll(true);}
_onBox(box){const activeCode=(typeof runtime!=='undefined'&&runtime.stream)?runtime.stream.activeCode:null;this.highlighter.observeNewCode(box,{deferLastIfStreaming:true,minLinesForLast:this.renderer.cfg.PROFILE_CODE.minLinesForHL,minCharsForLast:this.renderer.cfg.PROFILE_CODE.minCharsForHL},activeCode);this.renderer.hooks.codeScrollInit(box);}
removeNode(id,scrollMgr){scrollMgr.prevScroll=0;let el=document.getElementById('msg-user-'+id);if(el)el.remove();el=document.getElementById('msg-bot-'+id);if(el)el.remove();this.dom.resetEphemeral();try{this.renderer.renderPendingMarkdown();}catch(_){}
scrollMgr.scheduleScroll(true);}
removeNodesFromId(id,scrollMgr){scrollMgr.prevScroll=0;const container=this.dom.get('_nodes_');if(!container)return;const elements=container.querySelectorAll('.msg-box');let remove=false;elements.forEach((element)=>{if(element.id&&element.id.endsWith('-'+id))remove=true;if(remove)element.remove();});this.dom.resetEphemeral();try{this.renderer.renderPendingMarkdown(container);}catch(_){}
scrollMgr.scheduleScroll(true);}};

/* data/js/app/raf.js */
class RafManager{constructor(cfg){this.cfg=cfg||{RAF:{},ASYNC:{}};this.tasks=new Map();this.groups=new Map();this.tickId=0;this._mode='raf';this.scheduled=false;this._flushInProgress=false;this._watchdogId=0;this._weakKeyTokens=new WeakMap();const R=(this.cfg&&this.cfg.RAF)||{};this.FLUSH_BUDGET_MS=Utils.g('RAF_FLUSH_BUDGET_MS',R.FLUSH_BUDGET_MS??7);this.MAX_TASKS_PER_FLUSH=Utils.g('RAF_MAX_TASKS_PER_FLUSH',R.MAX_TASKS_PER_FLUSH??120);this.SORT_THRESHOLD=Utils.g('RAF_SORT_THRESHOLD',R.SORT_THRESHOLD??32);this.VISIBILITY_FALLBACK_MS=Utils.g('RAF_VISIBILITY_FALLBACK_MS',R.VISIBILITY_FALLBACK_MS??300);this.USE_VISIBILITY_FALLBACK=(R.USE_VISIBILITY_FALLBACK??true);}
_normalizeKey(key){if(!key)return Symbol('raf:anon');const typ=typeof key;if(typ==='string'||typ==='symbol'||typ==='number')return key;try{if(typeof Node!=='undefined'&&key instanceof Node){let tok=this._weakKeyTokens.get(key);if(!tok){tok=Symbol('raf:k');this._weakKeyTokens.set(key,tok);}
return tok;}}catch(_){}
return key;}
_armPump(){if(this.scheduled)return;this.scheduled=true;const canRAF=typeof requestAnimationFrame==='function';if(canRAF){this._mode='raf';try{this.tickId=requestAnimationFrame(()=>this.flush());if(this.USE_VISIBILITY_FALLBACK&&!this._watchdogId){this._watchdogId=setTimeout(()=>{if(this.scheduled||this.tickId){try{this.flush();}catch(_){}}},this.VISIBILITY_FALLBACK_MS);}
return;}catch(_){}}
this._mode='raf';Promise.resolve().then(()=>this.flush());}
schedule(key,fn,group='default',priority=0){if(!key)key={k:'anon'};key=this._normalizeKey(key);const prev=this.tasks.get(key);if(prev&&prev.group&&prev.group!==group){const oldSet=this.groups.get(prev.group);if(oldSet){oldSet.delete(key);if(oldSet.size===0)this.groups.delete(prev.group);}}
this.tasks.set(key,{fn,group,priority});if(group){let set=this.groups.get(group);if(!set){set=new Set();this.groups.set(group,set);}
set.add(key);}
this._armPump();}
flush(){try{if(this.tickId)cancelAnimationFrame(this.tickId);}catch(_){}
this.tickId=0;this.scheduled=false;if(this._watchdogId){clearTimeout(this._watchdogId);this._watchdogId=0;}
const list=[];this.tasks.forEach((v,key)=>list.push({key,...v}));this.tasks.clear();if(list.length>1&&list.length>this.SORT_THRESHOLD){list.sort((a,b)=>a.priority-b.priority);}
const start=Utils.now();let processed=0;for(let idx=0;idx<list.length;idx++){const t=list[idx];try{t.fn();}catch(_){}
processed++;if(t.group){const set=this.groups.get(t.group);if(set){set.delete(t.key);if(set.size===0)this.groups.delete(t.group);}}
const elapsed=Utils.now()-start;if(processed>=this.MAX_TASKS_PER_FLUSH||elapsed>=this.FLUSH_BUDGET_MS){for(let j=idx+1;j<list.length;j++){const r=list[j];this.tasks.set(r.key,{fn:r.fn,group:r.group,priority:r.priority});if(r.group){let set=this.groups.get(r.group);if(!set){set=new Set();this.groups.set(r.group,set);}
set.add(r.key);}}
this._armPump();return;}}
if(this.tasks.size)this._armPump();}
kick(forceImmediate=true){if(forceImmediate&&this.tasks.size){if(this._flushInProgress)return;this._flushInProgress=true;try{this.scheduled=true;this.flush();}catch(_){}finally{this._flushInProgress=false;}
return;}
this._armPump();}
cancel(key){key=this._normalizeKey(key);const t=this.tasks.get(key);if(!t)return;this.tasks.delete(key);if(t.group){const set=this.groups.get(t.group);if(set){set.delete(key);if(set.size===0)this.groups.delete(t.group);}}}
cancelGroup(group){const set=this.groups.get(group);if(!set)return;for(const key of set)this.tasks.delete(key);this.groups.delete(group);}
cancelAll(){this.tasks.clear();this.groups.clear();try{if(this.tickId)cancelAnimationFrame(this.tickId);}catch(_){}
this.tickId=0;this.scheduled=false;if(this._watchdogId){clearTimeout(this._watchdogId);this._watchdogId=0;}}
isScheduled(key){return this.tasks.has(this._normalizeKey(key));}
nextFrame(){return new Promise((resolve)=>{const key=Symbol('raf:nextFrame');this.schedule(key,()=>resolve(),'RafNext',0);});}}
function getMathMode(){const v=String(window.MATH_STREAM_MODE||'finalize-only').toLowerCase();return(v==='idle'||v==='always'||v==='finalize-only')?v:'finalize-only';};

/* data/js/app/scroll.js */
class ScrollManager{constructor(cfg,dom,raf){this.cfg=cfg;this.dom=dom;this.raf=raf;this.autoFollow=true;this.userInteracted=false;this.lastScrollTop=0;this.prevScroll=0;this.currentFabAction='none';this.fabFreezeUntil=0;this.scrollScheduled=false;this.scrollFabUpdateScheduled=false;this.scrollRAF=0;this.scrollFabRAF=0;}
isNearBottom(marginPx=100){const el=Utils.SE;const distance=el.scrollHeight-el.clientHeight-el.scrollTop;return distance<=marginPx;}
scheduleScroll(live=false){if(live===true&&this.autoFollow!==true)return;if(this.scrollScheduled)return;this.scrollScheduled=true;this.raf.schedule('SM:scroll',()=>{this.scrollScheduled=false;this.scrollToBottom(live);this.scheduleScrollFabUpdate();},'ScrollManager',1);}
cancelPendingScroll(){try{this.raf.cancelGroup('ScrollManager');}catch(_){}
this.scrollScheduled=false;this.scrollFabUpdateScheduled=false;this.scrollRAF=0;this.scrollFabRAF=0;}
forceScrollToBottomImmediate(){const el=Utils.SE;el.scrollTop=el.scrollHeight;this.prevScroll=el.scrollHeight;}
scrollToBottom(live=false,force=false){const el=Utils.SE;const marginPx=this.cfg.UI.SCROLL_NEAR_MARGIN_PX;const behavior='instant';const h=el.scrollHeight;if(live===true&&this.autoFollow!==true){this.prevScroll=h;return;}
if((live===true&&this.userInteracted===false)||this.isNearBottom(marginPx)||live===false||force){try{el.scrollTo({top:h,behavior});}catch(_){el.scrollTop=h;}}
this.prevScroll=el.scrollHeight;}
hasVerticalScroll(){const el=Utils.SE;return(el.scrollHeight-el.clientHeight)>1;}
computeFabAction(){const el=Utils.SE;const h=el.scrollHeight;const c=el.clientHeight;const hasScroll=(h-c)>1;if(!hasScroll)return'none';const dist=h-c-el.scrollTop;if(dist<=2)return'up';if(dist>=this.cfg.FAB.SHOW_DOWN_THRESHOLD_PX)return'down';return'none';}
updateScrollFab(force=false,actionOverride=null,bypassFreeze=false){const btn=this.dom.get('scrollFab');const icon=this.dom.get('scrollFabIcon');if(!btn||!icon)return;const now=Utils.now();const action=actionOverride||this.computeFabAction();if(!force&&!bypassFreeze&&now<this.fabFreezeUntil&&action!==this.currentFabAction)return;if(action==='none'){if(this.currentFabAction!=='none'||force){btn.classList.remove('visible');this.currentFabAction='none';}
return;}
if(action!==this.currentFabAction||force){if(action==='up'){if(icon.dataset.dir!=='up'){icon.src=this.cfg.ICONS.COLLAPSE;icon.dataset.dir='up';}
btn.title="Go to top";}else{if(icon.dataset.dir!=='down'){icon.src=this.cfg.ICONS.EXPAND;icon.dataset.dir='down';}
btn.title="Go to bottom";}
btn.setAttribute('aria-label',btn.title);this.currentFabAction=action;btn.classList.add('visible');}else if(!btn.classList.contains('visible'))btn.classList.add('visible');}
scheduleScrollFabUpdate(){if(this.scrollFabUpdateScheduled)return;this.scrollFabUpdateScheduled=true;this.raf.schedule('SM:fab',()=>{this.scrollFabUpdateScheduled=false;const action=this.computeFabAction();if(action!==this.currentFabAction)this.updateScrollFab(false,action);},'ScrollManager',2);}
maybeEnableAutoFollowByProximity(){const el=Utils.SE;if(!this.autoFollow){const dist=el.scrollHeight-el.clientHeight-el.scrollTop;if(dist<=this.cfg.UI.AUTO_FOLLOW_REENABLE_PX)this.autoFollow=true;}}
scrollToTopUser(){this.userInteracted=true;this.autoFollow=false;try{const el=Utils.SE;el.scrollTo({top:0,behavior:'instant'});this.lastScrollTop=el.scrollTop;}catch(_){const el=Utils.SE;el.scrollTop=0;this.lastScrollTop=0;}}
scrollToBottomUser(){this.userInteracted=true;this.autoFollow=false;try{const el=Utils.SE;el.scrollTo({top:el.scrollHeight,behavior:'instant'});this.lastScrollTop=el.scrollTop;}catch(_){const el=Utils.SE;el.scrollTop=el.scrollHeight;this.lastScrollTop=el.scrollTop;}
this.maybeEnableAutoFollowByProximity();}}
class CodeScrollState{constructor(cfg,raf){this.cfg=cfg;this.raf=raf;this.map=new WeakMap();this.rafMap=new WeakMap();this.rafIds=new Set();this.rafKeyMap=new WeakMap();}
state(el){let s=this.map.get(el);if(!s){s={autoFollow:false,lastScrollTop:0,userInteracted:false,freezeUntil:0,listeners:null,};this.map.set(el,s);}
return s;}
isFinalizedCode(el){if(!el||el.tagName!=='CODE')return false;if(el.dataset&&el.dataset._active_stream==='1')return false;const highlighted=(el.getAttribute('data-highlighted')==='yes')||el.classList.contains('hljs');return highlighted;}
isNearBottomEl(el,margin=100){if(!el)return true;const distance=el.scrollHeight-el.clientHeight-el.scrollTop;return distance<=margin;}
scrollToBottom(el,live=false,force=false){if(!el||!el.isConnected)return;if(!force&&this.isFinalizedCode(el))return;const st=this.state(el);const now=Utils.now();if(!force&&st.freezeUntil&&now<st.freezeUntil)return;const distNow=el.scrollHeight-el.clientHeight-el.scrollTop;if(!force&&distNow<=1){st.lastScrollTop=el.scrollTop;return;}
const marginPx=live?96:this.cfg.CODE_SCROLL.NEAR_MARGIN_PX;const behavior='instant';if(!force){if(live&&st.autoFollow!==true)return;if(!live&&!(st.autoFollow===true||this.isNearBottomEl(el,marginPx)||!st.userInteracted))return;}
try{el.scrollTo({top:el.scrollHeight,behavior});}catch(_){el.scrollTop=el.scrollHeight;}
st.lastScrollTop=el.scrollTop;}
scheduleScroll(el,live=false,force=false){if(!el||!el.isConnected)return;if(!force&&this.isFinalizedCode(el))return;if(this.rafMap.get(el))return;this.rafMap.set(el,true);let key=this.rafKeyMap.get(el);if(!key){key=Symbol('codeScroll');this.rafKeyMap.set(el,key);}
this.raf.schedule(key,()=>{this.rafMap.delete(el);this.scrollToBottom(el,live,force);},'CodeScroll',0);}
attachHandlers(codeEl){if(!codeEl||codeEl.dataset.csListeners==='1')return;if(codeEl.dataset._active_stream!=='1')return;codeEl.dataset.csListeners='1';const st=this.state(codeEl);const onScroll=(ev)=>{const top=codeEl.scrollTop;const isUser=!!(ev&&ev.isTrusted===true);const now=Utils.now();if(this.isFinalizedCode(codeEl)){if(isUser)st.userInteracted=true;st.autoFollow=false;st.lastScrollTop=top;return;}
if(isUser){if(top+1<st.lastScrollTop){st.autoFollow=false;st.userInteracted=true;st.freezeUntil=now+1000;}else if(this.isNearBottomEl(codeEl,this.cfg.CODE_SCROLL.AUTO_FOLLOW_REENABLE_PX)){st.autoFollow=true;}}else{if(this.isNearBottomEl(codeEl,this.cfg.CODE_SCROLL.AUTO_FOLLOW_REENABLE_PX))st.autoFollow=true;}
st.lastScrollTop=top;};const onWheel=(ev)=>{st.userInteracted=true;const now=Utils.now();if(this.isFinalizedCode(codeEl)){st.autoFollow=false;return;}
if(ev.deltaY<0){st.autoFollow=false;st.freezeUntil=now+1000;}else if(this.isNearBottomEl(codeEl,this.cfg.CODE_SCROLL.AUTO_FOLLOW_REENABLE_PX)){st.autoFollow=true;}};const onTouchStart=()=>{st.userInteracted=true;};codeEl.addEventListener('scroll',onScroll,{passive:true});codeEl.addEventListener('wheel',onWheel,{passive:true});codeEl.addEventListener('touchstart',onTouchStart,{passive:true});st.listeners={onScroll,onWheel,onTouchStart};}
detachHandlers(codeEl){if(!codeEl)return;const st=this.map.get(codeEl);const h=st&&st.listeners;if(!h){codeEl.dataset.csListeners='0';return;}
try{codeEl.removeEventListener('scroll',h.onScroll);}catch(_){}
try{codeEl.removeEventListener('wheel',h.onWheel);}catch(_){}
try{codeEl.removeEventListener('touchstart',h.onTouchStart);}catch(_){}
st.listeners=null;codeEl.dataset.csListeners='0';}
initScrollableBlocks(root){const scope=root||document;let nodes=[];if(scope.nodeType===1&&scope.closest&&scope.closest('.msg-box.msg-bot')){nodes=scope.querySelectorAll('pre code');}else{nodes=document.querySelectorAll('.msg-box.msg-bot pre code');}
if(!nodes.length)return;nodes.forEach((code)=>{if(code.dataset._active_stream==='1'){this.attachHandlers(code);const st=this.state(code);st.autoFollow=true;this.scheduleScroll(code,true,false);}else{this.detachHandlers(code);}});}
transfer(oldEl,newEl){if(!oldEl||!newEl||oldEl===newEl)return;const oldState=this.map.get(oldEl);if(oldState)this.map.set(newEl,{...oldState});this.detachHandlers(oldEl);this.attachHandlers(newEl);}
cancelAllScrolls(){try{this.raf.cancelGroup('CodeScroll');}catch(_){}
this.rafMap=new WeakMap();this.rafIds.clear();this.rafKeyMap=new WeakMap();}};

/* data/js/app/stream.js */
const RE_SAFE_BREAK=/\s|[.,;:!?()\[\]{}'"«»„”“—–\-…>]/;const RE_STRUCT_BOUNDARY=/\n(\n|[-*]\s|\d+\.\s|#{1,6}\s|>\s)/;const RE_MD_INLINE_TRIGGER=/(\*\*|__|[_`]|~~|\[[^\]]+\]\([^)]+\))/;const RE_LINE_END=/[\n\r]$/;class StreamEngine{constructor(cfg,dom,renderer,math,highlighter,codeScroll,scrollMgr,raf,asyncer,logger){this.cfg=cfg;this.dom=dom;this.renderer=renderer;this.math=math;this.highlighter=highlighter;this.codeScroll=codeScroll;this.scrollMgr=scrollMgr;this.raf=raf;this.asyncer=asyncer;this.logger=logger||new Logger(cfg);this.streamBuf='';this._sbParts=[];this._sbLen=0;this._tailMaterializeAt=((this.cfg&&this.cfg.STREAM&&(this.cfg.STREAM.MATERIALIZE_TAIL_AT_LEN|0))||262144);this.fenceOpen=false;this.fenceMark='`';this.fenceLen=3;this.fenceTail='';this.fenceBuf='';this.lastSnapshotTs=0;this.nextSnapshotStep=cfg.PROFILE_TEXT.base;this.snapshotScheduled=false;this.snapshotRAF=0;this.codeStream={open:false,lines:0,chars:0};this.activeCode=null;this.suppressPostFinalizePass=false;this._promoteScheduled=false;this._firstCodeOpenSnapDone=false;this.isStreaming=false;this._lastInjectedEOL=false;this._customFenceSpecs=[];this._fenceCustom=null;this.plain={active:false,container:null,anchor:null,lastMDTs:0,noMdNL:0,suppressInline:false,forceFullMDOnce:false,enabled:false,_carry:''};this._mdQuickRe=/(\*\*|__|~~|`|!\[|\[[^\]]+\]\([^)]+\)|^> |\n> |\n#{1,6}\s|\n[-*+]\s|\n\d+\.\s)/m;this._reSafeBreak=RE_SAFE_BREAK;this._reStructBoundary=RE_STRUCT_BOUNDARY;this._reMDInlineTrigger=RE_MD_INLINE_TRIGGER;this._reLineEnd=RE_LINE_END;this._tpl=(typeof document!=='undefined')?document.createElement('template'):null;this._isWordChar=(ch)=>{if(!ch)return false;const c=ch.charCodeAt(0);if((c>=48&&c<=57)||(c>=65&&c<=90)||(c>=97&&c<=122))return true;if(c>=0x00C0&&c<=0x02AF)return true;return false;};this._isSafeBreakChar=(ch)=>{if(!ch)return false;return this._reSafeBreak.test(ch);};this._d('init',{materializeTailAt:this._tailMaterializeAt,hasTpl:!!this._tpl});}
_d(tag,data){try{const lg=this.logger||(this.cfg&&this.cfg.logger)||(window.runtime&&runtime.logger)||null;if(!lg||typeof lg.debug!=='function')return;lg.debug_obj("STREAM",tag,data);}catch(_){}}
setCustomFenceSpecs(specs){this._customFenceSpecs=Array.isArray(specs)?specs.slice():[];this._d('customFence.set',{count:(this._customFenceSpecs||[]).length});}
_appendChunk(s){if(!s)return;this._d('chunk.append',{len:s.length,nl:Utils.countNewlines(s),head:String(s).slice(0,160),tail:String(s).slice(-160),hasAngle:/[<>]/.test(String(s)),hasFenceToken:/```|~~~/.test(String(s))});this._sbParts.push(s);this._sbLen+=s.length;if(this._sbLen>=this._tailMaterializeAt){this._materializeTail();}}
_materializeTail(){this._d('tail.materialize',{streamBufLen:this.streamBuf.length,parts:this._sbParts.length,sbLen:this._sbLen});if(this._sbLen>0){this.streamBuf+=(this._sbParts.length===1?this._sbParts[0]:this._sbParts.join(''));this._sbParts.length=0;this._sbLen=0;}}
getStreamLength(){return(this.streamBuf.length+this._sbLen);}
getStreamText(){if(this._sbLen>0){return this.streamBuf+(this._sbParts.length===1?this._sbParts[0]:this._sbParts.join(''));}
return this.streamBuf;}
getDeltaSince(prevLen){const total=this.getStreamLength();if(prevLen>=total)return'';const bufLen=this.streamBuf.length;if(prevLen<=bufLen){if(this._sbLen===0)return'';const out=(this._sbParts.length===1?this._sbParts[0]:this._sbParts.join(''));if(/[<>]/.test(out))this._d('delta.since',{prevLen,deltaLen:out.length,head:out.slice(0,80),tail:out.slice(-80)});return out;}
let off=prevLen-bufLen;let out=null;for(let i=0;i<this._sbParts.length;i++){const p=this._sbParts[i];const plen=p.length;if(off>=plen){off-=plen;continue;}
const slice=off>0?p.slice(off):p;if(out===null)out=[slice];else out.push(slice);off=0;}
if(!out)return'';const ret=(out.length===1?out[0]:out.join(''));if(/[<>]/.test(ret))this._d('delta.since',{prevLen,deltaLen:ret.length,head:ret.slice(0,80),tail:ret.slice(-80)});return ret;}
_clearStreamBuffer(){this._d('buf.clear',{streamBufLen:this.streamBuf.length,parts:this._sbParts.length,sbLen:this._sbLen});this.streamBuf='';this._sbParts.length=0;this._sbLen=0;}
_plainThreshold(){const STREAM=(this.cfg&&this.cfg.STREAM)?this.cfg.STREAM:{};const thr=(STREAM.PLAIN_ACTIVATE_AFTER_LINES!=null)?STREAM.PLAIN_ACTIVATE_AFTER_LINES:10;return Math.max(1,thr|0);}
_plainReset(){this.plain.active=false;this.plain.container=null;this.plain.anchor=null;this.plain.lastMDTs=0;this.plain.noMdNL=0;this.plain.suppressInline=false;this.plain.forceFullMDOnce=false;this.plain.enabled=false;this.plain._carry='';this._d('plain.reset',{});}
_plainEnsureContainer(snap){if(this.plain.container&&this.plain.container.isConnected&&this.plain.anchor&&this.plain.anchor.parentNode===this.plain.container){const needParent=this._choosePlainParent(snap);if(needParent&&this.plain.container.parentNode!==needParent){try{needParent.appendChild(this.plain.container);}catch(_){}}
return this.plain.container;}
const parent=this._choosePlainParent(snap)||snap;const host=document.createElement('span');host.setAttribute('data-plain-stream','1');host.style.whiteSpace='pre-wrap';host.style.display='inline';host.style.wordBreak='normal';host.style.overflowWrap='normal';const tail=document.createTextNode('');const anchor=document.createComment('ps-tail');host.appendChild(tail);host.appendChild(anchor);try{parent.appendChild(host);}catch(_){snap.appendChild(host);}
this.plain.container=host;this.plain.anchor=anchor;this.plain.active=true;this._d('plain.ensureHost',{created:true});return host;}
_findSafeFlushIndex(text){if(!text)return 0;if(text.indexOf('\n')!==-1||text.indexOf('\r')!==-1){if(/[<>]/.test(text))this._d('plain.flushIdx.nl',{textLen:text.length});return this._retractIfInsideAngleToken(text,text.length);}
const PLAIN=(this.cfg&&this.cfg.STREAM&&this.cfg.STREAM.PLAIN)?this.cfg.STREAM.PLAIN:{};const LOOKBACK=(PLAIN.COHESION_LOOKBACK!=null)?PLAIN.COHESION_LOOKBACK:96;const STICKY=(PLAIN.COHESION_STICKY_TAIL!=null)?PLAIN.COHESION_STICKY_TAIL:8;const FLUSH_AT=(PLAIN.COHESION_FLUSH_AT_LEN!=null)?PLAIN.COHESION_FLUSH_AT_LEN:512;if(text.length>=FLUSH_AT){const at=Math.max(0,text.length-STICKY);if(/[<>]/.test(text))this._d('plain.flushIdx.hard',{textLen:text.length,at});return this._retractIfInsideAngleToken(text,at);}
const start=Math.max(0,text.length-LOOKBACK);for(let i=text.length-1;i>=start;i--){const ch=text[i];if(this._isSafeBreakChar(ch)){if(/[<>]/.test(text))this._d('plain.flushIdx.safe',{textLen:text.length,i,ch});return this._retractIfInsideAngleToken(text,i+1);}}
const at=Math.max(0,text.length-STICKY);if(/[<>]/.test(text))this._d('plain.flushIdx.sticky',{textLen:text.length,at});return this._retractIfInsideAngleToken(text,at);}
_choosePlainParent(snap){try{if(!snap||!snap.querySelectorAll)return snap;const pending=snap.querySelectorAll('[data-cm][data-cm-pending="1"]');if(pending&&pending.length)return pending[pending.length-1];}catch(_){}
return snap;}
_retractIfInsideAngleToken(text,flushIdx){const PLAIN=(this.cfg&&this.cfg.STREAM&&this.cfg.STREAM.PLAIN)?this.cfg.STREAM.PLAIN:{};const ENABLED=(PLAIN.PROTECT_ANGLE_TOKENS!==false);if(!ENABLED)return flushIdx;if(!text||flushIdx<=0||flushIdx>text.length)return flushIdx;const LOOK=(PLAIN.ANGLE_LOOKBACK!=null)?PLAIN.ANGLE_LOOKBACK:128;const from=Math.max(0,flushIdx-LOOK);const seg=text.slice(from,flushIdx);const lt=seg.lastIndexOf('<');if(lt!==-1&&seg.indexOf('>',lt+1)===-1){const next=seg.charAt(lt+1);const looksLikeTag=!!next&&((next>='A'&&next<='Z')||(next>='a'&&next<='z')||next==='!'||next==='/'||next==='?');if(looksLikeTag)return from+lt;}
if(flushIdx<text.length){const ch=text.charAt(flushIdx),ch2=text.charAt(flushIdx+1);if(ch==='<'&&ch2&&((ch2>='A'&&ch2<='Z')||(ch2>='a'&&ch2<='z')||ch2==='!'||ch2==='/'||ch2==='?'))return flushIdx;}
return flushIdx;}
_plainAppendDelta(snap,delta){if(!delta)return;const host=this._plainEnsureContainer(snap);let combined=(this.plain._carry||'')+String(delta);if(!combined)return;const flushIdx=this._findSafeFlushIndex(combined);let toAppend=combined.slice(0,flushIdx);let carryRemainder=combined.slice(flushIdx);const PLAIN=(this.cfg&&this.cfg.STREAM&&this.cfg.STREAM.PLAIN)?this.cfg.STREAM.PLAIN:{};const MIN_ATOMIC=(PLAIN.MIN_ATOMIC_CHARS!=null)?PLAIN.MIN_ATOMIC_CHARS:3;const isWord=(ch)=>{if(!ch)return false;const c=ch.charCodeAt(0);if((c>=48&&c<=57)||(c>=65&&c<=90)||(c>=97&&c<=122))return true;return(c>=0x00C0&&c<=0x02AF);};const lastA=toAppend?toAppend.charAt(toAppend.length-1):'';const firstB=carryRemainder?carryRemainder.charAt(0):'';const looksUnsafeSplit=(!/\r|\n/.test(toAppend))&&isWord(lastA)&&isWord(firstB);if(toAppend&&looksUnsafeSplit&&toAppend.length<MIN_ATOMIC){this.plain._carry=toAppend+carryRemainder;return;}
this.plain._carry=carryRemainder;if(!toAppend)return;let tn=this.plain.anchor?this.plain.anchor.previousSibling:null;if(!tn||tn.nodeType!==Node.TEXT_NODE||tn.parentNode!==host){tn=document.createTextNode('');try{host.insertBefore(tn,this.plain.anchor);}catch(_){host.appendChild(tn);}}
tn.appendData(toAppend);try{const CM=this.renderer&&this.renderer.customMarkup;const MDinline=this.renderer?(this.renderer.MD_STREAM||this.renderer.MD||null):null;if(CM&&typeof CM.maybeApplyStreamOnDelta==='function'){CM.maybeApplyStreamOnDelta(snap,toAppend,MDinline);}}catch(_){}
this._plainMaybeInlineMarkdown(toAppend,false);this.scrollMgr.scheduleScroll(true);}
_plainMaybeInlineMarkdown(delta,force){if(!this.plain.active||!this.plain.container||!this.plain.anchor)return;if(this.plain.suppressInline&&!force){this._d('plain.inline.skip.suppressed',{force});return;}
const PLAIN=(this.cfg&&this.cfg.STREAM&&this.cfg.STREAM.PLAIN)?this.cfg.STREAM.PLAIN:{};const MIN_INTERVAL=(PLAIN.MD_MIN_INTERVAL_MS!=null)?PLAIN.MD_MIN_INTERVAL_MS:120;const MIN_TAIL=(PLAIN.INLINE_MIN_CHARS!=null)?PLAIN.INLINE_MIN_CHARS:64;const WINDOW_MAX=(PLAIN.WINDOW_MAX_CHARS!=null)?PLAIN.WINDOW_MAX_CHARS:2048;const RESERVE_TAIL=(PLAIN.RESERVE_TAIL_CHARS!=null)?PLAIN.RESERVE_TAIL_CHARS:256;const now=Utils.now();if(!force&&(now-(this.plain.lastMDTs||0))<MIN_INTERVAL){this._d('plain.inline.skip.throttle',{since:(now-(this.plain.lastMDTs||0)),MIN_INTERVAL});return;}
const tn=this.plain.anchor.previousSibling;if(!tn||tn.nodeType!==Node.TEXT_NODE)return;const text=tn.nodeValue||'';if(!text)return;if(force){this._d('plain.inline.skip.forceFull',{});return;}
if(text.length<MIN_TAIL&&(!delta||delta.indexOf('\n')===-1)){this._d('plain.inline.skip.small',{textLen:text.length,MIN_TAIL});return;}
const candidate=(delta&&this._reMDInlineTrigger.test(delta))||this._reMDInlineTrigger.test(text);if(!candidate){this._d('plain.inline.skip.noCandidate',{deltaHas:!!(delta&&this._reMDInlineTrigger.test(delta))});return;}
let cut=text.length;if(text.length>WINDOW_MAX){const target=text.length-RESERVE_TAIL;const nl=text.lastIndexOf('\n',Math.max(0,target));if(nl>=32)cut=nl+1;else cut=Math.max(WINDOW_MAX,text.length-RESERVE_TAIL);}
let head=text.slice(0,cut);let rest=text.slice(cut);if(head&&rest){const last=head[head.length-1];const first=rest[0];if(this._isWordChar(last)&&this._isWordChar(first)){let backCut=-1;const LOOKBACK=96;const start=Math.max(0,head.length-LOOKBACK);for(let i=head.length-1;i>=start;i--){if(this._isSafeBreakChar(head[i])){backCut=i+1;break;}}
if(backCut>=0&&backCut<head.length){rest=head.slice(backCut)+rest;head=head.slice(0,backCut);}}}
let html='';try{if(this.renderer&&typeof this.renderer.renderInlineStreaming==='function'){html=this.renderer.renderInlineStreaming(head);}else if(this.renderer&&this.renderer.MD_STREAM&&typeof this.renderer.MD_STREAM.renderInline==='function'){html=this.renderer.MD_STREAM.renderInline(head);}else{html=Utils.escapeHtml(head);}}catch(_){html=Utils.escapeHtml(head);}
this._d('plain.inline.promote',{headLen:head.length,restLen:rest.length,htmlLen:html.length});try{if(this._tpl){this._tpl.innerHTML=html;const frag=document.createDocumentFragment();while(this._tpl.content.firstChild)frag.appendChild(this._tpl.content.firstChild);const host=this.plain.container;host.insertBefore(frag,tn);tn.nodeValue=rest;}else{const tpl=document.createElement('template');tpl.innerHTML=html;const frag=tpl.content;const host=this.plain.container;host.insertBefore(frag,tn);tn.nodeValue=rest;}}catch(_){}
this.plain.lastMDTs=now;}
reset(){this._d('reset',{});this._clearStreamBuffer();this.fenceOpen=false;this.fenceMark='`';this.fenceLen=3;this.fenceTail='';this.fenceBuf='';this.lastSnapshotTs=0;this.nextSnapshotStep=this.profile().base;this.snapshotScheduled=false;this.snapshotRAF=0;this.codeStream={open:false,lines:0,chars:0};this.activeCode=null;this.suppressPostFinalizePass=false;this._promoteScheduled=false;this._firstCodeOpenSnapDone=false;this._lastInjectedEOL=false;this._fenceCustom=null;this._plainReset();}
defuseActiveToPlain(){if(!this.activeCode||!this.activeCode.codeEl||!this.activeCode.codeEl.isConnected)return;const codeEl=this.activeCode.codeEl;const fullText=(this.activeCode.frozenEl?.textContent||'')+(this.activeCode.tailEl?.textContent||'');this._d('code.defuseActive',{fullLen:fullText.length});try{codeEl.textContent=fullText;codeEl.removeAttribute('data-highlighted');codeEl.classList.remove('hljs');codeEl.dataset._active_stream='0';const st=this.codeScroll.state(codeEl);st.autoFollow=false;}catch(_){}
this.activeCode=null;}
defuseOrphanActiveBlocks(root){try{const scope=root||document;const nodes=scope.querySelectorAll('pre code[data-_active_stream="1"]');let n=0;nodes.forEach(codeEl=>{if(!codeEl.isConnected)return;let text='';const frozen=codeEl.querySelector('.hl-frozen');const tail=codeEl.querySelector('.hl-tail');if(frozen||tail)text=(frozen?.textContent||'')+(tail?.textContent||'');else text=codeEl.textContent||'';codeEl.textContent=text;codeEl.removeAttribute('data-highlighted');codeEl.classList.remove('hljs');codeEl.dataset._active_stream='0';try{this.codeScroll.attachHandlers(codeEl);}catch(_){}
n++;});if(n)this._d('code.defuseOrphans',{count:n});}catch(e){}}
abortAndReset(opts){const o=Object.assign({finalizeActive:true,clearBuffer:true,clearMsg:false,defuseOrphans:true,reason:'',suppressLog:false},(opts||{}));this._d('abort',o);try{this.raf.cancelGroup('StreamEngine');}catch(_){}
try{this.raf.cancel('SE:snapshot');}catch(_){}
this.snapshotScheduled=false;this.snapshotRAF=0;const hadActive=!!this.activeCode;try{if(this.activeCode){if(o.finalizeActive===true)this.finalizeActiveCode();else this.defuseActiveToPlain();}}catch(e){}
if(o.defuseOrphans){try{this.defuseOrphanActiveBlocks();}catch(e){}}
if(o.clearBuffer){this._clearStreamBuffer();this.fenceOpen=false;this.fenceMark='`';this.fenceLen=3;this.fenceTail='';this.fenceBuf='';this.codeStream.open=false;this.codeStream.lines=0;this.codeStream.chars=0;window.__lastSnapshotLen=0;}
if(o.clearMsg===true){try{this.dom.resetEphemeral();}catch(_){}}
this._plainReset();}
profile(){return this.fenceOpen?this.cfg.PROFILE_CODE:this.cfg.PROFILE_TEXT;}
resetBudget(){this.nextSnapshotStep=this.profile().base;this._d('budget.reset',{step:this.nextSnapshotStep});}
onlyTrailingWhitespace(s,from,end){for(let i=from;i<end;i++){const c=s.charCodeAt(i);if(c!==0x20&&c!==0x09)return false;}
return true;}
updateFenceHeuristic(chunk){const prev=(this.fenceBuf||'');const s=prev+(chunk||'');const preLen=prev.length;const n=s.length;let i=0;let opened=false;let closed=false;let splitAt=-1;let atLineStart=(preLen===0)?true:this._reLineEnd.test(prev);const inNewOrCrosses=(j,k)=>(j>=preLen)||(k>preLen);while(i<n){const ch=s[i];if(ch==='\r'||ch==='\n'){atLineStart=true;i++;continue;}
if(!atLineStart){i++;continue;}
atLineStart=false;let j=i;while(j<n){let localSpaces=0;while(j<n&&(s[j]===' '||s[j]==='\t')){localSpaces+=(s[j]==='\t')?4:1;j++;if(localSpaces>3)break;}
if(j<n&&s[j]==='>'){j++;if(j<n&&s[j]===' ')j++;continue;}
let saved=j;if(j<n&&(s[j]==='-'||s[j]==='*'||s[j]==='+')){let jj=j+1;if(jj<n&&s[jj]===' ')j=jj+1;else j=saved;}else{let k2=j;let hasDigit=false;while(k2<n&&s[k2]>='0'&&s[k2]<='9'){hasDigit=true;k2++;}
if(hasDigit&&k2<n&&(s[k2]==='.'||s[k2]===')')){k2++;if(k2<n&&s[k2]===' ')j=k2+1;else j=saved;}else j=saved;}
break;}
let indent=0;while(j<n&&(s[j]===' '||s[j]==='\t')){indent+=(s[j]==='\t')?4:1;j++;if(indent>3)break;}
if(indent>3){i=j;continue;}
if(!this.fenceOpen&&this._customFenceSpecs&&this._customFenceSpecs.length){for(let ci=0;ci<this._customFenceSpecs.length;ci++){const spec=this._customFenceSpecs[ci];const open=spec&&spec.open?spec.open:'';if(!open)continue;const k=j+open.length;if(k<=n&&s.slice(j,k)===open){if(inNewOrCrosses(j,k)){this.fenceOpen=true;this._fenceCustom=spec;opened=true;this._d('fence.open.custom',{open,at:j});i=k;continue;}}}}else if(this.fenceOpen&&this._fenceCustom&&this._fenceCustom.close){const close=this._fenceCustom.close;const k=j+close.length;if(k<=n&&s.slice(j,k)===close){let eol=k;while(eol<n&&s[eol]!=='\n'&&s[eol]!=='\r')eol++;const onlyWS=this.onlyTrailingWhitespace(s,k,eol);if(onlyWS&&inNewOrCrosses(j,k)){this.fenceOpen=false;this._fenceCustom=null;closed=true;const endInS=k;const rel=endInS-preLen;const splitAt=Math.max(0,Math.min((chunk?chunk.length:0),rel));this._d('fence.close.custom',{close,splitAt});return{opened,closed,splitAt};}}}
if(j<n&&(s[j]==='`'||s[j]==='~')){const mark=s[j];let k=j;while(k<n&&s[k]===mark)k++;const run=k-j;if(!this.fenceOpen){if(run>=3){if(inNewOrCrosses(j,k)){this.fenceOpen=true;this.fenceMark=mark;this.fenceLen=run;opened=true;this._d('fence.open.std',{mark,run});i=k;continue;}else{i=k;continue;}}}else if(!this._fenceCustom){if(mark===this.fenceMark&&run>=this.fenceLen){if(inNewOrCrosses(j,k)){let eol=k;while(eol<n&&s[eol]!=='\n'&&s[eol]!=='\r')eol++;if(this.onlyTrailingWhitespace(s,k,eol)){this.fenceOpen=false;closed=true;const endInS=k;const rel=endInS-preLen;const splitAt=Math.max(0,Math.min((chunk?chunk.length:0),rel));this._d('fence.close.std',{mark,run,splitAt});return{opened,closed,splitAt};}}else{i=k;continue;}}}}
i=j+1;}
const MAX_TAIL=512;this.fenceBuf=s.slice(-MAX_TAIL);this.fenceTail=s.slice(-3);if(opened||closed)this._d('fence.state',{opened,closed,fenceTail:this.fenceTail});return{opened,closed,splitAt:-1};}
getMsgSnapshotRoot(msg){if(!msg)return null;let snap=msg.querySelector('.md-snapshot-root');if(!snap){snap=document.createElement('div');snap.className='md-snapshot-root';msg.appendChild(snap);this._d('snapshot.root.create',{});}
return snap;}
hasStructuralBoundary(chunk){if(!chunk)return false;return this._reStructBoundary.test(chunk);}
shouldSnapshotOnChunk(chunk,chunkHasNL,hasBoundary){const prof=this.profile();const now=Utils.now();if(this.activeCode&&this.fenceOpen)return false;if((now-this.lastSnapshotTs)<prof.minInterval)return false;if(hasBoundary)return true;const delta=Math.max(0,this.getStreamLength()-(window.__lastSnapshotLen||0));if(this.fenceOpen){if(chunkHasNL&&delta>=this.nextSnapshotStep)return true;return false;}
if(delta>=this.nextSnapshotStep)return true;return false;}
maybeScheduleSoftSnapshot(msg,chunkHasNL){const prof=this.profile();if(this.activeCode&&this.fenceOpen)return;if(this.fenceOpen&&this.codeStream.lines<1&&!chunkHasNL)return;const now=Utils.now();if((now-this.lastSnapshotTs)>=prof.softLatency){this._d('snapshot.soft.schedule',{latency:(now-this.lastSnapshotTs),soft:prof.softLatency});this.scheduleSnapshot(msg);}}
scheduleSnapshot(msg,force=false){if(this.snapshotScheduled&&!this.raf.isScheduled('SE:snapshot'))this.snapshotScheduled=false;if(!force){if(this.snapshotScheduled){this._d('snapshot.schedule.skip',{reason:'alreadyScheduled'});return;}
if(this.activeCode&&this.fenceOpen){this._d('snapshot.schedule.skip',{reason:'activeCodeFenceOpen'});return;}}else{if(this.snapshotScheduled&&this.raf.isScheduled('SE:snapshot')){this._d('snapshot.schedule.skip',{reason:'alreadyScheduled(forceCollide)'});return;}}
this.snapshotScheduled=true;this._d('snapshot.schedule',{force,fenceOpen:this.fenceOpen,isStreaming:this.isStreaming});this.raf.schedule('SE:snapshot',()=>{this.snapshotScheduled=false;const msg=this.getMsg(false,'');if(msg)this.renderSnapshot(msg);},'StreamEngine',0);}
ensureSplitCodeEl(codeEl){if(!codeEl)return null;let frozen=codeEl.querySelector('.hl-frozen');let tail=codeEl.querySelector('.hl-tail');if(frozen&&tail)return{codeEl,frozenEl:frozen,tailEl:tail};const text=codeEl.textContent||'';codeEl.innerHTML='';frozen=document.createElement('span');frozen.className='hl-frozen';tail=document.createElement('span');tail.className='hl-tail';codeEl.appendChild(frozen);codeEl.appendChild(tail);if(text)tail.textContent=text;this._d('code.ensureSplit',{hadText:!!text,textLen:text.length});return{codeEl,frozenEl:frozen,tailEl:tail};}
setupActiveCodeFromSnapshot(snap){const codes=snap.querySelectorAll('pre code');if(!codes.length)return null;const last=codes[codes.length-1];const cls=Array.from(last.classList).find(c=>c.startsWith('language-'))||'language-plaintext';const lang=(cls.replace('language-','')||'plaintext');const parts=this.ensureSplitCodeEl(last);if(!parts)return null;if(this._lastInjectedEOL&&parts.tailEl&&parts.tailEl.textContent&&parts.tailEl.textContent.endsWith('\n')){parts.tailEl.textContent=parts.tailEl.textContent.slice(0,-1);this._lastInjectedEOL=false;}
const st=this.codeScroll.state(parts.codeEl);st.autoFollow=true;st.userInteracted=false;parts.codeEl.dataset._active_stream='1';const baseFrozenNL=Utils.countNewlines(parts.frozenEl.textContent||'');const baseTailNL=Utils.countNewlines(parts.tailEl.textContent||'');const ac={codeEl:parts.codeEl,frozenEl:parts.frozenEl,tailEl:parts.tailEl,lang,frozenLen:parts.frozenEl.textContent.length,lastPromoteTs:0,lines:0,tailLines:baseTailNL,linesSincePromote:0,initialLines:baseFrozenNL+baseTailNL,haltHL:false,plainStream:false};this._d('code.active.set',{lang,frozenLen:ac.frozenLen,tailNL:baseTailNL});return ac;}
rehydrateActiveCode(oldAC,newAC){if(!oldAC||!newAC)return;const newFullText=newAC.codeEl.textContent||'';if(oldAC.plainStream===true){const prevText=oldAC.tailEl?(oldAC.tailEl.textContent||''):'';let delta='';if(newFullText&&newFullText.startsWith(prevText))delta=newFullText.slice(prevText.length);else delta=newFullText;while(newAC.tailEl.firstChild)newAC.tailEl.removeChild(newAC.tailEl.firstChild);let tn=null;if(oldAC._tailTextNode&&oldAC._tailTextNode.parentNode===oldAC.tailEl&&oldAC._tailTextNode.nodeType===Node.TEXT_NODE){tn=oldAC._tailTextNode;}else if(oldAC.tailEl&&oldAC.tailEl.firstChild&&oldAC.tailEl.firstChild.nodeType===Node.TEXT_NODE){tn=oldAC.tailEl.firstChild;}else{tn=document.createTextNode(prevText||'');}
newAC.tailEl.appendChild(tn);newAC._tailTextNode=tn;if(delta&&delta!==prevText)tn.appendData(delta);newAC.frozenLen=0;newAC.lang=oldAC.lang;newAC.lines=oldAC.lines;newAC.tailLines=Utils.countNewlines((prevText||'')+(delta&&delta!==prevText?delta:''));newAC.lastPromoteTs=oldAC.lastPromoteTs;newAC.linesSincePromote=oldAC.linesSincePromote||0;newAC.initialLines=oldAC.initialLines||0;newAC.haltHL=!!oldAC.haltHL;newAC.plainStream=true;try{oldAC.codeEl=null;oldAC.frozenEl=null;oldAC.tailEl=null;}catch(_){}
this._d('code.rehydrate.plain',{deltaLen:delta.length});return;}
const remainder=newFullText.slice(oldAC.frozenLen);if(oldAC.frozenEl){const src=oldAC.frozenEl;const dst=newAC.frozenEl;if(dst&&src){while(src.firstChild)dst.appendChild(src.firstChild);}}
newAC.tailEl.textContent=remainder;newAC.frozenLen=oldAC.frozenLen;newAC.lang=oldAC.lang;newAC.lines=oldAC.lines;newAC.tailLines=Utils.countNewlines(remainder);newAC.lastPromoteTs=oldAC.lastPromoteTs;newAC.linesSincePromote=oldAC.linesSincePromote||0;newAC.initialLines=oldAC.initialLines||0;newAC.haltHL=!!oldAC.haltHL;newAC.plainStream=!!oldAC.plainStream;try{oldAC.codeEl=null;oldAC.frozenEl=null;oldAC.tailEl=null;}catch(_){}
this._d('code.rehydrate',{remainderLen:remainder.length,frozenLen:newAC.frozenLen});}
appendToActiveTail(text){if(!this.activeCode||!this.activeCode.tailEl||!text)return;let tn=this.activeCode._tailTextNode;if(!tn||tn.parentNode!==this.activeCode.tailEl||tn.nodeType!==Node.TEXT_NODE){const t=this.activeCode.tailEl.textContent||'';this.activeCode.tailEl.textContent=t;tn=this.activeCode._tailTextNode=this.activeCode.tailEl.firstChild||document.createTextNode('');if(!tn.parentNode)this.activeCode.tailEl.appendChild(tn);}
tn.appendData(text);const nl=Utils.countNewlines(text);this.activeCode.tailLines+=nl;this.activeCode.linesSincePromote+=nl;if(((this.activeCode._tailAppends=(this.activeCode._tailAppends|0)+1)%200)===0){this.activeCode.tailEl.normalize();this.activeCode._tailTextNode=this.activeCode.tailEl.firstChild;}
if(/[<>]/.test(text)){this._d('code.tail.append',{len:text.length,nl,head:text.slice(0,80),tail:text.slice(-80)});}
this.codeScroll.scheduleScroll(this.activeCode.codeEl,true,false);}
enforceHLStopBudget(){if(!this.activeCode)return;if(this.cfg.HL.DISABLE_ALL){this.activeCode.haltHL=true;this.activeCode.plainStream=true;return;}
const stop=(this.cfg.PROFILE_CODE.stopAfterLines|0);const streamPlainLines=(this.cfg.PROFILE_CODE.streamPlainAfterLines|0);const streamPlainChars=(this.cfg.PROFILE_CODE.streamPlainAfterChars|0);const maxFrozenChars=(this.cfg.PROFILE_CODE.maxFrozenChars|0);const totalLines=(this.activeCode.initialLines||0)+(this.activeCode.lines||0);const frozenChars=this.activeCode.frozenLen|0;const tailChars=(this.activeCode.tailEl?.textContent||'').length|0;const totalStreamedChars=frozenChars+tailChars;if((streamPlainLines>0&&totalLines>=streamPlainLines)||(streamPlainChars>0&&totalStreamedChars>=streamPlainChars)||(maxFrozenChars>0&&frozenChars>=maxFrozenChars)){this.activeCode.haltHL=true;this.activeCode.plainStream=true;try{this.activeCode.codeEl.dataset.hlStreamSuspended='1';}catch(_){}
this._d('code.hl.budget.stop',{totalLines,totalStreamedChars,frozenChars,streamPlainLines,streamPlainChars,maxFrozenChars});return;}
if(stop>0&&totalLines>=stop){this.activeCode.haltHL=true;this.activeCode.plainStream=true;try{this.activeCode.codeEl.dataset.hlStreamSuspended='1';}catch(_){}
this._d('code.hl.budget.hardStop',{totalLines,stop});}}
_aliasLang(token){const v=String(token||'').trim().toLowerCase();return this.highlighter.ALIAS[v]||v;}
_isHLJSSupported(lang){try{return!!(window.hljs&&hljs.getLanguage&&hljs.getLanguage(lang));}catch(_){return false;}}
_detectDirectiveLangFromText(text){if(!text)return null;let s=String(text);if(s.charCodeAt(0)===0xFEFF)s=s.slice(1);const lines=s.split(/\r?\n/);let i=0;while(i<lines.length&&!lines[i].trim())i++;if(i>=lines.length)return null;let first=lines[i].trim();first=first.replace(/^\s*lang(?:uage)?\s*[:=]\s*/i,'').trim();let token=first.split(/\s+/)[0].replace(/:$/,'');if(!/^[A-Za-z][\w#+\-\.]{0,30}$/.test(token))return null;let cand=this._aliasLang(token);const rest=lines.slice(i+1).join('\n');if(!rest.trim())return null;let pos=0,seen=0;while(seen<i&&pos<s.length){const nl=s.indexOf('\n',pos);if(nl===-1)return null;pos=nl+1;seen++;}
let end=s.indexOf('\n',pos);if(end===-1)end=s.length;else end=end+1;this._d('code.lang.directive.detect',{lang:cand,deleteUpto:end});return{lang:cand,deleteUpto:end};}
_updateCodeLangClass(codeEl,newLang){try{Array.from(codeEl.classList).forEach(c=>{if(c.startsWith('language-'))codeEl.classList.remove(c);});}catch(_){}
try{codeEl.classList.add('language-'+(newLang||'plaintext'));}catch(_){}}
_updateCodeHeaderLabel(codeEl,newLabel,newLangToken){try{const wrap=codeEl.closest('.code-wrapper');if(!wrap)return;const span=wrap.querySelector('.code-header-lang');if(span)span.textContent=newLabel||(newLangToken||'code');wrap.setAttribute('data-code-lang',newLangToken||'');}catch(_){}}
maybePromoteLanguageFromDirective(){if(!this.activeCode||!this.activeCode.codeEl)return;if(this.activeCode.lang&&this.activeCode.lang!=='plaintext')return;const frozenTxt=this.activeCode.frozenEl?this.activeCode.frozenEl.textContent:'';const tailTxt=this.activeCode.tailEl?this.activeCode.tailEl.textContent:'';const combined=frozenTxt+tailTxt;if(!combined)return;const det=this._detectDirectiveLangFromText(combined);if(!det||!det.lang)return;const newLang=det.lang;const newCombined=combined.slice(det.deleteUpto);try{const codeEl=this.activeCode.codeEl;codeEl.innerHTML='';const frozen=document.createElement('span');frozen.className='hl-frozen';const tail=document.createElement('span');tail.className='hl-tail';tail.textContent=newCombined;codeEl.appendChild(frozen);codeEl.appendChild(tail);this.activeCode.frozenEl=frozen;this.activeCode.tailEl=tail;this.activeCode.frozenLen=0;this.activeCode.tailLines=Utils.countNewlines(newCombined);this.activeCode.linesSincePromote=0;this.activeCode.lang=newLang;this._updateCodeLangClass(codeEl,newLang);this._updateCodeHeaderLabel(codeEl,newLang,newLang);this._d('code.lang.directive.promote',{newLang,tailLen:newCombined.length});this.schedulePromoteTail(true);}catch(e){}}
highlightDeltaText(lang,text){if(this.cfg.HL.DISABLE_ALL)return Utils.escapeHtml(text);if(window.hljs&&lang&&hljs.getLanguage&&hljs.getLanguage(lang)){try{return hljs.highlight(text,{language:lang,ignoreIllegals:true}).value;}catch(_){return Utils.escapeHtml(text);}}
return Utils.escapeHtml(text);}
schedulePromoteTail(force=false){if(!this.activeCode||!this.activeCode.tailEl)return;if(this.activeCode.plainStream===true)return;if(this._promoteScheduled)return;this._promoteScheduled=true;this._d('code.promote.schedule',{force});this.raf.schedule('SE:promoteTail',()=>{this._promoteScheduled=false;this._promoteTailWork(force);},'StreamEngine',1);}
async _promoteTailWork(force=false){if(!this.activeCode||!this.activeCode.tailEl)return;if(this.activeCode.plainStream===true)return;const now=Utils.now();const prof=this.cfg.PROFILE_CODE;const tailText0=this.activeCode.tailEl.textContent||'';if(!tailText0)return;if(!force){if((now-this.activeCode.lastPromoteTs)<prof.promoteMinInterval)return;const enoughLines=(this.activeCode.linesSincePromote||0)>=(prof.promoteMinLines||10);const enoughChars=tailText0.length>=prof.minCharsForHL;if(!enoughLines&&!enoughChars)return;}
const idx=tailText0.lastIndexOf('\n');const usePlain=this.activeCode.haltHL||this.activeCode.plainStream||!this._isHLJSSupported(this.activeCode.lang);let cut=-1;if(idx>=0)cut=idx+1;else if(usePlain){const PLAIN_PROMOTE_CHARS=this.cfg.PROFILE_CODE.minPlainPromoteChars||8192;if(tailText0.length>=PLAIN_PROMOTE_CHARS||force)cut=tailText0.length;}
if(cut<=0)return;const delta=tailText0.slice(0,cut);if(!delta)return;this.enforceHLStopBudget();if(!usePlain)await this.asyncer.yield();if(!this.activeCode||!this.activeCode.tailEl)return;const tailNow=this.activeCode.tailEl.textContent||'';if(!tailNow.startsWith(delta)){this._d('code.promote.tailChanged',{expectedLen:delta.length,tailNowLen:tailNow.length});this.schedulePromoteTail(false);return;}
if(usePlain){let tn=this.activeCode._frozenTextNode;if(!tn||tn.parentNode!==this.activeCode.frozenEl){tn=document.createTextNode('');this.activeCode.frozenEl.appendChild(tn);this.activeCode._frozenTextNode=tn;}
tn.appendData(delta);}else{let html=Utils.escapeHtml(delta);try{html=this.highlightDeltaText(this.activeCode.lang,delta);}catch(_){html=Utils.escapeHtml(delta);}
if(this._tpl){this._tpl.innerHTML=html;while(this._tpl.content.firstChild)this.activeCode.frozenEl.appendChild(this._tpl.content.firstChild);}else{this.activeCode.frozenEl.insertAdjacentHTML('beforeend',html);}
html=null;}
this.activeCode.tailEl.textContent=tailNow.slice(delta.length);this.activeCode.frozenLen+=delta.length;const promotedLines=Utils.countNewlines(delta);this.activeCode.tailLines=Math.max(0,(this.activeCode.tailLines||0)-promotedLines);this.activeCode.linesSincePromote=Math.max(0,(this.activeCode.linesSincePromote||0)-promotedLines);this.activeCode.lastPromoteTs=Utils.now();this._d('code.promote.done',{plain:usePlain,deltaLen:delta.length,promotedLines,frozenLen:this.activeCode.frozenLen,tailLenNow:(this.activeCode.tailEl.textContent||'').length});}
_normTextForFP(s){if(!s)return'';let t=String(s);if(t.charCodeAt(0)===0xFEFF)t=t.slice(1);t=t.replace(/\r\n?/g,'\n');if(t.endsWith('\n'))t=t.slice(0,-1);return t;}
_hash32FNV(str){let h=0x811c9dc5>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=(h+((h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24)))>>>0;}
return('00000000'+h.toString(16)).slice(-8);}
_codeLangFromEl(codeEl){try{const cls=Array.from(codeEl.classList).find(c=>c.startsWith('language-'))||'language-plaintext';return(cls.replace('language-','')||'plaintext');}catch(_){return'plaintext';}}
_fpKeyFromCodeEl(codeEl){try{const lang=this._codeLangFromEl(codeEl);const norm=this._normTextForFP(codeEl.textContent||'');return`${lang}|${norm.length}|${this._hash32FNV(norm)}`;}catch(_){return'';}}
finalizeActiveCode(){if(!this.activeCode)return;const ac=this.activeCode;const codeEl=ac.codeEl;if(!codeEl||!codeEl.isConnected){this.activeCode=null;return;}
this._d('code.finalize.begin',{lang:ac.lang,frozenLen:ac.frozenLen,tailLen:(ac.tailEl?(ac.tailEl.textContent||'').length:0),plainStream:!!ac.plainStream});const fromBottomBefore=Math.max(0,codeEl.scrollHeight-codeEl.clientHeight-codeEl.scrollTop);const wasNearBottom=this.codeScroll.isNearBottomEl(codeEl,this.cfg.CODE_SCROLL.NEAR_MARGIN_PX);const tailTXT=ac.tailEl?(ac.tailEl.textContent||''):'';const canHL=!this.cfg.HL.DISABLE_ALL&&!ac.plainStream&&this._isHLJSSupported(ac.lang);const frag=document.createDocumentFragment();try{if(ac.frozenEl){while(ac.frozenEl.firstChild)frag.appendChild(ac.frozenEl.firstChild);}}catch(_){}
try{if(tailTXT){if(canHL){let tailHTML='';try{tailHTML=this.highlightDeltaText(ac.lang,tailTXT);}catch(_){tailHTML=Utils.escapeHtml(tailTXT);}
if(this._tpl){this._tpl.innerHTML=tailHTML;while(this._tpl.content.firstChild)frag.appendChild(this._tpl.content.firstChild);}else{const tpl=document.createElement('template');tpl.innerHTML=tailHTML;frag.appendChild(tpl.content);}}else{frag.appendChild(document.createTextNode(tailTXT));}}}catch(_){}
try{codeEl.textContent='';codeEl.appendChild(frag);codeEl.classList.add('hljs');codeEl.setAttribute('data-highlighted','yes');codeEl.dataset._active_stream='0';}catch(_){}
try{const totalChars=(ac.frozenLen|0)+(tailTXT?tailTXT.length:0);const totalLines=(ac.initialLines|0)+(ac.lines|0);this._updateCodeWrapperMetaFast(codeEl,totalChars,totalLines,ac.lang);}catch(_){}
const st=this.codeScroll.state(codeEl);st.autoFollow=false;const maxScrollTop=Math.max(0,codeEl.scrollHeight-codeEl.clientHeight);const target=wasNearBottom?maxScrollTop:Math.max(0,maxScrollTop-fromBottomBefore);try{codeEl.scrollTop=target;}catch(_){}
st.lastScrollTop=codeEl.scrollTop;try{codeEl.dataset.justFinalized='1';}catch(_){}
this.codeScroll.scheduleScroll(codeEl,false,true);this.suppressPostFinalizePass=true;try{ac._tailTextNode=null;ac._frozenTextNode=null;ac.frozenEl=null;ac.tailEl=null;ac.codeEl=null;}catch(_){}
this.activeCode=null;this._d('code.finalize.end',{});}
codeFingerprint(codeEl){const cls=Array.from(codeEl.classList).find(c=>c.startsWith('language-'))||'language-plaintext';const lang=cls.replace('language-','')||'plaintext';const t=codeEl.textContent||'';const len=t.length;const head=t.slice(0,64);const tail=t.slice(-64);return`${lang}|${len}|${head}|${tail}`;}
codeFingerprintFromWrapper(codeEl){try{const wrap=codeEl.closest('.code-wrapper');if(!wrap)return null;const fpStable=wrap.getAttribute('data-fp');if(fpStable)return fpStable;const cls=Array.from(codeEl.classList).find(c=>c.startsWith('language-'))||'language-plaintext';const lang=(cls.replace('language-','')||'plaintext');const lenAttr=wrap.getAttribute('data-code-len');const headAttr=wrap.getAttribute('data-code-head')||'';const tailAttr=wrap.getAttribute('data-code-tail')||'';if(!lenAttr)return null;const txt=codeEl.textContent||'';const lenNow=txt.length;const lenNum=parseInt(lenAttr,10);if(!Number.isFinite(lenNum)||lenNum!==lenNow)return null;const headNowEsc=Utils.escapeHtml(txt.slice(0,64));const tailNowEsc=Utils.escapeHtml(txt.slice(-64));if((headAttr&&headAttr!==headNowEsc)||(tailAttr&&tailAttr!==tailNowEsc)){return null;}
return`${lang}|${lenAttr}|${headAttr}|${tailAttr}`;}catch(_){return null;}}
preserveStableClosedCodes(oldSnap,newRoot,skipLastIfStreaming){try{const oldCodes=oldSnap.querySelectorAll('pre code');if(!oldCodes||!oldCodes.length)return;const newCodesPre=newRoot.querySelectorAll('pre code');if(!newCodesPre||!newCodesPre.length)return;const limit=(this.cfg.STREAM&&this.cfg.STREAM.PRESERVE_CODES_MAX)||200;if(newCodesPre.length>limit||oldCodes.length>limit)return;this._d('codes.preserve.scan',{old:oldCodes.length,anew:newCodesPre.length,skipLastIfStreaming});const map=new Map();const push=(key,el)=>{if(!key)return;let arr=map.get(key);if(!arr){arr=[];map.set(key,arr);}
arr.push(el);};const makeAttrKey=(wrap)=>{if(!wrap)return'';const lang=(wrap.getAttribute('data-code-lang')||'plaintext');const len=(wrap.getAttribute('data-code-len')||'0');const head=(wrap.getAttribute('data-code-head')||'');const tail=(wrap.getAttribute('data-code-tail')||'');return`${lang}|${len}|${head}|${tail}`;};for(let idx=0;idx<oldCodes.length;idx++){const el=oldCodes[idx];if(el.querySelector('.hl-frozen'))continue;if(this.activeCode&&el===this.activeCode.codeEl)continue;const wrap=el.closest('.code-wrapper');const fpStable=wrap?wrap.getAttribute('data-fp'):null;if(fpStable){push(`S|${fpStable}`,el);}else{push(`A|${makeAttrKey(wrap)}`,el);}}
const end=(skipLastIfStreaming&&newCodesPre.length>0)?(newCodesPre.length-1):newCodesPre.length;for(let i=0;i<end;i++){const nc=newCodesPre[i];if(nc.getAttribute('data-highlighted')==='yes')continue;const wrap=nc.closest('.code-wrapper');let swapped=false;const fpStableNew=wrap?wrap.getAttribute('data-fp'):null;if(fpStableNew){const arr=map.get(`S|${fpStableNew}`);if(arr&&arr.length){const oldEl=arr.pop();if(oldEl&&oldEl.isConnected){try{nc.replaceWith(oldEl);this.codeScroll.attachHandlers(oldEl);if(!oldEl.getAttribute('data-highlighted'))oldEl.setAttribute('data-highlighted','yes');const st=this.codeScroll.state(oldEl);st.autoFollow=false;}catch(_){}
swapped=true;}
if(!arr.length)map.delete(`S|${fpStableNew}`);}}
if(swapped)continue;const attrKey=`A|${makeAttrKey(wrap)}`;const arr2=map.get(attrKey);if(arr2&&arr2.length){const oldEl=arr2.pop();if(oldEl&&oldEl.isConnected){try{nc.replaceWith(oldEl);this.codeScroll.attachHandlers(oldEl);if(!oldEl.getAttribute('data-highlighted'))oldEl.setAttribute('data-highlighted','yes');const st=this.codeScroll.state(oldEl);st.autoFollow=false;}catch(_){}}
if(!arr2.length)map.delete(attrKey);}}}catch(e){}}
_ensureSplitContainers(codeEl){try{const scope=codeEl||document;const nodes=scope.querySelectorAll('pre code[data-just-finalized="1"]');if(!nodes||!nodes.length)return;nodes.forEach((codeEl)=>{this.codeScroll.scheduleScroll(codeEl,false,true);const wrap=codeEl.closest('.code-wrapper');const idx=wrap?(wrap.getAttribute('data-index')||''):'';const key=`JF:forceBottom#${idx}`;this.raf.schedule(key,()=>{this.codeScroll.scrollToBottom(codeEl,false,true);try{codeEl.dataset.justFinalized='0';}catch(_){}},'CodeScroll',2);});}catch(_){}}
_ensureBottomForJustFinalized(root){try{const scope=root||document;const nodes=scope.querySelectorAll('pre code[data-just-finalized="1"]');if(!nodes||!nodes.length)return;nodes.forEach((codeEl)=>{const wrap=codeEl.closest('.code-wrapper');const idx=wrap?(wrap.getAttribute('data-index')||''):'';const key=`JF:ensureBottom#${idx}`;this.codeScroll.scheduleScroll(codeEl,false,true);this.raf.schedule(key,()=>{this.codeScroll.scrollToBottom(codeEl,false,true);try{codeEl.dataset.justFinalized='0';}catch(_){}},'CodeScroll',2);});}catch(_){}}
kickVisibility(){const msg=this.getMsg(false,'');if(!msg)return;if(this.codeStream.open&&!this.activeCode){this._d('kick.visibility',{reason:'codeStreamOpenNoActive'});this.scheduleSnapshot(msg,true);return;}
const needSnap=(this.getStreamLength()!==(window.__lastSnapshotLen||0));if(needSnap){this._d('kick.visibility',{reason:'bufferDelta'});this.scheduleSnapshot(msg,true);}
if(this.activeCode&&this.activeCode.codeEl){this.codeScroll.scheduleScroll(this.activeCode.codeEl,true,false);this.schedulePromoteTail(true);}}
stabilizeHeaderLabel(prevAC,newAC){try{if(!newAC||!newAC.codeEl||!newAC.codeEl.isConnected)return;const wrap=newAC.codeEl.closest('.code-wrapper');if(!wrap)return;const span=wrap.querySelector('.code-header-lang');const curLabel=(span&&span.textContent?span.textContent.trim():'').toLowerCase();if(curLabel==='output')return;const tokNow=(wrap.getAttribute('data-code-lang')||'').trim().toLowerCase();const sticky=(wrap.getAttribute('data-lang-sticky')||'').trim().toLowerCase();const prev=(prevAC&&prevAC.lang&&prevAC.lang!=='plaintext')?prevAC.lang.toLowerCase():'';const valid=(t)=>!!t&&t!=='plaintext'&&this._isHLJSSupported(t);let finalTok='';if(valid(tokNow))finalTok=tokNow;else if(valid(prev))finalTok=prev;else if(valid(sticky))finalTok=sticky;if(finalTok){this._updateCodeLangClass(newAC.codeEl,finalTok);this._updateCodeHeaderLabel(newAC.codeEl,finalTok,finalTok);try{wrap.setAttribute('data-code-lang',finalTok);}catch(_){}
try{wrap.setAttribute('data-lang-sticky',finalTok);}catch(_){}
newAC.lang=finalTok;this._d('code.header.stabilize',{finalTok});}else{if(span&&curLabel&&curLabel.length<3)span.textContent='code';}}catch(_){}}
_patchSnapshotRoot(snap,frag){try{const oldKids=snap.childNodes;const newKids=frag.childNodes;const aLen=oldKids.length;const bLen=newKids.length;if(aLen===0){snap.appendChild(frag);this._d('snapshot.patch.first',{newCount:bLen});return;}
const MAX_CMP=6;const eq=(a,b)=>{try{if(!a||!b)return false;if(a.nodeType!==b.nodeType)return false;if(a.nodeType===3||a.nodeType===8)return a.nodeValue===b.nodeValue;if(a.nodeType===1){const ae=a,be=b;if(ae.tagName!==be.tagName)return false;const acls=ae.className||'';if(acls!==(be.className||''))return false;return ae.isEqualNode(be);}
return false;}catch(_){return false;}};let i=0,j=0;const iMax=Math.min(aLen,bLen,MAX_CMP);while(i<iMax&&eq(oldKids[i],newKids[i]))i++;const jMax=Math.min(aLen-i,bLen-i,MAX_CMP);while(j<jMax&&eq(oldKids[aLen-1-j],newKids[bLen-1-j]))j++;const removeStart=i;const removeEnd=aLen-j;for(let k=removeStart;k<removeEnd;k++){const node=snap.childNodes[removeStart];if(node){try{snap.removeChild(node);}catch(_){}}}
const insStart=i,insEnd=bLen-j;if(insStart<insEnd){const mid=document.createDocumentFragment();for(let k=insStart;k<insEnd;k++){if(newKids[insStart])mid.appendChild(newKids[insStart]);}
const ref=(i<snap.childNodes.length)?snap.childNodes[i]:null;if(ref)snap.insertBefore(mid,ref);else snap.appendChild(mid);}
this._d('snapshot.patch',{oldCount:aLen,newCount:bLen,removed:(removeEnd-removeStart),inserted:(bLen-j-i)});}catch(_){try{snap.replaceChildren(frag);this._d('snapshot.patch.replaceAll',{});}catch(__){}}}
_chunkHasMarkdown(s){try{return this._mdQuickRe.test(String(s||''));}catch(_){return false;}}
_chunkHasCustomOpeners(s){try{const CM=this.renderer&&this.renderer.customMarkup;if(!CM||typeof CM.hasAnyStreamOpenToken!=='function')return false;return CM.hasAnyStreamOpenToken(String(s||''));}catch(_){return false;}}
renderSnapshot(msg){const streaming=!!this.isStreaming;const snap=this.getMsgSnapshotRoot(msg);if(!snap)return;const prevLen=(window.__lastSnapshotLen||0);const curLen=this.getStreamLength();if(!this.fenceOpen&&!this.activeCode&&curLen===prevLen){this.lastSnapshotTs=Utils.now();return;}
const forceFull=!!this.plain.forceFullMDOnce;const streamingPlain=streaming&&!this.fenceOpen&&!forceFull&&this.plain.enabled;this._d('snapshot.begin',{streaming,fenceOpen:this.fenceOpen,streamingPlain,forceFull,prevLen,curLen});if(streamingPlain){const delta=this.getDeltaSince(prevLen);this._plainAppendDelta(snap,delta);window.__lastSnapshotLen=curLen;this.lastSnapshotTs=Utils.now();const prof=this.profile();if(prof.adaptiveStep){const maxStep=this.cfg.STREAM.SNAPSHOT_MAX_STEP||8000;this.nextSnapshotStep=Math.min(Math.ceil(this.nextSnapshotStep*prof.growth),maxStep);}else{this.nextSnapshotStep=prof.base;}
this.scrollMgr.scheduleScroll(true);this.scrollMgr.fabFreezeUntil=Utils.now()+this.cfg.FAB.TOGGLE_DEBOUNCE_MS;this.scrollMgr.scheduleScrollFabUpdate();this._d('snapshot.end.plain',{nextStep:this.nextSnapshotStep});return;}
if(forceFull)this.plain.forceFullMDOnce=false;let allText=this.getStreamText();this.plain._carry='';const needSyntheticEOL=(this.fenceOpen&&!/[\r\n]$/.test(allText));this._lastInjectedEOL=!!needSyntheticEOL;let src=needSyntheticEOL?(allText+'\n'):allText;if(/[<>]/.test(src))this._d('snapshot.full.src',{len:src.length,head:src.slice(0,120),tail:src.slice(-120),injectedEOL:needSyntheticEOL});let frag=null;if(streaming)frag=this.renderer.renderStreamingSnapshotFragment(src);else frag=this.renderer.renderFinalSnapshotFragment(src);try{if(this.renderer&&this.renderer.customMarkup&&this.renderer.customMarkup.hasStreamRules()){const MDinline=this.renderer.MD_STREAM||this.renderer.MD||null;this.renderer.customMarkup.applyStream(frag,MDinline);}}catch(_){}
this.preserveStableClosedCodes(snap,frag,this.fenceOpen===true);this._patchSnapshotRoot(snap,frag);try{if(this.highlighter&&typeof this.highlighter.microHighlightNow==='function'){this.highlighter.microHighlightNow(snap,{maxCount:1,budgetMs:4},this.activeCode);}}catch(_){}
this.renderer.restoreCollapsedCode(snap);this._ensureBottomForJustFinalized(snap);const prevAC=this.activeCode;if(this.fenceOpen){const newAC=this.setupActiveCodeFromSnapshot(snap);if(prevAC&&newAC)this.rehydrateActiveCode(prevAC,newAC);this.stabilizeHeaderLabel(prevAC||null,newAC||null);this.activeCode=newAC||null;}else{this.activeCode=null;}
if(!this.fenceOpen){this.codeScroll.initScrollableBlocks(snap);}
this.highlighter.observeNewCode(snap,{deferLastIfStreaming:true,minLinesForLast:this.cfg.PROFILE_CODE.minLinesForHL,minCharsForLast:this.cfg.PROFILE_CODE.minCharsForHL},this.activeCode);this.highlighter.observeMsgBoxes(snap,(box)=>{this.highlighter.observeNewCode(box,{deferLastIfStreaming:true,minLinesForLast:this.cfg.PROFILE_CODE.minLinesForHL,minCharsForLast:this.cfg.PROFILE_CODE.minCharsForHL},this.activeCode);this.codeScroll.initScrollableBlocks(box);});const mm=getMathMode();if(!this.suppressPostFinalizePass){if(mm==='idle')this.math.schedule(snap);else if(mm==='always')this.math.schedule(snap,0,true);}
if(this.fenceOpen&&this.activeCode&&this.activeCode.codeEl){this.codeScroll.attachHandlers(this.activeCode.codeEl);this.codeScroll.scheduleScroll(this.activeCode.codeEl,true,false);}else if(!this.fenceOpen){this.codeScroll.initScrollableBlocks(snap);}
window.__lastSnapshotLen=this.getStreamLength();this.lastSnapshotTs=Utils.now();const prof=this.profile();if(prof.adaptiveStep){const maxStep=this.cfg.STREAM.SNAPSHOT_MAX_STEP||8000;this.nextSnapshotStep=Math.min(Math.ceil(this.nextSnapshotStep*prof.growth),maxStep);}else{this.nextSnapshotStep=prof.base;}
this.scrollMgr.scheduleScroll(true);this.scrollMgr.fabFreezeUntil=Utils.now()+this.cfg.FAB.TOGGLE_DEBOUNCE_MS;this.scrollMgr.scheduleScrollFabUpdate();if(this.suppressPostFinalizePass)this.suppressPostFinalizePass=false;frag=null;src=null;allText=null;this._d('snapshot.end.full',{nextStep:this.nextSnapshotStep,fenceOpen:this.fenceOpen,hasActiveCode:!!this.activeCode});}
_updateCodeWrapperMeta(codeEl){try{const wrap=codeEl.closest('.code-wrapper');if(!wrap)return;const txt=codeEl.textContent||'';wrap.setAttribute('data-code-len',String(txt.length));wrap.setAttribute('data-code-head',Utils.escapeHtml(txt.slice(0,64)));wrap.setAttribute('data-code-tail',Utils.escapeHtml(txt.slice(-64)));wrap.setAttribute('data-code-nl',String(Utils.countNewlines(txt)));const lang=this._codeLangFromEl(codeEl);wrap.setAttribute('data-code-lang',lang);const norm=this._normTextForFP(txt);const fp=`${lang}|${norm.length}|${this._hash32FNV(norm)}`;wrap.setAttribute('data-fp',fp);}catch(_){}}
_updateCodeWrapperMetaFast(codeEl,len,nl,langTok){try{const wrap=codeEl.closest('.code-wrapper');if(!wrap)return;if(Number.isFinite(len))wrap.setAttribute('data-code-len',String(len));if(Number.isFinite(nl))wrap.setAttribute('data-code-nl',String(nl));if(langTok){wrap.setAttribute('data-code-lang',String(langTok));this._updateCodeLangClass(codeEl,langTok);}}catch(_){}}
getMsg(create,name_header){return this.dom.getStreamMsg(create,name_header);}
beginStream(chunk=false){this.isStreaming=true;this._d('stream.begin',{chunk});if(chunk){try{runtime.loading.hide();}catch(_){}}
this.scrollMgr.userInteracted=false;this.dom.clearOutput();this.reset();this.scrollMgr.forceScrollToBottomImmediate();this.scrollMgr.scheduleScroll();}
endStream(){this.isStreaming=false;const msg=this.getMsg(false,'');if(msg)this.renderSnapshot(msg);this.snapshotScheduled=false;try{this.raf.cancel('SE:snapshot');}catch(_){}
try{this.raf.cancelGroup('StreamEngine');}catch(_){}
try{this.raf.cancelGroup('CodeScroll');}catch(_){}
try{this.raf.cancelGroup('ScrollMgr');}catch(_){}
this.snapshotRAF=0;const hadActive=!!this.activeCode;if(this.activeCode)this.finalizeActiveCode();if(!hadActive){if(this.highlighter.hlQueue&&this.highlighter.hlQueue.length){this.highlighter.flush(this.activeCode);}
const snap=msg?this.getMsgSnapshotRoot(msg):null;if(snap)this.math.renderAsync(snap);}
this._clearStreamBuffer();this.fenceOpen=false;this.codeStream.open=false;this.activeCode=null;this.lastSnapshotTs=Utils.now();this.suppressPostFinalizePass=false;this._plainReset();this._d('stream.end',{hadActive});}
_maybeEagerSnapshotForCustomOpeners(msg,chunkStr){try{const CM=this.renderer&&this.renderer.customMarkup;if(!CM||!CM.hasStreamRules())return;if(this.fenceOpen||this.codeStream.open)return;const isFirstSnapshot=((window.__lastSnapshotLen||0)===0);if(isFirstSnapshot){let head;try{head=this.getStreamText();}catch(_){head=String(chunkStr||'');}
if(CM.hasStreamOpenerAtStart(head)){this._d('snapshot.eager.custom',{reason:'headHasOpener'});this.scheduleSnapshot(msg,true);return;}}
const rules=(CM.getRules()||[]).filter(r=>r&&r.stream&&typeof r.open==='string');if(rules.length&&CM.hasAnyOpenToken(String(chunkStr||''),rules)){this._d('snapshot.eager.custom',{reason:'chunkHasOpener'});this.scheduleSnapshot(msg);}}catch(_){}}
applyStream(name_header,chunk,alreadyBuffered=false){if(!this.activeCode&&!this.fenceOpen){try{if(document.querySelector('pre code[data-_active_stream="1"]'))this.defuseOrphanActiveBlocks();}catch(_){}}
if(this.snapshotScheduled&&!this.raf.isScheduled('SE:snapshot'))this.snapshotScheduled=false;const msg=this.getMsg(true,name_header);if(!msg||!chunk)return;const s=String(chunk);if(/[<>]/.test(s)){this._d('apply.chunk',{len:s.length,nl:Utils.countNewlines(s),head:s.slice(0,120),tail:s.slice(-120)});}
if(!alreadyBuffered)this._appendChunk(s);const change=this.updateFenceHeuristic(s);const nlCount=Utils.countNewlines(s);const chunkHasNL=nlCount>0;if(!change.opened&&!this.fenceOpen){this._maybeEagerSnapshotForCustomOpeners(msg,s);}
if(!this.fenceOpen&&!this.codeStream.open){const mdPresent=this._chunkHasMarkdown(s)||this._chunkHasCustomOpeners(s)||change.opened;const thr=this._plainThreshold();if(mdPresent){if(this.plain.noMdNL!==0){this._d('apply.plain.resetOnMD',{noMdNL:this.plain.noMdNL});}
this.plain.noMdNL=0;if(this.plain.enabled){this.plain.enabled=false;this.plain.suppressInline=false;this.plain.forceFullMDOnce=true;this._d('apply.plain.disableOnMD',{});this.scheduleSnapshot(msg,true);}}else if(chunkHasNL){this.plain.noMdNL+=nlCount;if(!this.plain.enabled&&this.plain.noMdNL>=thr){this.plain.enabled=true;this.plain.suppressInline=true;this._d('apply.plain.enable',{noMdNL:this.plain.noMdNL,thr});this.scheduleSnapshot(msg);}}}
let didImmediateOpenSnap=false;if(change.opened){this.codeStream.open=true;this.codeStream.lines=0;this.codeStream.chars=0;this.resetBudget();this._d('code.open',{});this.scheduleSnapshot(msg);if(!this._firstCodeOpenSnapDone&&!this.activeCode&&((window.__lastSnapshotLen||0)===0)){try{this.renderSnapshot(msg);try{this.raf.cancel('SE:snapshot');}catch(_){}
this.snapshotScheduled=false;this._firstCodeOpenSnapDone=true;didImmediateOpenSnap=true;this._d('code.open.immediateSnap',{});}catch(_){}}}
if(this.codeStream.open){this.codeStream.lines+=nlCount;this.codeStream.chars+=s.length;if(this.activeCode&&this.activeCode.codeEl&&this.activeCode.codeEl.isConnected){let partForCode=s;let remainder='';if(didImmediateOpenSnap)partForCode='';else if(change.closed&&change.splitAt>=0&&change.splitAt<=s.length){partForCode=s.slice(0,change.splitAt);remainder=s.slice(change.splitAt);}
if(partForCode){this.appendToActiveTail(partForCode);this.activeCode.lines+=Utils.countNewlines(partForCode);this.maybePromoteLanguageFromDirective();this.enforceHLStopBudget();const tailLenNow=(this.activeCode.tailEl.textContent||'').length;const hasNL=partForCode.indexOf('\n')>=0;if(!this.activeCode.plainStream){const HL_MIN=this.cfg.PROFILE_CODE.minCharsForHL;if(hasNL||tailLenNow>=HL_MIN)this.schedulePromoteTail(false);}}
this.scrollMgr.scrollFabUpdateScheduled=false;this.scrollMgr.scheduleScroll(true);this.scrollMgr.fabFreezeUntil=Utils.now()+this.cfg.FAB.TOGGLE_DEBOUNCE_MS;this.scrollMgr.scheduleScrollFabUpdate();if(change.closed){this._d('code.close',{remainderLen:remainder.length});this.finalizeActiveCode();this.codeStream.open=false;this.resetBudget();this.plain.forceFullMDOnce=true;this.scheduleSnapshot(msg,true);if(remainder&&remainder.length){this.applyStream(name_header,remainder,true);}}
return;}else{if(!this.activeCode&&(this.codeStream.lines>=2||this.codeStream.chars>=80)){this._d('code.awaitActive.forceSnap',{lines:this.codeStream.lines,chars:this.codeStream.chars});this.scheduleSnapshot(msg,true);return;}
if(change.closed){this.codeStream.open=false;this.resetBudget();this._d('code.closed.outside',{});this.plain.forceFullMDOnce=true;this.scheduleSnapshot(msg,true);}else{const boundary=this.hasStructuralBoundary(s);if(this.shouldSnapshotOnChunk(s,chunkHasNL,boundary)){this._d('snapshot.decide',{reason:'boundary/step'});this.scheduleSnapshot(msg);}else{this.maybeScheduleSoftSnapshot(msg,chunkHasNL);}}
return;}}
if(change.closed){this.codeStream.open=false;this.resetBudget();this._d('code.closed.outside',{});this.scheduleSnapshot(msg);}else{const boundary=this.hasStructuralBoundary(s);if(this.shouldSnapshotOnChunk(s,chunkHasNL,boundary)){this._d('snapshot.decide',{reason:'boundary/step'});this.scheduleSnapshot(msg);}else{this.maybeScheduleSoftSnapshot(msg,chunkHasNL);}}}};

/* data/js/app/queue.js */
class StreamQueue{constructor(cfg,engine,scrollMgr,raf){this.cfg=cfg;this.engine=engine;this.scrollMgr=scrollMgr;this.raf=raf;this.q=[];this.rd=0;this.drainScheduled=false;this.batching=false;this.needScroll=false;this.DRAIN_KEY=Symbol('SQ:drain');const R=(this.cfg&&this.cfg.RAF)||{};this.DRAIN_BUDGET_MS=(R.STREAM_DRAIN_BUDGET_MS!=null)?R.STREAM_DRAIN_BUDGET_MS:4;this.COMPACT_SLICE_THRESHOLD=1024;this._lastCompactRd=0;}
_qCount(){return Math.max(0,this.q.length-this.rd);}
_compactContiguousSameName(){const n=this._qCount();if(n<2)return;const out=[];let prev=null;for(let i=this.rd;i<this.q.length;i++){const cur=this.q[i];if(!cur)continue;if(prev&&prev.name===cur.name){if(cur.parts&&cur.parts.length){for(let k=0;k<cur.parts.length;k++)prev.parts.push(cur.parts[k]);}else if(cur.chunk){prev.parts.push(cur.chunk);}
prev.len+=(cur.len|0);if(cur.parts)cur.parts.length=0;cur.chunk='';cur.len=0;cur.name='';}else{const parts=cur.parts?cur.parts:(cur.chunk?[cur.chunk]:[]);prev={name:cur.name,parts:parts,len:cur.len!=null?cur.len:(cur.chunk?cur.chunk.length:0)};out.push(prev);if(cur.parts)cur.parts=[];cur.chunk='';cur.len=0;cur.name='';}}
this.q=out;this.rd=0;this._lastCompactRd=0;}
_maybeCompact(){if(this.rd===0)return;const n=this._qCount();if(n===0){this.q=[];this.rd=0;this._lastCompactRd=0;return;}
if(this.rd>=this.COMPACT_SLICE_THRESHOLD){this.q=this.q.slice(this.rd);this.rd=0;this._lastCompactRd=0;return;}
if(this.rd-this._lastCompactRd>=128||(this.rd>64&&this.rd>=(this.q.length>>1))){this.q=this.q.slice(this.rd);this.rd=0;this._lastCompactRd=0;}}
_scheduleDrain(){if(this.drainScheduled)return;this.drainScheduled=true;this.raf.schedule(this.DRAIN_KEY,()=>this.drain(),'StreamQueue',-5);}
enqueue(name_header,chunk){if(!chunk||chunk.length===0)return;const name=name_header;const hasPending=this._qCount()>0;const tail=hasPending?this.q[this.q.length-1]:null;if(tail&&tail.name===name){tail.parts.push(chunk);tail.len+=chunk.length;}else{this.q.push({name,parts:[chunk],len:chunk.length});}
const cnt=this._qCount();if(cnt>(this.cfg.STREAM.EMERGENCY_COALESCE_LEN|0))this._compactContiguousSameName();else if(cnt>(this.cfg.STREAM.QUEUE_MAX_ITEMS|0))this._compactContiguousSameName();this._scheduleDrain();}
drain(){this.drainScheduled=false;const adaptive=(this.cfg.STREAM.COALESCE_MODE==='adaptive');const coalesceAggressive=adaptive&&(this._qCount()>=(this.cfg.STREAM.EMERGENCY_COALESCE_LEN|0));const basePerFrame=this.cfg.STREAM.MAX_PER_FRAME|0;const perFrame=adaptive?Math.min(basePerFrame+Math.floor(this._qCount()/20),basePerFrame*4):basePerFrame;const start=Utils.now();const sched=(navigator&&navigator.scheduling&&navigator.scheduling.isInputPending)?navigator.scheduling:null;this.batching=true;let processed=0;while(this.rd<this.q.length&&processed<perFrame){const idx=this.rd++;const e=this.q[idx];if(!e)continue;if(coalesceAggressive){while(this.rd<this.q.length&&this.q[this.rd]&&this.q[this.rd].name===e.name){const n=this.q[this.rd++];if(n.parts&&n.parts.length){for(let k=0;k<n.parts.length;k++)e.parts.push(n.parts[k]);}else if(n.chunk){e.parts.push(n.chunk);}
e.len+=(n.len|0);if(n.parts)n.parts.length=0;n.chunk='';n.len=0;n.name='';this.q[this.rd-1]=null;}}
let payload='';if(!e.parts||e.parts.length===0)payload=e.chunk||'';else if(e.parts.length===1)payload=e.parts[0]||'';else payload=e.parts.join('');this.engine.applyStream(e.name,payload);processed++;if(e.parts)e.parts.length=0;e.chunk='';e.len=0;e.name='';this.q[idx]=null;payload='';if(sched&&sched.isInputPending({includeContinuous:true}))break;if((Utils.now()-start)>=this.DRAIN_BUDGET_MS)break;}
this.batching=false;if(this.needScroll){this.scrollMgr.scheduleScroll(true);this.needScroll=false;}
this._maybeCompact();if(this._qCount()>0)this._scheduleDrain();}
kick(){if(this._qCount()||this.drainScheduled)this._scheduleDrain();}
clear(){for(let i=this.rd;i<this.q.length;i++){const e=this.q[i];if(!e)continue;if(e.parts)e.parts.length=0;e.chunk='';e.len=0;e.name='';this.q[i]=null;}
this.q=[];this.rd=0;this._lastCompactRd=0;try{this.raf.cancelGroup('StreamQueue');}catch(_){}
this.drainScheduled=false;}};

/* data/js/app/template.js */
class NodeTemplateEngine{constructor(cfg,logger){this.cfg=cfg||{};this.logger=logger||{debug:()=>{}};}
_esc(s){return(s==null)?'':String(s);}
_escapeHtml(s){return(typeof Utils!=='undefined')?Utils.escapeHtml(s):String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}
_nameHeader(role,name,avatarUrl){if(!name&&!avatarUrl)return'';const cls=(role==='user')?'name-user':'name-bot';const img=avatarUrl?`<img src="${this._esc(avatarUrl)}" class="avatar"> `:'';return`<div class="name-header ${cls}">${img}${this._esc(name || '')}</div>`;}
_renderUser(block){const id=block.id;const inp=block.input||{};const msgId=`msg-user-${id}`;const personalize=!!(block&&block.extra&&block.extra.personalize===true);const nameHeader=personalize?this._nameHeader('user',inp.name||'',inp.avatar_img||null):'';const content=this._escapeHtml(inp.text||'').replace(/\r?\n/g,'<br>');const I=(this.cfg&&this.cfg.ICONS)||{};const L=(this.cfg&&this.cfg.LOCALE)||{};const copyIcon=I.CODE_COPY||'';const copyTitle=L.COPY||'Copy';const copyBtn=`<a href="empty:${this._esc(id)}" class="msg-copy-btn" data-id="${this._esc(id)}" data-tip="${this._escapeHtml(copyTitle)}" title="${this._escapeHtml(copyTitle)}" aria-label="${this._escapeHtml(copyTitle)}" role="button"><img src="${this._esc(copyIcon)}" class="copy-img" alt="${this._escapeHtml(copyTitle)}" data-id="${this._esc(id)}"></a>`;return`<div class="msg-box msg-user" id="${msgId}">${nameHeader}<div class="msg">${copyBtn}<p style="margin:0">${content}</p></div></div>`;}
_renderExtras(block){const parts=[];const images=block.images||{};const keysI=Object.keys(images);if(keysI.length){keysI.forEach((k)=>{const it=images[k];if(!it)return;const url=this._esc(it.url);const path=this._esc(it.path);const bn=this._esc(it.basename||'');if(it.is_video){const src=(it.ext==='.webm'||!it.webm_path)?path:this._esc(it.webm_path);const ext=(src.endsWith('.webm')?'webm':(path.split('.').pop()||'mp4'));parts.push(`<div class="extra-src-video-box" title="${url}">`+`<video class="video-player" controls>`+`<source src="${src}" type="video/${ext}">`+`</video>`+`<p><a href="bridge://play_video/${url}" class="title">${this._escapeHtml(bn)}</a></p>`+`</div>`);}else{parts.push(`<div class="extra-src-img-box" title="${url}">`+`<div class="img-outer"><div class="img-wrapper"><a href="${url}"><img src="${path}" class="image"></a></div>`+`<a href="${url}" class="title">${this._escapeHtml(bn)}</a></div>`+`</div><br/>`);}});}
const files=block.files||{};const kF=Object.keys(files);if(kF.length){const rows=[];kF.forEach((k)=>{const it=files[k];if(!it)return;const url=this._esc(it.url);const path=this._esc(it.path);const icon=(typeof window!=='undefined'&&window.ICON_ATTACHMENTS)?`<img src="${window.ICON_ATTACHMENTS}" class="extra-src-icon">`:'';rows.push(`${icon} <b> [${k}] </b> <a href="${url}">${path}</a>`);});if(rows.length)parts.push(`<div>${rows.join("<br/><br/>")}</div>`);}
const urls=block.urls||{};const kU=Object.keys(urls);if(kU.length){const rows=[];kU.forEach((k)=>{const it=urls[k];if(!it)return;const url=this._esc(it.url);const icon=(typeof window!=='undefined'&&window.ICON_URL)?`<img src="${window.ICON_URL}" class="extra-src-icon">`:'';rows.push(`${icon}<a href="${url}" title="${url}">${url}</a> <small> [${k}] </small>`);});if(rows.length)parts.push(`<div>${rows.join("<br/><br/>")}</div>`);}
const extra=block.extra||{};const docsRaw=Array.isArray(extra.docs)?extra.docs:null;if(docsRaw&&docsRaw.length){const icon=(typeof window!=='undefined'&&window.ICON_DB)?`<img src="${window.ICON_DB}" class="extra-src-icon">`:'';const prefix=(typeof window!=='undefined'&&window.LOCALE_DOC_PREFIX)?String(window.LOCALE_DOC_PREFIX):'Doc:';const limit=3;const normalized=[];docsRaw.forEach((it)=>{if(!it||typeof it!=='object')return;if('uuid'in it&&'meta'in it&&typeof it.meta==='object'){normalized.push({uuid:String(it.uuid),meta:it.meta||{}});}else{const keys=Object.keys(it);if(keys.length===1){const uuid=keys[0];const meta=it[uuid];if(meta&&typeof meta==='object'){normalized.push({uuid:String(uuid),meta});}}}});const rows=[];for(let i=0;i<Math.min(limit,normalized.length);i++){const d=normalized[i];const meta=d.meta||{};const entries=Object.keys(meta).map(k=>`<b>${this._escapeHtml(k)}:</b> ${this._escapeHtml(String(meta[k]))}`).join(', ');rows.push(`<p><small>[${i + 1}] ${this._escapeHtml(d.uuid)}: ${entries}</small></p>`);}
if(rows.length){parts.push(`<p>${icon}<small><b>${this._escapeHtml(prefix)}:</b></small></p>`);parts.push(`<div class="cmd"><p>${rows.join('')}</p></div>`);}}else{const docs_html=extra&&extra.docs_html?String(extra.docs_html):'';if(docs_html)parts.push(docs_html);}
const tool_extra_html=extra&&extra.tool_extra_html?String(extra.tool_extra_html):'';if(tool_extra_html)parts.push(`<div class="msg-extra">${tool_extra_html}</div>`);return parts.join('');}
_renderActions(block){const extra=block.extra||{};const actions=extra.actions||[];if(!actions||!actions.length)return'';const parts=actions.map((a)=>{const href=this._esc(a.href||'#');const title=this._esc(a.title||'');const icon=this._esc(a.icon||'');const id=this._esc(a.id||block.id);return`<a href="${href}" class="action-icon" data-id="${id}" role="button"><span class="cmd"><img src="${icon}" class="action-img" title="${title}" alt="${title}" data-id="${id}"></span></a>`;});return`<div class="action-icons" data-id="${this._esc(block.id)}">${parts.join('')}</div>`;}
_renderToolOutputWrapper(block){const extra=block.extra||{};const tool_output_html=(extra.tool_output!=null)?String(extra.tool_output):'';const wrapperDisplay=(extra.tool_output_visible===true)?'':'display:none';const toggleTitle=(typeof trans!=='undefined'&&trans)?trans('action.cmd.expand'):'Expand';const expIcon=(typeof window!=='undefined'&&window.ICON_EXPAND)?window.ICON_EXPAND:'';return(`<div class='tool-output' style='${wrapperDisplay}'>`+`<span class='toggle-cmd-output' onclick='toggleToolOutput(${this._esc(block.id)});' `+`title='${this._escapeHtml(toggleTitle)}' role='button'>`+`<img src='${this._esc(expIcon)}' width='25' height='25' valign='middle'>`+`</span>`+`<div class='content' style='display:none' data-trusted='1'>${tool_output_html}</div>`+`</div>`);}
_renderBot(block){const id=block.id;const out=block.output||{};const msgId=`msg-bot-${id}`;const personalize=!!(block&&block.extra&&block.extra.personalize===true);const nameHeader=personalize?this._nameHeader('bot',out.name||'',out.avatar_img||null):'';const mdText=this._escapeHtml(out.text||'');const toolWrap=this._renderToolOutputWrapper(block);const extras=this._renderExtras(block);const actions=(block.extra&&block.extra.footer_icons)?this._renderActions(block):'';const debug=(block.extra&&block.extra.debug_html)?String(block.extra.debug_html):'';return(`<div class='msg-box msg-bot' id='${msgId}'>`+`${nameHeader}`+`<div class='msg'>`+`<div class='md-block' md-block-markdown='1'>${mdText}</div>`+`<div class='msg-tool-extra'></div>`+`${toolWrap}`+`<div class='msg-extra'>${extras}</div>`+`${actions}${debug}`+`</div>`+`</div>`);}
renderNode(block){const parts=[];if(block&&block.input&&block.input.text)parts.push(this._renderUser(block));if(block&&block.output&&block.output.text)parts.push(this._renderBot(block));return parts.join('');}
renderNodes(blocks){if(!Array.isArray(blocks))return'';const out=[];for(let i=0;i<blocks.length;i++){const b=blocks[i]||null;if(!b)continue;out.push(this.renderNode(b));}
return out.join('');}};

/* data/js/app/tool.js */
class ToolOutput{showLoader(){return;}
hideLoader(){const elements=document.querySelectorAll('.msg-bot');if(elements.length>0)elements.forEach(el=>{const s=el.querySelector('.spinner');if(s)s.style.display='none';});}
begin(){this.showLoader();}
end(){this.hideLoader();}
enable(){const els=document.querySelectorAll('.tool-output');if(els.length)els[els.length-1].style.display='block';}
disable(){const els=document.querySelectorAll('.tool-output');if(els.length)els[els.length-1].style.display='none';}
append(content){this.hideLoader();this.enable();const els=document.querySelectorAll('.tool-output');if(els.length){const contentEl=els[els.length-1].querySelector('.content');if(contentEl)contentEl.insertAdjacentHTML('beforeend',content);}}
update(content){this.hideLoader();this.enable();const els=document.querySelectorAll('.tool-output');if(els.length){const contentEl=els[els.length-1].querySelector('.content');if(contentEl)contentEl.innerHTML=content;}}
clear(){this.hideLoader();this.enable();const els=document.querySelectorAll('.tool-output');if(els.length){const contentEl=els[els.length-1].querySelector('.content');if(contentEl)contentEl.replaceChildren();}}
toggle(id){const el=document.getElementById('msg-bot-'+id);if(!el)return;const outputEl=el.querySelector('.tool-output');if(!outputEl)return;const contentEl=outputEl.querySelector('.content');if(contentEl)contentEl.style.display=(contentEl.style.display==='none')?'block':'none';const toggleEl=outputEl.querySelector('.toggle-cmd-output img');if(toggleEl)toggleEl.classList.toggle('toggle-expanded');}};

/* data/js/app/ui.js */
class UIManager{updateCSS(styles){let style=document.getElementById('app-style');if(!style){style=document.createElement('style');style.id='app-style';document.head.appendChild(style);}
style.textContent=styles;}
ensureStickyHeaderStyle(){let style=document.getElementById('code-sticky-style');if(style)return;style=document.createElement('style');style.id='code-sticky-style';style.textContent=['.code-wrapper { position: relative; }','.code-wrapper .code-header-wrapper { position: sticky; top: var(--code-header-sticky-top, -2px); z-index: 2; box-shadow: 0 1px 0 rgba(0,0,0,.06); }','.code-wrapper pre { overflow: visible; margin-top: 0; }','.code-wrapper pre code { display: block; white-space: pre; max-height: 100dvh; overflow: auto;','  overscroll-behavior: contain; -webkit-overflow-scrolling: touch; overflow-anchor: none; scrollbar-gutter: stable both-edges; scroll-behavior: auto; }','#_loader_.hidden { display: none !important; visibility: hidden !important; }','#_loader_.visible { display: block; visibility: visible; }','.msg-box.msg-user .msg { position: relative; }','.msg-box.msg-user .msg > .uc-content { display: block; overflow: visible; }','.msg-box.msg-user .msg > .uc-content.uc-collapsed { max-height: 1000px; overflow: hidden; }','.msg-box.msg-user .msg > .uc-toggle { display: none; margin-top: 8px; text-align: center; cursor: pointer; user-select: none; }','.msg-box.msg-user .msg > .uc-toggle.visible { display: block; }','.msg-box.msg-user .msg > .uc-toggle img { width: var(--uc-toggle-icon-size, 26px); height: var(--uc-toggle-icon-size, 26px); opacity: .8; }','.msg-box.msg-user .msg > .uc-toggle:hover img { opacity: 1; }','.msg-box.msg-user .msg .msg-copy-btn { position: absolute; top: 2px; right: 0px; z-index: 3;','  opacity: 0; pointer-events: none; transition: opacity .15s ease, transform .15s ease, background-color .15s ease, border-color .15s ease;','  border-radius: 6px; padding: 4px; line-height: 0; border: 1px solid transparent; background: transparent; }','.msg-box.msg-user .msg:hover .msg-copy-btn, .msg-box.msg-user .msg:focus-within .msg-copy-btn { opacity: 1; pointer-events: auto; }','.msg-box.msg-user .msg .msg-copy-btn:hover { transform: scale(1.06); background: var(--copy-btn-bg-hover, rgba(0,0,0,.86)); border-color: var(--copy-btn-border, rgba(0,0,0,.08)); }','.msg-box.msg-user .msg .msg-copy-btn.copied { background: var(--copy-btn-bg-copied, rgba(150,150,150,.12)); border-color: var(--copy-btn-border-copied, rgba(150,150,150,.35)); animation: msg-copy-pop .25s ease; }','.msg-box.msg-user .msg .msg-copy-btn img { display: block; width: 18px; height: 18px; }','.code-wrapper .code-header-action.code-header-copy,','.code-wrapper .code-header-action.code-header-collapse { display: inline-flex; align-items: center; border-radius: 6px; padding: 2px; line-height: 0; border: 1px solid transparent; transition: transform .15s ease, background-color .15s ease, border-color .15s ease; }','.code-wrapper .code-header-action.code-header-copy:hover,','.code-wrapper .code-header-action.code-header-collapse:hover { transform: scale(1.06); background: var(--copy-btn-bg-hover, rgba(0,0,0,.76)); border-color: var(--copy-btn-border, rgba(0,0,0,.08)); }','.code-wrapper .code-header-action.copied { background: var(--copy-btn-bg-copied, rgba(150,150,150,.12)); border-color: var(--copy-btn-border-copied, rgba(150,150,150,.35)); animation: msg-copy-pop .25s ease; }','@keyframes msg-copy-pop { 0%{ transform: scale(1); } 60%{ transform: scale(1.1); } 100%{ transform: scale(1); } }'].join('\n');document.head.appendChild(style);}
enableEditIcons(){document.body&&document.body.classList.add('display-edit-icons');}
disableEditIcons(){document.body&&document.body.classList.remove('display-edit-icons');}
enableTimestamp(){document.body&&document.body.classList.add('display-timestamp');}
disableTimestamp(){document.body&&document.body.classList.remove('display-timestamp');}
enableBlocks(){document.body&&document.body.classList.add('display-blocks');}
disableBlocks(){document.body&&document.body.classList.remove('display-blocks');}};

/* data/js/app/user.js */
class UserCollapseManager{constructor(cfg){this.cfg=cfg||{};this.threshold=Utils.g('USER_MSG_COLLAPSE_HEIGHT_PX',1000);this._processed=new Set();this.ellipsisText=' [...]';}
_icons(){const I=(this.cfg&&this.cfg.ICONS)||{};return{expand:I.EXPAND||'',collapse:I.COLLAPSE||''};}
_labels(){const L=(this.cfg&&this.cfg.LOCALE)||{};return{expand:L.EXPAND||'Expand',collapse:L.COLLAPSE||'Collapse'};}
_afterLayout(fn){try{if(typeof runtime!=='undefined'&&runtime.raf&&typeof runtime.raf.schedule==='function'){const key={t:'UC:afterLayout',i:Math.random()};runtime.raf.schedule(key,()=>{try{fn&&fn();}catch(_){}},'UserCollapse',0);return;}}catch(_){}
try{requestAnimationFrame(()=>{try{fn&&fn();}catch(_){}});}catch(_){setTimeout(()=>{try{fn&&fn();}catch(__){}},0);}}
_scrollToggleIntoView(toggleEl){if(!toggleEl||!toggleEl.isConnected)return;try{if(runtime&&runtime.scrollMgr){runtime.scrollMgr.userInteracted=true;runtime.scrollMgr.autoFollow=false;}}catch(_){}
this._afterLayout(()=>{try{if(toggleEl.scrollIntoView){try{toggleEl.scrollIntoView({block:'nearest',inline:'nearest',behavior:'instant'});}catch(_){toggleEl.scrollIntoView(false);}}}catch(_){}});}
_ensureStructure(msg){if(!msg||!msg.isConnected)return null;let content=msg.querySelector('.uc-content');if(!content){content=document.createElement('div');content.className='uc-content';const frag=document.createDocumentFragment();while(msg.firstChild)frag.appendChild(msg.firstChild);content.appendChild(frag);msg.appendChild(content);}
let toggle=msg.querySelector('.uc-toggle');if(!toggle){const icons=this._icons();const labels=this._labels();toggle=document.createElement('div');toggle.className='uc-toggle';toggle.tabIndex=0;toggle.setAttribute('role','button');toggle.setAttribute('aria-expanded','false');toggle.title=labels.expand;const img=document.createElement('img');img.className='uc-toggle-icon';img.alt=labels.expand;img.src=icons.expand;img.width=26;img.height=26;toggle.appendChild(img);toggle.addEventListener('click',(ev)=>{ev.preventDefault();ev.stopPropagation();this.toggleFromToggle(toggle);});toggle.addEventListener('keydown',(ev)=>{if(ev.key==='Enter'||ev.key===' '){ev.preventDefault();ev.stopPropagation();this.toggleFromToggle(toggle);}},{passive:false});msg.appendChild(toggle);}
this._processed.add(msg);msg.dataset.ucInit='1';return{content,toggle};}
_ensureEllipsisEl(msg,contentEl){const content=contentEl||(msg&&msg.querySelector('.uc-content'));if(!content)return null;if(getComputedStyle(content).position==='static'){content.style.position='relative';}
let dot=content.querySelector('.uc-ellipsis');if(!dot){dot=document.createElement('span');dot.className='uc-ellipsis';dot.textContent=this.ellipsisText;dot.style.position='absolute';dot.style.right='0';dot.style.bottom='0';dot.style.paddingLeft='6px';dot.style.pointerEvents='none';dot.style.zIndex='1';dot.style.fontWeight='500';dot.style.opacity='0.75';dot.setAttribute('aria-hidden','true');dot.setAttribute('data-copy-ignore','1');content.appendChild(dot);}
return dot;}
_showEllipsis(msg,contentEl){const dot=this._ensureEllipsisEl(msg,contentEl);if(dot)dot.style.display='inline';}
_hideEllipsis(msg){const content=msg&&msg.querySelector('.uc-content');if(!content)return;const dot=content.querySelector('.uc-ellipsis');if(dot&&dot.parentNode){dot.parentNode.removeChild(dot);}
try{if(content&&content.style&&content.querySelector('.uc-ellipsis')==null){content.style.position='';}}catch(_){}}
apply(root){const scope=root||document;let list;if(scope.nodeType===1)list=scope.querySelectorAll('.msg-box.msg-user .msg');else list=document.querySelectorAll('.msg-box.msg-user .msg');if(!list||!list.length)return;for(let i=0;i<list.length;i++){const msg=list[i];const st=this._ensureStructure(msg);if(!st)continue;this._update(msg,st.content,st.toggle);}}
_update(msg,contentEl,toggleEl){const c=contentEl||(msg&&msg.querySelector('.uc-content'));if(!msg||!c)return;if(this.threshold===0||this.threshold==='0'){const t=toggleEl||msg.querySelector('.uc-toggle');const labels=this._labels();c.classList.remove('uc-collapsed');c.classList.remove('uc-expanded');msg.dataset.ucState='expanded';this._hideEllipsis(msg);if(t){t.classList.remove('visible');t.setAttribute('aria-expanded','false');t.title=labels.expand;const img=t.querySelector('img');if(img){img.alt=labels.expand;}}
return;}
c.classList.remove('uc-collapsed');c.classList.remove('uc-expanded');const fullHeight=Math.ceil(c.scrollHeight);const labels=this._labels();const icons=this._icons();const t=toggleEl||msg.querySelector('.uc-toggle');if(fullHeight>this.threshold){if(t)t.classList.add('visible');const desired=msg.dataset.ucState||'collapsed';const expand=(desired==='expanded');if(expand){c.classList.add('uc-expanded');this._hideEllipsis(msg);}else{c.classList.add('uc-collapsed');this._showEllipsis(msg,c);}
if(t){const img=t.querySelector('img');if(img){if(expand){img.src=icons.collapse;img.alt=labels.collapse;}else{img.src=icons.expand;img.alt=labels.expand;}}
t.setAttribute('aria-expanded',expand?'true':'false');t.title=expand?labels.collapse:labels.expand;}}else{c.classList.remove('uc-collapsed');c.classList.remove('uc-expanded');msg.dataset.ucState='expanded';this._hideEllipsis(msg);if(t){t.classList.remove('visible');t.setAttribute('aria-expanded','false');t.title=labels.expand;}}}
toggleFromToggle(toggleEl){const msg=toggleEl&&toggleEl.closest?toggleEl.closest('.msg-box.msg-user .msg'):null;if(!msg)return;this.toggle(msg);}
toggle(msg){if(!msg||!msg.isConnected)return;const c=msg.querySelector('.uc-content');if(!c)return;const t=msg.querySelector('.uc-toggle');const labels=this._labels();const icons=this._icons();const isCollapsed=c.classList.contains('uc-collapsed');if(isCollapsed){c.classList.remove('uc-collapsed');c.classList.add('uc-expanded');msg.dataset.ucState='expanded';this._hideEllipsis(msg);if(t){t.setAttribute('aria-expanded','true');t.title=labels.collapse;const img=t.querySelector('img');if(img){img.src=icons.collapse;img.alt=labels.collapse;}}}else{c.classList.remove('uc-expanded');c.classList.add('uc-collapsed');msg.dataset.ucState='collapsed';this._showEllipsis(msg,c);if(t){t.setAttribute('aria-expanded','false');t.title=labels.expand;const img=t.querySelector('img');if(img){img.src=icons.expand;img.alt=labels.expand;}
this._scrollToggleIntoView(t);}}}
remeasureAll(){const arr=Array.from(this._processed||[]);for(let i=0;i<arr.length;i++){const msg=arr[i];if(!msg||!msg.isConnected){this._processed.delete(msg);continue;}
this._update(msg);}}};

/* data/js/app/utils.js */
class Utils{static g(name,dflt){return(typeof window[name]!=='undefined')?window[name]:dflt;}
static now(){return(typeof performance!=='undefined'&&performance.now)?performance.now():Date.now();}
static escapeHtml(s){const d=Utils._escDiv||(Utils._escDiv=document.createElement('div'));d.textContent=String(s??'');return d.innerHTML;}
static countNewlines(s){if(!s)return 0;let c=0,i=-1;while((i=s.indexOf('\n',i+1))!==-1)c++;return c;}
static reEscape(s){return String(s).replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}
static idle(fn,timeout){if('requestIdleCallback'in window)return requestIdleCallback(fn,{timeout:timeout||800});return setTimeout(fn,50);}
static cancelIdle(id){try{if('cancelIdleCallback'in window)cancelIdleCallback(id);else clearTimeout(id);}catch(_){}}
static get SE(){return document.scrollingElement||document.documentElement;}
static utf8Decode(bytes){if(!Utils._td)Utils._td=new TextDecoder('utf-8');return Utils._td.decode(bytes);}};

/* data/js/app/runtime.js */
class Runtime{constructor(){this.cfg=new Config();this.logger=new Logger(this.cfg);this.dom=new DOMRefs();this.customMarkup=new CustomMarkup(this.cfg,this.logger);this.raf=new RafManager(this.cfg);try{this.logger.bindRaf(this.raf);}catch(_){}
this.async=new AsyncRunner(this.cfg,this.raf);this.renderer=new MarkdownRenderer(this.cfg,this.customMarkup,this.logger,this.async,this.raf);this.math=new MathRenderer(this.cfg,this.raf,this.async);this.codeScroll=new CodeScrollState(this.cfg,this.raf);this.highlighter=new Highlighter(this.cfg,this.codeScroll,this.raf);this.scrollMgr=new ScrollManager(this.cfg,this.dom,this.raf);this.toolOutput=new ToolOutput();this.loading=new Loading(this.dom);this.nodes=new NodesManager(this.dom,this.renderer,this.highlighter,this.math);this.bridge=new BridgeManager(this.cfg,this.logger);this.ui=new UIManager();this.stream=new StreamEngine(this.cfg,this.dom,this.renderer,this.math,this.highlighter,this.codeScroll,this.scrollMgr,this.raf,this.async,this.logger);this.streamQ=new StreamQueue(this.cfg,this.stream,this.scrollMgr,this.raf);this.events=new EventManager(this.cfg,this.dom,this.scrollMgr,this.highlighter,this.codeScroll,this.toolOutput,this.bridge);try{this.stream.setCustomFenceSpecs(this.customMarkup.getSourceFenceSpecs());}catch(_){}
this.templates=new NodeTemplateEngine(this.cfg,this.logger);this.data=new DataReceiver(this.cfg,this.templates,this.nodes,this.scrollMgr);this.tips=null;this._lastHeavyResetMs=0;this.renderer.hooks.observeNewCode=(root,opts)=>this.highlighter.observeNewCode(root,opts,this.stream.activeCode);this.renderer.hooks.observeMsgBoxes=(root)=>this.highlighter.observeMsgBoxes(root,(box)=>{this.highlighter.observeNewCode(box,{deferLastIfStreaming:true,minLinesForLast:this.cfg.PROFILE_CODE.minLinesForHL,minCharsForLast:this.cfg.PROFILE_CODE.minCharsForHL},this.stream.activeCode);this.codeScroll.initScrollableBlocks(box);});this.renderer.hooks.scheduleMathRender=(root)=>{const mm=getMathMode();if(mm==='idle')this.math.schedule(root);else if(mm==='always')this.math.schedule(root,0,true);};this.renderer.hooks.codeScrollInit=(root)=>this.codeScroll.initScrollableBlocks(root);}
resetStreamState(origin,opts){try{this.streamQ.clear();}catch(_){}
const def=Object.assign({finalizeActive:true,clearBuffer:true,clearMsg:false,defuseOrphans:true,forceHeavy:false,reason:String(origin||'external-op')},(opts||{}));const now=Utils.now();const withinDebounce=(now-(this._lastHeavyResetMs||0))<=(this.cfg.RESET.HEAVY_DEBOUNCE_MS||24);const mustHeavyByOrigin=def.forceHeavy===true||def.clearMsg===true||origin==='beginStream'||origin==='nextStream'||origin==='clearStream'||origin==='replaceNodes'||origin==='clearNodes'||origin==='clearOutput'||origin==='clearLive'||origin==='clearInput';const shouldHeavy=mustHeavyByOrigin||!withinDebounce;const suppressLog=withinDebounce&&origin!=='beginStream';try{this.stream.abortAndReset({...def,suppressLog});}catch(_){}
if(shouldHeavy){try{this.highlighter.cleanup();}catch(_){}
try{this.math.cleanup();}catch(_){}
try{this.codeScroll.cancelAllScrolls();}catch(_){}
try{this.scrollMgr.cancelPendingScroll();}catch(_){}
try{this.raf.cancelAll();}catch(_){}
this._lastHeavyResetMs=now;}else{try{this.raf.cancelGroup('StreamQueue');}catch(_){}}
try{this.tips&&this.tips.hide();}catch(_){}}
api_onChunk=(name,chunk,type)=>{const t=String(type||'text_delta');if(t==='text_delta'){this.api_appendStream(name,chunk);return;}
this.logger.debug('STREAM','IGNORED_NON_TEXT_CHUNK',{type:t,len:(chunk?String(chunk).length:0)});};api_beginStream=(chunk=false)=>{this.tips&&this.tips.hide();this.resetStreamState('beginStream',{clearMsg:true,finalizeActive:false,forceHeavy:true});this.stream.beginStream(chunk);};api_endStream=()=>{this.stream.endStream();};api_applyStream=(name,chunk)=>{this.stream.applyStream(name,chunk);};api_appendStream=(name,chunk)=>{this.streamQ.enqueue(name,chunk);};api_nextStream=()=>{this.tips&&this.tips.hide();const element=this.dom.get('_append_output_');const before=this.dom.get('_append_output_before_');if(element&&before){const frag=document.createDocumentFragment();while(element.firstChild)frag.appendChild(element.firstChild);before.appendChild(frag);}
this.resetStreamState('nextStream',{clearMsg:true,finalizeActive:false,forceHeavy:true});this.scrollMgr.scheduleScroll();};api_clearStream=()=>{this.tips&&this.tips.hide();this.resetStreamState('clearStream',{clearMsg:true,forceHeavy:true});const el=this.dom.getStreamContainer();if(!el)return;el.replaceChildren();};api_appendNode=(payload)=>{this.resetStreamState('appendNode');this.data.append(payload);};api_replaceNodes=(payload)=>{this.resetStreamState('replaceNodes',{clearMsg:true,forceHeavy:true});this.dom.clearNodes();this.data.replace(payload);};api_appendToInput=(payload)=>{this.nodes.appendToInput(payload);this.scrollMgr.autoFollow=true;this.scrollMgr.userInteracted=false;try{this.scrollMgr.lastScrollTop=Utils.SE.scrollTop|0;}catch(_){}
this.scrollMgr.scheduleScroll();};api_clearNodes=()=>{this.dom.clearNodes();this.resetStreamState('clearNodes',{clearMsg:true,forceHeavy:true});};api_clearInput=()=>{this.resetStreamState('clearInput',{forceHeavy:true});this.dom.clearInput();};api_clearOutput=()=>{this.dom.clearOutput();this.resetStreamState('clearOutput',{clearMsg:true,forceHeavy:true});};api_clearLive=()=>{this.dom.clearLive();this.resetStreamState('clearLive',{forceHeavy:true});};api_appendToolOutput=(c)=>this.toolOutput.append(c);api_updateToolOutput=(c)=>this.toolOutput.update(c);api_clearToolOutput=()=>this.toolOutput.clear();api_beginToolOutput=()=>this.toolOutput.begin();api_endToolOutput=()=>this.toolOutput.end();api_enableToolOutput=()=>this.toolOutput.enable();api_disableToolOutput=()=>this.toolOutput.disable();api_toggleToolOutput=(id)=>this.toolOutput.toggle(id);api_appendExtra=(id,c)=>this.nodes.appendExtra(id,c,this.scrollMgr);api_removeNode=(id)=>this.nodes.removeNode(id,this.scrollMgr);api_removeNodesFromId=(id)=>this.nodes.removeNodesFromId(id,this.scrollMgr);api_replaceLive=(content)=>{const el=this.dom.get('_append_live_');if(!el)return;if(el.classList.contains('hidden')){el.classList.remove('hidden');el.classList.add('visible');}
el.innerHTML=content;try{const maybePromise=this.renderer.renderPendingMarkdown(el);const post=()=>{try{this.highlighter.observeNewCode(el,{deferLastIfStreaming:true,minLinesForLast:this.cfg.PROFILE_CODE.minLinesForHL,minCharsForLast:this.cfg.PROFILE_CODE.minCharsForHL},this.stream.activeCode);this.highlighter.observeMsgBoxes(el,(box)=>{this.highlighter.observeNewCode(box,{deferLastIfStreaming:true,minLinesForLast:this.cfg.PROFILE_CODE.minLinesForHL,minCharsForLast:this.cfg.PROFILE_CODE.minCharsForHL},this.stream.activeCode);this.codeScroll.initScrollableBlocks(box);});}catch(_){}
try{const mm=getMathMode();if(mm==='finalize-only')this.math.schedule(el,0,true);else this.math.schedule(el);}catch(_){}
this.scrollMgr.scheduleScroll();};if(maybePromise&&typeof maybePromise.then==='function'){maybePromise.then(post);}else{post();}}catch(_){this.scrollMgr.scheduleScroll();}};api_updateFooter=(html)=>{const el=this.dom.get('_footer_');if(el)el.innerHTML=html;};api_enableEditIcons=()=>this.ui.enableEditIcons();api_disableEditIcons=()=>this.ui.disableEditIcons();api_enableTimestamp=()=>this.ui.enableTimestamp();api_disableTimestamp=()=>this.ui.disableTimestamp();api_enableBlocks=()=>this.ui.enableBlocks();api_disableBlocks=()=>this.ui.disableBlocks();api_updateCSS=(styles)=>this.ui.updateCSS(styles);api_getScrollPosition=()=>{this.bridge.updateScrollPosition(window.scrollY);};api_setScrollPosition=(pos)=>{try{window.scrollTo(0,pos);this.scrollMgr.prevScroll=parseInt(pos);}catch(_){}};api_showLoading=()=>this.loading.show();api_hideLoading=()=>this.loading.hide();api_restoreCollapsedCode=(root)=>this.renderer.restoreCollapsedCode(root);api_scrollToTopUser=()=>this.scrollMgr.scrollToTopUser();api_scrollToBottomUser=()=>this.scrollMgr.scrollToBottomUser();api_showTips=()=>this.tips.show();api_hideTips=()=>this.tips.hide();api_getCustomMarkupRules=()=>this.customMarkup.getRules();api_setCustomMarkupRules=(rules)=>{this.customMarkup.setRules(rules);try{this.stream.setCustomFenceSpecs(this.customMarkup.getSourceFenceSpecs());}catch(_){}};init(){this.highlighter.initHLJS();this.dom.init();this.ui.ensureStickyHeaderStyle();this.tips=new TipsManager(this.dom);this.events.install();this.bridge.initQWebChannel(this.cfg.PID,(bridge)=>{const onChunk=(name,chunk,type)=>this.api_onChunk(name,chunk,type);const onNode=(payload)=>this.api_appendNode(payload);const onNodeReplace=(payload)=>this.api_replaceNodes(payload);const onNodeInput=(html)=>this.api_appendToInput(html);this.bridge.connect(onChunk,onNode,onNodeReplace,onNodeInput);try{this.logger.bindBridge(this.bridge.bridge||this.bridge);}catch(_){}});this.renderer.init();try{this.renderer.renderPendingMarkdown(document);}catch(_){}
this.highlighter.observeMsgBoxes(document,(box)=>{this.highlighter.observeNewCode(box,{deferLastIfStreaming:true,minLinesForLast:this.cfg.PROFILE_CODE.minLinesForHL,minCharsForLast:this.cfg.PROFILE_CODE.minCharsForHL},this.stream.activeCode);this.codeScroll.initScrollableBlocks(box);});this.highlighter.observeNewCode(document,{deferLastIfStreaming:true,minLinesForLast:this.cfg.PROFILE_CODE.minLinesForHL,minCharsForLast:this.cfg.PROFILE_CODE.minCharsForHL},this.stream.activeCode);this.highlighter.scheduleScanVisibleCodes(this.stream.activeCode);this.tips.cycle();this.scrollMgr.updateScrollFab(true);}
cleanup(){this.tips.cleanup();try{this.bridge.disconnect();}catch(_){}
this.events.cleanup();this.highlighter.cleanup();this.math.cleanup();this.streamQ.clear();this.dom.cleanup();}}
if(typeof RafManager!=='undefined'&&RafManager.prototype&&typeof RafManager.prototype.cancel==='function'){RafManager.prototype.cancel=function(key){const t=this.tasks.get(key);if(!t)return;this.tasks.delete(key);if(t.group){const set=this.groups.get(t.group);if(set){set.delete(key);if(set.size===0)this.groups.delete(t.group);}}};}
window.__collapsed_idx=window.__collapsed_idx||[];const runtime=new Runtime();document.addEventListener('DOMContentLoaded',()=>runtime.init());Object.defineProperty(window,'SE',{get(){return Utils.SE;}});window.beginStream=(chunk)=>runtime.api_beginStream(chunk);window.endStream=()=>runtime.api_endStream();window.applyStream=(name,chunk)=>runtime.api_applyStream(name,chunk);window.appendStream=(name,chunk)=>runtime.api_appendStream(name,chunk);window.appendStreamTyped=(type,name,chunk)=>runtime.api_onChunk(name,chunk,type);window.nextStream=()=>runtime.api_nextStream();window.clearStream=()=>runtime.api_clearStream();window.appendNode=(payload)=>runtime.api_appendNode(payload);window.replaceNodes=(payload)=>runtime.api_replaceNodes(payload);window.appendToInput=(html)=>runtime.api_appendToInput(html);window.clearNodes=()=>runtime.api_clearNodes();window.clearInput=()=>runtime.api_clearInput();window.clearOutput=()=>runtime.api_clearOutput();window.clearLive=()=>runtime.api_clearLive();window.appendToolOutput=(c)=>runtime.api_appendToolOutput(c);window.updateToolOutput=(c)=>runtime.api_updateToolOutput(c);window.clearToolOutput=()=>runtime.api_clearToolOutput();window.beginToolOutput=()=>runtime.api_beginToolOutput();window.endToolOutput=()=>runtime.api_endToolOutput();window.enableToolOutput=()=>runtime.api_enableToolOutput();window.disableToolOutput=()=>runtime.api_disableToolOutput();window.toggleToolOutput=(id)=>runtime.api_toggleToolOutput(id);window.appendExtra=(id,c)=>runtime.api_appendExtra(id,c);window.removeNode=(id)=>runtime.api_removeNode(id);window.removeNodesFromId=(id)=>runtime.api_removeNodesFromId(id);window.replaceLive=(c)=>runtime.api_replaceLive(c);window.updateFooter=(c)=>runtime.api_updateFooter(c);window.enableEditIcons=()=>runtime.api_enableEditIcons();window.disableEditIcons=()=>runtime.api_disableEditIcons();window.enableTimestamp=()=>runtime.api_enableTimestamp();window.disableTimestamp=()=>runtime.api_disableTimestamp();window.enableBlocks=()=>runtime.api_enableBlocks();window.disableBlocks=()=>runtime.api_disableBlocks();window.updateCSS=(s)=>runtime.api_updateCSS(s);window.getScrollPosition=()=>runtime.api_getScrollPosition();window.setScrollPosition=(pos)=>runtime.api_setScrollPosition(pos);window.showLoading=()=>runtime.api_showLoading();window.hideLoading=()=>runtime.api_hideLoading();window.restoreCollapsedCode=(root)=>runtime.api_restoreCollapsedCode(root);window.scrollToTopUser=()=>runtime.api_scrollToTopUser();window.scrollToBottomUser=()=>runtime.api_scrollToBottomUser();window.showTips=()=>runtime.api_showTips();window.hideTips=()=>runtime.api_hideTips();window.getCustomMarkupRules=()=>runtime.api_getCustomMarkupRules();window.setCustomMarkupRules=(rules)=>runtime.api_setCustomMarkupRules(rules);window.__pygpt_cleanup=()=>runtime.cleanup();RafManager.prototype.stats=function(){const byGroup=new Map();for(const[key,t]of this.tasks){const g=t.group||'default';byGroup.set(g,(byGroup.get(g)||0)+1);}
return{tasks:this.tasks.size,groups:Array.from(byGroup,([group,count])=>({group,count})).sort((a,b)=>b.count-a.count)};};RafManager.prototype.dumpHotGroups=function(label=''){const s=this.stats();console.log('[RAF]',label,'tasks=',s.tasks,'byGroup=',s.groups.slice(0,8));};RafManager.prototype.findDomTasks=function(){const out=[];for(const[key,t]of this.tasks){let el=null;if(key&&key.nodeType===1)el=key;else if(key&&key.el&&key.el.nodeType===1)el=key.el;if(el)out.push({group:t.group,tag:el.tagName,connected:el.isConnected});}
return out;};function gaugeSE(se){const ropeLen=(se.streamBuf.length+se._sbLen);const ac=se.activeCode;const domFrozen=ac?.frozenEl?.textContent?.length||0;const domTail=ac?.tailEl?.textContent?.length||0;const domLen=domFrozen+domTail;return{ropeLen,domLen,totalChars:ropeLen+domLen,ratioRopeToDom:(domLen?(ropeLen/domLen).toFixed(2):'n/a'),fenceOpen:se.fenceOpen,codeOpen:se.codeStream?.open};};
